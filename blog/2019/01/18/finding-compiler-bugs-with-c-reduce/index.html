<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link href=/css/fonts.css rel=stylesheet type=text/css><title>Finding Compiler Bugs With C-Reduce</title><link rel=stylesheet href=/css/hugo-octopress.css><link rel=stylesheet href=https://nickdesaulniers.github.io/css/custom.css><link rel=stylesheet href=/css/fork-awesome.min.css><link href=https://nickdesaulniers.github.io/favicon.ico rel=icon><meta name=description content><meta name=keywords content><meta name=author content="Nick Desaulniers"><meta name=generator content="Hugo 0.109.0"></head><body><header role=banner><hgroup><h1><a href=https://nickdesaulniers.github.io/>Nick Desaulniers</a></h1><h2>The enemy's gate is down</h2></hgroup></header><nav role=navigation><fieldset class=mobile-nav><select onchange="location=this.value"><option value>Navigate…</option><option value=https://nickdesaulniers.github.io/about/>» About</option><option value=https://nickdesaulniers.github.io/blog/archives/>» Archives</option><option value=https://nickdesaulniers.github.io/>» Blog</option><option value=https://nickdesaulniers.github.io/publications/>» Publications</option><option value=https://nickdesaulniers.github.io/talks/>» Talks</option></select></fieldset><ul class=main-navigation><li><a href=https://nickdesaulniers.github.io/about/ title=About rel="noopener noreferrer">About</a></li><li><a href=https://nickdesaulniers.github.io/blog/archives/ title=Archives rel="noopener noreferrer">Archives</a></li><li><a href=https://nickdesaulniers.github.io/ title=Blog>Blog</a></li><li><a href=https://nickdesaulniers.github.io/publications/ title=Publications rel="noopener noreferrer">Publications</a></li><li><a href=https://nickdesaulniers.github.io/talks/ title=Talks rel="noopener noreferrer">Talks</a></li></ul><ul class=subscription><a href=https://nickdesaulniers.github.io/index.xml target=_blank type=application/rss+xml title=RSS rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a></ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer"><fieldset role=search><input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:https://nickdesaulniers.github.io/></fieldset></form></nav><div id=main><div id=content><div><article class=hentry role=article><header><p class=meta>Jan 18, 2019
- 5 minute read
- <a href=https://nickdesaulniers.github.io/blog/2019/01/18/finding-compiler-bugs-with-c-reduce/#disqus_thread>Comments</a>
- <a class=label href=https://nickdesaulniers.github.io/categories/c/>C </a><a class=label href=https://nickdesaulniers.github.io/categories/c++/>C++ </a><a class=label href=https://nickdesaulniers.github.io/categories/debugging/>debugging </a><a class=label href=https://nickdesaulniers.github.io/categories/c-reduce/>c-reduce </a><a class=label href=https://nickdesaulniers.github.io/categories/linux/>linux </a><a class=label href=https://nickdesaulniers.github.io/categories/llvm/>llvm</a></p><h1 class=entry-title>Finding Compiler Bugs With C-Reduce</h1></header><div class=entry-content><p>Support for a long awaited GNU C extension,
<a href=https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html target=_blank rel=noopener>asm goto</a>,
is in the midst of landing in
<a href=https://reviews.llvm.org/D56571 target=_blank rel=noopener>Clang</a> and
<a href=https://reviews.llvm.org/D53765 target=_blank rel=noopener>LLVM</a>. We want to make sure that
we release a high quality implementation, so it&rsquo;s important to test the new
patches on real code and not just small test cases. When we hit compiler bugs
in large source files, it can be tricky to find exactly what part of
potentially large translation units are problematic. In this post, we&rsquo;ll take
a look at using
<a href=https://embed.cs.utah.edu/creduce/ target=_blank rel=noopener>C-Reduce</a>,
a multithreaded code bisection utility for C/C++, to help narrow done a
reproducer for
<a href=https://github.com/ClangBuiltLinux/linux/issues/320 target=_blank rel=noopener>a real compiler bug</a>
(potentially; in a patch that was posted, and will be fixed before it can ship
in production) from a real code base (the Linux kernel). It&rsquo;s mostly a post to
myself in the future, so that I can remind myself how to run C-reduce on the
Linux kernel again, since this is now the third real compiler bug it&rsquo;s helped
me track down.</p><p>So the bug I&rsquo;m focusing on when trying to compile the Linux kernel with Clang
is a linkage error, all the way at the end of the build.</p><pre tabindex=0><code>drivers/spi/spidev.o:(__jump_table+0x74): undefined reference to `.Ltmp4&#39;
</code></pre><p>Hmm&mldr;looks like the object file (<code>drivers/spi/spidev.o</code>), has a
section (<code>__jump_table</code>), that references a non-existent
symbol (<code>.Ltmp</code>), which looks like a temporary label that should have been
cleaned up by the compiler. Maybe it was accidentally left behind by an
optimization pass?</p><p>To run C-reduce, we need a shell script that returns 0 when it should keep
reducing, and an input file. For an input file, it&rsquo;s just way simpler to
preprocess it; this helps cut down on the compiler flags that typically
requires paths (<code>-I</code>, <code>-L</code>).</p><h2 id=preprocess>Preprocess</h2><p>First, let&rsquo;s preprocess the source. For the kernel, if the file compiles
correctly, the kernel&rsquo;s KBuild build process will create a file named in the
form path/to/.file.o.cmd, in our case drivers/spi/.spidev.o.cmd. (If the file
doesn&rsquo;t compile, then
<a href=https://nickdesaulniers.github.io/blog/2017/05/31/running-clang-tidy-on-the-linux-kernel/ target=_blank rel=noopener>I&rsquo;ve had success</a>
hooking <code>make path/to/file.o</code> with
<a href=https://github.com/rizsotto/Bear target=_blank rel=noopener>bear</a>
then getting the <code>compile_commands.json</code> for the file.) I find it easiest to
copy this file to a new shell script, then strip out everything but the first
line. I then replace the <code>-c -o &lt;output>.o</code> with <code>-E</code>. <code>chmod +x</code> that new
shell script, then run it (outputting to stdout) to eyeball that it looks
preprocessed, then redirect the output to a <code>.i</code> file. Now that we have our
preprocessed input, let&rsquo;s create the C-reduce shell script.</p><h2 id=reproducer>Reproducer</h2><p>I find it helpful to have a shell script in the form:</p><ol><li>remove previous object files</li><li>rebuild object files</li><li>disassemble object files and pipe to grep</li></ol><p>For you, it might be some different steps.
<a href=https://embed.cs.utah.edu/creduce/using/ target=_blank rel=noopener>As the docs show</a>,
you just need the shell script to return 0 when it should keep reducing. From
our previous shell script that pre-processed the source and dumped a <code>.i</code> file,
let&rsquo;s change it back to stop before linking rather that preprocessing
(<code>s/-E/-c/</code>), and change the input to our new <code>.i</code> file. Finally, let&rsquo;s add
the test for what we want. Since I want C-Reduce to keep reducing until the
disassmbled object file no longer references anything <code>Ltmp</code> related, I write:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ objdump -Dr -j __jump_table spidev.o | grep Ltmp &gt; /dev/null
</span></span></code></pre></div><p>Now I can run the reproducer to check that it at least returns 0, which
C-Reduce needs to get started:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ ./spidev_asm_goto.sh
</span></span><span style=display:flex><span>$ <span style=color:#b58900>echo</span> <span style=color:#268bd2>$?</span>
</span></span><span style=display:flex><span><span style=color:#2aa198>0</span>
</span></span></code></pre></div><h2 id=running-c-reduce>Running C-Reduce</h2><p>Now that we have a reproducer script and input file, let&rsquo;s run C-Reduce.</p><pre tabindex=0><code>$ time creduce --n 40 spidev_asm_goto.sh spidev.i
===&lt; 144926 &gt;===
running 40 interestingness tests in parallel
===&lt; pass_includes :: 0 &gt;===
===&lt; pass_unifdef :: 0 &gt;===
===&lt; pass_comments :: 0 &gt;===
===&lt; pass_blank :: 0 &gt;===
(0.7 %, 2393679 bytes)
(5.3 %, 2282207 bytes)
===&lt; pass_clang_binsrch :: replace-function-def-with-decl &gt;===
(12.6 %, 2107372 bytes)
...
===&lt; pass_indent :: final &gt;===
(100.0 %, 156 bytes)
===================== done ====================

pass statistics:
  method pass_clang_binsrch :: remove-unused-function worked 1 times and failed 0 times
...
  method pass_lines :: 0 worked 427 times and failed 998 times
            ******** /android0/kernel-all/spidev.i ********

a() {
  int b;
  c();
  if (c &lt; 2)
    b = d();
  else {
    asm goto(&#34;1:.long b - ., %l[l_yes] - . \n\t&#34; : : : : l_yes);
  l_yes:;
  }
  if (b)
    e();
}
creduce --n 40 spidev_asm_goto.sh spidev.i  1892.35s user 1186.10s system 817% cpu 6:16.76 total
$ wc -l spidev.i.orig
56160 spidev.i.orig
$ wc -l spidev.i
12 spidev.i
</code></pre><p>So it took C-reduce just over 6 minutes to turn >56k lines of mostly irrelevant
code into 12 when running 40 threads on my 48 core workstation.</p><p>It&rsquo;s also highly entertaining to watch C-Reduce work its magic. In another
terminal, I highly recommend running <code>watch -n1 cat &lt;input_file_to_creduce.i></code>
to see it pared down before your eyes.</p><p>Jump to 4:24 to see where things really pick up.
<a href=https://asciinema.org/a/XtD0QdiIUGhvc1G2BqTJ9gti2 target=_blank rel=noopener><img src=https://asciinema.org/a/XtD0QdiIUGhvc1G2BqTJ9gti2.svg alt=asciicast></a>
<a href=https://asciinema.org/a/zdkbvUqDsilSa5QjGJr3ANP6y target=_blank rel=noopener><img src=https://asciinema.org/a/zdkbvUqDsilSa5QjGJr3ANP6y.svg alt=asciicast></a></p><p>Finally, we still want to bisect our compiler flags (the kernel uses a lot). I
still do this process manually, and it&rsquo;s not too bad. Having proper and
minimal steps to reproduce compiler bugs is critical.</p><p>That&rsquo;s enough for a great bug report for now. In a future episode, we&rsquo;ll see
how to start pulling apart llvm to see where compilation is going amiss.</p></div><footer><p class=meta><span class="byline author vcard">Posted by <span class=fn>Nick Desaulniers</span></span>
<time>Jan 18, 2019</time></span></p><p class=meta><a class="basic-alignment left" href=https://nickdesaulniers.github.io/blog/2018/10/24/booting-a-custom-linux-kernel-in-qemu-and-debugging-it-with-gdb/ title="Booting a Custom Linux Kernel in QEMU and Debugging It With GDB">Booting a Custom Linux Kernel in QEMU and Debugging It With GDB</a>
<a class="basic-alignment right" href=https://nickdesaulniers.github.io/blog/2019/05/12/f-vs-f-void-in-c-vs-c-plus-plus/ title="f() vs f(void) in C vs C++">f() vs f(void) in C vs C++</a></p><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//wangstabill.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></div><aside class="sidebar thirds"><section class="first odd"><p></p></section><ul class=sidebar-nav><li class=sidebar-nav-item><a target=_blank rel="noopener noreferrer" href=https://github.com/nickdesaulniers title=https://github.com/nickdesaulniers><i class="fa fa-github fa-3x"></i></a>
<a target=_blank rel="me noopener noreferrer" href=https://fosstodon.org/@llvm title=https://fosstodon.org/@llvm><i class="fa fa-mastodon fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/in/nick-desaulniers-75520334 title=https://www.linkedin.com/in/nick-desaulniers-75520334><i class="fa fa-linkedin fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.youtube.com/channel/UC68vgKSuS1Xjg9wpdvShfSQ title=https://www.youtube.com/channel/UC68vgKSuS1Xjg9wpdvShfSQ><i class="fa fa-youtube fa-3x"></i></a></li></ul><section class=even><h1>Recent Posts</h1><ul id=recent_posts><li class=post><a href=/blog/2023/01/20/debugging-wframe-larger-than/>Debugging -Wframe-larger-than=</a></li><li class=post><a href=/blog/2020/04/06/off-by-two/>Off by Two</a></li><li class=post><a href=/blog/2019/05/12/f-vs-f-void-in-c-vs-c-plus-plus/>f() vs f(void) in C vs C++</a></li><li class=post><a href=/blog/2019/01/18/finding-compiler-bugs-with-c-reduce/>Finding Compiler Bugs With C-Reduce</a></li></ul></section></aside></div></div><footer role=contentinfo><p>Copyright &copy; 2023 Nick Desaulniers - <a href=https://nickdesaulniers.github.io/license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.</p></footer><script>var _gaq=[["_setAccount","UA-36993986-1"],["_trackPageview"]];(function(e,t){var n=e.createElement(t),s=e.getElementsByTagName(t)[0];n.src=("https:"==location.protocol?"//ssl":"//www")+".google-analytics.com/ga.js",s.parentNode.insertBefore(n,s)})(document,"script")</script></body></html>
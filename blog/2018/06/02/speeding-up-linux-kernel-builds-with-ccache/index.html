<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link href=/css/fonts.css rel=stylesheet type=text/css><title>Speeding Up Linux Kernel Builds With ccache</title><link rel=stylesheet href=/css/hugo-octopress.css><link rel=stylesheet href=https://nickdesaulniers.github.io/css/custom.css><link rel=stylesheet href=/css/fork-awesome.min.css><link href=https://nickdesaulniers.github.io/favicon.ico rel=icon><meta name=description content><meta name=keywords content><meta name=author content="Nick Desaulniers"><meta name=generator content="Hugo 0.109.0"></head><body><header role=banner><hgroup><h1><a href=https://nickdesaulniers.github.io/>Nick Desaulniers</a></h1><h2>The enemy's gate is down</h2></hgroup></header><nav role=navigation><fieldset class=mobile-nav><select onchange="location=this.value"><option value>Navigate…</option><option value=https://nickdesaulniers.github.io/about/>» About</option><option value=https://nickdesaulniers.github.io/blog/archives/>» Archives</option><option value=https://nickdesaulniers.github.io/>» Blog</option><option value=https://nickdesaulniers.github.io/publications/>» Publications</option><option value=https://nickdesaulniers.github.io/talks/>» Talks</option></select></fieldset><ul class=main-navigation><li><a href=https://nickdesaulniers.github.io/about/ title=About rel="noopener noreferrer">About</a></li><li><a href=https://nickdesaulniers.github.io/blog/archives/ title=Archives rel="noopener noreferrer">Archives</a></li><li><a href=https://nickdesaulniers.github.io/ title=Blog>Blog</a></li><li><a href=https://nickdesaulniers.github.io/publications/ title=Publications rel="noopener noreferrer">Publications</a></li><li><a href=https://nickdesaulniers.github.io/talks/ title=Talks rel="noopener noreferrer">Talks</a></li></ul><ul class=subscription><a href=https://nickdesaulniers.github.io/index.xml target=_blank type=application/rss+xml title=RSS rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a></ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer"><fieldset role=search><input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:https://nickdesaulniers.github.io/></fieldset></form></nav><div id=main><div id=content><div><article class=hentry role=article><header><p class=meta>Jun 2, 2018
- 3 minute read
- <a href=https://nickdesaulniers.github.io/blog/2018/06/02/speeding-up-linux-kernel-builds-with-ccache/#disqus_thread>Comments</a>
- <a class=label href=https://nickdesaulniers.github.io/categories/c/>C </a><a class=label href=https://nickdesaulniers.github.io/categories/linux/>linux </a><a class=label href=https://nickdesaulniers.github.io/categories/ccache/>ccache</a></p><h1 class=entry-title>Speeding Up Linux Kernel Builds With ccache</h1></header><div class=entry-content><p><a href=https://ccache.samba.org/ target=_blank rel=noopener>ccache</a>, the compiler cache, is a fantastic way to
speed up build times for C and C++ code that
<a href=https://nickdesaulniers.github.io/blog/2015/07/23/additional-c-slash-c-plus-plus-tooling/ target=_blank rel=noopener>I previously recommended</a>.
Recently, I was playing around with trying to get it to speed up my Linux
kernel builds, but wasn&rsquo;t seeing any benefit. Usually when this happens with
ccache, there&rsquo;s something non-deterministic about the builds that prevents
cache hits.</p><p>Turns out
<a href=https://lists.samba.org/archive/ccache/2014q1/001172.html target=_blank rel=noopener>someone asked this exact question on the ccache mailing list back in 2014</a>,
and a teammate from my Android days supposed a timestamp was the culprit. That,
and
<a href=https://lwn.net/Articles/437864/ target=_blank rel=noopener>this LKML post from the KBUILD maintainer in 2011 about determinism</a>
helped me find
<a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=87c94bfb8ad354fb43d2caf870d7ca0b3f98dab3" target=_blank rel=noopener>commit 87c94bfb8ad35 (&ldquo;kbuild: override build timestamp & version&rdquo;)</a> that introduced manually overriding part of the version string that
contains the build timestamp that can be seen from:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ cat /proc/version
</span></span><span style=display:flex><span>Linux version 4.15.0-13-generic <span style=color:#719e07>(</span>buildd@lgw01-amd64-028<span style=color:#719e07>)</span>
</span></span><span style=display:flex><span><span style=color:#719e07>(</span>gcc version 5.4.0 <span style=color:#2aa198>20160609</span> <span style=color:#719e07>(</span>Ubuntu 5.4.0-6ubuntu1~16.04.9<span style=color:#719e07>))</span>
</span></span><span style=display:flex><span><span style=color:#586e75>#14~16.04.1-Ubuntu SMP</span>
</span></span><span style=display:flex><span>Sat Mar <span style=color:#2aa198>17</span> 03:04:59 UTC <span style=color:#2aa198>2018</span>
</span></span></code></pre></div><p>With ccache, we can check the cache hit/miss stats with <code>-s</code>, clear the cache
with <code>-C</code>, and clear the stats with <code>-z</code>. We can tell ccache explicitly which
compiler to fall back to as its first argument (not strictly necessary). For
KBUILD, we can swap our compiler by using <code>CC=</code> arg.</p><p>Let&rsquo;s see what happens to
our build time for subsequent builds with a hot cache:</p><h3 id=no-cache>No Cache</h3><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ make clean
</span></span><span style=display:flex><span>$ <span style=color:#b58900>time</span> make -j4
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>make -j4  2008.93s user 231.69s system 346% cpu 10:47.07 total
</span></span></code></pre></div><h3 id=cold-cache>Cold Cache</h3><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ ccache -Cz
</span></span><span style=display:flex><span>Cleared cache
</span></span><span style=display:flex><span>Statistics cleared
</span></span><span style=display:flex><span>$ ccache -s
</span></span><span style=display:flex><span>cache directory                     /home/nick/.ccache
</span></span><span style=display:flex><span>primary config                      /home/nick/.ccache/ccache.conf
</span></span><span style=display:flex><span>secondary config      <span style=color:#719e07>(</span><span style=color:#b58900>readonly</span><span style=color:#719e07>)</span>    /etc/ccache.conf
</span></span><span style=display:flex><span>cache hit <span style=color:#719e07>(</span>direct<span style=color:#719e07>)</span>                     <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>cache hit <span style=color:#719e07>(</span>preprocessed<span style=color:#719e07>)</span>               <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>cache miss                             <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>cache hit rate                      0.00 %
</span></span><span style=display:flex><span>cleanups performed                     <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>files in cache                         <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>cache size                           0.0 kB
</span></span><span style=display:flex><span>max cache size                       5.0 GB
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ make clean
</span></span><span style=display:flex><span>$ <span style=color:#b58900>time</span> <span style=color:#268bd2>KBUILD_BUILD_TIMESTAMP</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#39;&#39;</span> make <span style=color:#268bd2>CC</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#34;ccache gcc&#34;</span> -j4
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#268bd2>KBUILD_BUILD_TIMESTAMP</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#39;&#39;</span> make <span style=color:#268bd2>CC</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#34;ccache gcc&#34;</span> -j4  2426.79s user 312.08s system 372% cpu 12:15.22 total
</span></span><span style=display:flex><span>$ ccache -s
</span></span><span style=display:flex><span>cache directory                     /home/nick/.ccache
</span></span><span style=display:flex><span>primary config                      /home/nick/.ccache/ccache.conf
</span></span><span style=display:flex><span>secondary config      <span style=color:#719e07>(</span><span style=color:#b58900>readonly</span><span style=color:#719e07>)</span>    /etc/ccache.conf
</span></span><span style=display:flex><span>cache hit <span style=color:#719e07>(</span>direct<span style=color:#719e07>)</span>                     <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>cache hit <span style=color:#719e07>(</span>preprocessed<span style=color:#719e07>)</span>               <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>cache miss                          <span style=color:#2aa198>3242</span>
</span></span><span style=display:flex><span>called <span style=color:#719e07>for</span> link                        <span style=color:#2aa198>6</span>
</span></span><span style=display:flex><span>called <span style=color:#719e07>for</span> preprocessing             <span style=color:#2aa198>538</span>
</span></span><span style=display:flex><span>unsupported <span style=color:#b58900>source</span> language           <span style=color:#2aa198>66</span>
</span></span><span style=display:flex><span>no input file                        <span style=color:#2aa198>108</span>
</span></span><span style=display:flex><span>files in cache                      <span style=color:#2aa198>9720</span>
</span></span><span style=display:flex><span>cache size                         432.6 MB
</span></span><span style=display:flex><span>max cache size                       5.0 GB
</span></span></code></pre></div><h3 id=hot-cache>Hot Cache</h3><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ ccache -z
</span></span><span style=display:flex><span>Statistics cleared
</span></span><span style=display:flex><span>$ make clean
</span></span><span style=display:flex><span>$ <span style=color:#b58900>time</span> <span style=color:#268bd2>KBUILD_BUILD_TIMESTAMP</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#39;&#39;</span> make <span style=color:#268bd2>CC</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#34;ccache gcc&#34;</span> -j4
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#268bd2>KBUILD_BUILD_TIMESTAMP</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#39;&#39;</span> make <span style=color:#268bd2>CC</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#34;ccache gcc&#34;</span> -j4  151.85s user 132.98s system 288% cpu 1:38.90 total
</span></span><span style=display:flex><span>$ ccache -s
</span></span><span style=display:flex><span>cache directory                     /home/nick/.ccache
</span></span><span style=display:flex><span>primary config                      /home/nick/.ccache/ccache.conf
</span></span><span style=display:flex><span>secondary config      <span style=color:#719e07>(</span><span style=color:#b58900>readonly</span><span style=color:#719e07>)</span>    /etc/ccache.conf
</span></span><span style=display:flex><span>cache hit <span style=color:#719e07>(</span>direct<span style=color:#719e07>)</span>                  <span style=color:#2aa198>3232</span>
</span></span><span style=display:flex><span>cache hit <span style=color:#719e07>(</span>preprocessed<span style=color:#719e07>)</span>               <span style=color:#2aa198>7</span>
</span></span><span style=display:flex><span>cache miss                             <span style=color:#2aa198>3</span>
</span></span><span style=display:flex><span>called <span style=color:#719e07>for</span> link                        <span style=color:#2aa198>6</span>
</span></span><span style=display:flex><span>called <span style=color:#719e07>for</span> preprocessing             <span style=color:#2aa198>538</span>
</span></span><span style=display:flex><span>unsupported <span style=color:#b58900>source</span> language           <span style=color:#2aa198>66</span>
</span></span><span style=display:flex><span>no input file                        <span style=color:#2aa198>108</span>
</span></span><span style=display:flex><span>files in cache                      <span style=color:#2aa198>9734</span>
</span></span><span style=display:flex><span>cache size                         432.8 MB
</span></span><span style=display:flex><span>max cache size                       5.0 GB
</span></span></code></pre></div><p>The initial cold cache build will be slower than not using ccache at all, but
it&rsquo;s a one time cost that&rsquo;s not significant relative to the savings. No
caching took 647.07s, initial cold cache build took 735.22s (13.62% slower),
and subsequent hot cache builds took 98.9s (6.54x faster). YMMV based on CPU
and disk performance. Also, it&rsquo;s not the most common workflow to do clean
builds, but we do this for Linux kernel builds for Android/Pixel at work, and
this helps me significantly for local development.</p><p>Now, if you really need that date string in there, you <em>theoretically</em> could
put some garbage value in there (for the cache) long enough to save enough
space for a date string, then patch your vmlinux binary after the fact. I
<em>don&rsquo;t</em> recommend that, but I would imagine that might look something like:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ <span style=color:#268bd2>KBUILD_BUILD_TIMESTAMP</span><span style=color:#719e07>=</span><span style=color:#719e07>$(</span><span style=color:#b58900>printf</span> <span style=color:#2aa198>&#34;y%0.s&#34;</span> <span style=color:#719e07>$(</span>seq <span style=color:#2aa198>1</span> <span style=color:#719e07>$(</span>date | wc -c<span style=color:#719e07>)))</span>
</span></span><span style=display:flex><span>$ make <span style=color:#268bd2>CC</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#34;ccache gcc&#34;</span> vmlinux
</span></span><span style=display:flex><span>$ sed -i <span style=color:#2aa198>&#34;s/</span><span style=color:#719e07>$(</span>KBUILD_BUILD_TIMESTAMP<span style=color:#719e07>)</span><span style=color:#2aa198>/</span><span style=color:#719e07>$(</span>date<span style=color:#719e07>)</span><span style=color:#2aa198>/g&#34;</span> vmlinux
</span></span></code></pre></div><p>Deterministic builds make build caching easier, but I&rsquo;m not sure that build
timestamp strings and build determinism are reconcileable.</p></div><footer><p class=meta><span class="byline author vcard">Posted by <span class=fn>Nick Desaulniers</span></span>
<time>Jun 2, 2018</time></span></p><p class=meta><a class="basic-alignment left" href=https://nickdesaulniers.github.io/blog/2017/09/05/gcc-vs-llvm-q3-2017-commit-rates-and-active-developer-counts/ title="GCC vs LLVM Q3 2017 Commit Rates and Active Developer Counts">GCC vs LLVM Q3 2017 Commit Rates and Active Developer Counts</a>
<a class="basic-alignment right" href=https://nickdesaulniers.github.io/blog/2018/10/24/booting-a-custom-linux-kernel-in-qemu-and-debugging-it-with-gdb/ title="Booting a Custom Linux Kernel in QEMU and Debugging It With GDB">Booting a Custom Linux Kernel in QEMU and Debugging It With GDB</a></p><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//wangstabill.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></div><aside class="sidebar thirds"><section class="first odd"><p></p></section><ul class=sidebar-nav><li class=sidebar-nav-item><a target=_blank rel="noopener noreferrer" href=https://github.com/nickdesaulniers title=https://github.com/nickdesaulniers><i class="fa fa-github fa-3x"></i></a>
<a target=_blank rel="me noopener noreferrer" href=https://fosstodon.org/@llvm title=https://fosstodon.org/@llvm><i class="fa fa-mastodon fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/in/nick-desaulniers-75520334 title=https://www.linkedin.com/in/nick-desaulniers-75520334><i class="fa fa-linkedin fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.youtube.com/channel/UC68vgKSuS1Xjg9wpdvShfSQ title=https://www.youtube.com/channel/UC68vgKSuS1Xjg9wpdvShfSQ><i class="fa fa-youtube fa-3x"></i></a></li></ul><section class=even><h1>Recent Posts</h1><ul id=recent_posts><li class=post><a href=/blog/2023/03/10/disambiguating-arm/>Disambiguating Arm, Arm ARM, ARMv9, ARM9, ARM64, Aarch64, A64, A78, ...</a></li><li class=post><a href=/blog/2023/02/01/forking-is-not-free-the-hidden-costs/>Forking is not free; the hidden costs</a></li><li class=post><a href=/blog/2023/01/27/critical-edge-splitting/>Critical Edge Splitting</a></li><li class=post><a href=/blog/2023/01/20/debugging-wframe-larger-than/>Debugging -Wframe-larger-than=</a></li></ul></section></aside></div></div><footer role=contentinfo><p>Copyright &copy; 2023 Nick Desaulniers - <a href=https://nickdesaulniers.github.io/license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.</p></footer><script>var _gaq=[["_setAccount","UA-36993986-1"],["_trackPageview"]];(function(e,t){var n=e.createElement(t),s=e.getElementsByTagName(t)[0];n.src=("https:"==location.protocol?"//ssl":"//www")+".google-analytics.com/ga.js",s.parentNode.insertBefore(n,s)})(document,"script")</script></body></html>

<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Nick Desaulniers</title>
  <meta name="author" content="Nick Desaulniers">

  
  <meta name="description" content="This post is a follow up to
my previous blog post about word size. Three C/C++ programmers walk into a bar. One argues that sizeof(void*) is &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://nickdesaulniers.github.io/blog/page/2">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Nick Desaulniers" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at https://google.com/webfonts -->
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-36993986-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Nick Desaulniers</a></h1>
  
    <h2>The enemy's gate is down</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:nickdesaulniers.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/about">About</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/publications">Publications</a></li>
  <li><a href="/talks">Talks</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/05/30/data-models-and-word-size/">Data Models and Word Size</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-05-30T12:54:00-07:00" pubdate data-updated="true">May 30<span>th</span>, 2016</time>
        
         | <a href="/blog/2016/05/30/data-models-and-word-size/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>This post is a follow up to
<a href="/blog/2016/05/15/whats-in-a-word/">my previous blog post about word size</a>.</em></p>

<p>Three C/C++ programmers walk into a bar.  One argues that sizeof(void*) is
equivalent to sizeof(long), one argues that sizeof(void*) is equivalent to
sizeof(int), and the third argues it’s sizeof(long long).  Simultaneously,
they’re all right, but they’re also all wrong (and need a lesson about portable
C code).  What the hell is going on?</p>

<p>One of the first few programs a programmer might write after hello world is
something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;sizeof(int): %zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;sizeof(long): %zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">));</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;sizeof(long long): %zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">));</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;sizeof(void*): %zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Note the use of the %zu format specifier, a C99 addition that isn’t portable to
older compilers!  (This post is more about considerations when porting older
code to newer machines, not about porting newer code to run on older machines.
Not having a standards compliant C compiler makes writing more portable C code
even trickier, and is a subject for another blog post).</em></p>

<p>When I run that code on my x86-64 OSX machine, I get the following output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sizeof<span class="o">(</span>int<span class="o">)</span>: 4
</span><span class='line'>sizeof<span class="o">(</span>long<span class="o">)</span>: 8
</span><span class='line'>sizeof<span class="o">(</span>long long<span class="o">)</span>: 8
</span><span class='line'>sizeof<span class="o">(</span>void*<span class="o">)</span>: 8
</span></code></pre></td></tr></table></div></figure>


<p>So it looks like I would be the first programmer in the story in the first
paragraph, since on my machine, it looks like sizeof(long) == sizeof(void*).
Also note how sizeof(long long) is equivalent as well.</p>

<p>But what would happen if I compiled my code on a 32 bit machine?  Luckily, my
processor has backwards compatibility with 32b binaries, so I can cross compile
it locally and still run it. Ex:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>➜  clang sizeof.c -Wall -Wextra -Wpedantic
</span><span class='line'>➜  file a.out
</span><span class='line'>a.out: Mach-O 64-bit executable x86_64
</span><span class='line'>➜  clang sizeof.c -Wall -Wextra -Wpedantic -m32
</span><span class='line'>➜  file a.out
</span><span class='line'>a.out: Mach-O executable i386
</span><span class='line'>➜  ./a.out
</span><span class='line'>sizeof<span class="o">(</span>int<span class="o">)</span>: 4
</span><span class='line'>sizeof<span class="o">(</span>long<span class="o">)</span>: 4
</span><span class='line'>sizeof<span class="o">(</span>long long<span class="o">)</span>: 8
</span><span class='line'>sizeof<span class="o">(</span>void*<span class="o">)</span>: 4
</span></code></pre></td></tr></table></div></figure>


<p>Huh, suddenly sizeof(void*) == sizeof(int) == sizeof(long)!  This seems
to be the case of the second programmer from the story.</p>

<p>Both programmer 1 and programmer 2 might agree that the size of a pointer is
equivalent to their machine’s respective
<a href="/blog/2016/05/15/whats-in-a-word/">word size</a>,
but that too would be an incorrect assumption for portable C/C++ code!</p>

<p>Programmer 3 goes through the hellscape that is installing a working compiler
for Windows and building a 64b command line application (to be fair, installing
command line tools for OSX is worse; installing a compiler for most OS’ leaves
much to be desired).  When they run that program, they see:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sizeof<span class="o">(</span>int<span class="o">)</span>: 4
</span><span class='line'>sizeof<span class="o">(</span>long<span class="o">)</span>: 4
</span><span class='line'>sizeof<span class="o">(</span>long long<span class="o">)</span>: 8
</span><span class='line'>sizeof<span class="o">(</span>void*<span class="o">)</span>: 8
</span></code></pre></td></tr></table></div></figure>


<p>This is yet a third case (the third programmer from the story).  In this case,
only sizeof(long long) is equivalent to sizeof(void*).</p>

<h3>Data Models</h3>

<p>What these programmers are seeing is known as data models.  Programmer 1 one on
a 64b x86-64 OSX machine had an LP64 data model where longs (L), (larger long
longs,) and pointers (P) are 64b, but ints were 32b.  Programmer 2 on a 32b x86
OSX machine had an ILP32 data model where ints (I), longs (L), and pointers (P)
were 32b, but long longs were 64b.  Programmer 3 on a 64b x86-64 Windows
machine had a LLP64 data model, where only long longs (LL) and pointers (P)
were 64b, ints and longs being 32b.</p>

<table>
<thead>
<tr>
<th><strong>Data model</strong> </th>
<th> <strong>sizeof(int)</strong> </th>
<th> <strong>sizeof(long)</strong> </th>
<th> <strong>sizeof(long long)</strong> </th>
<th> <strong>sizeof(void*)</strong> </th>
<th> <strong>example</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>ILP32 </td>
<td> 32b </td>
<td> 32b </td>
<td> 64b </td>
<td> 32b </td>
<td> Win32, i386 OSX &amp; Linux</td>
</tr>
<tr>
<td>LP64 </td>
<td> 32b </td>
<td> 64b </td>
<td> 64b </td>
<td> 64b </td>
<td> x86-64 OSX &amp; Linux</td>
</tr>
<tr>
<td>LLP64 </td>
<td> 32b </td>
<td> 32b </td>
<td> 64b </td>
<td> 64b </td>
<td> Win64</td>
</tr>
</tbody>
</table>


<p>There are older data models such as LP32 (Windows 3.1, Macintosh, where ints
are 16b), and more exotic ones like ILP64, and SILP64.  Knowing the data model
thus is important for portable C/C++ code.</p>

<h3>Historical Perspective</h3>

<p>Running out of address space is and will continue to be tradition in computing.
Applications become bigger as computer power and memory gets cheaper.
Companies want to sell chips that have larger word sizes to address more
memory, but early adopters don’t want to buy a computer where there favorite
application hasn’t been compiled and thus doesn’t exist on yet.  <strong>Someone from
the back shouts <em>virtual machines</em> then ducks as a chair is thrown.</strong></p>

<p><a href="http://www.unix.org/version2/whatsnew/lp64_wp.html">This document</a>
highlights some reasons why LP64 is preferred to ILP64: ILP64
made portable C code that only needed 32b of precision harder to maintain (on
ILP64 an int was 64b, but a short was 16b!).  It mentions how for data
structures that did not contain pointers, their size would be the same on LLP64
as ILP32, which is the direction Microsoft went.  LLP64 was essentially the
ILP32 model with 64b pointers.</p>

<p><em>Linux also supports an ABI called
<a href="https://en.wikipedia.org/wiki/X32_ABI">x32</a>
which can use x86-64 ISA improvements but uses 32b pointers to reduce the size
of data structures that would otherwise have 64b pointers.</em></p>

<p>For a great historical perspective on the evolution of word size and data
models, as well as the &ldquo;toil and trouble&rdquo; caused,
<a href="https://queue.acm.org/detail.cfm?id=1165766">this paper</a>
was an excellent reference.  It describes Microsoft finally abandoning support
for 16b data models in Windows XP 64.  It mentions that the industry was pretty
split between LP64, LLP64, and ILP64 as porting code from the good old days of
ILP32 would break in different ways.  That the use of long was more prevalent
in Windows applications vs the use of int in unix applications.  It also makes
the key point that a lot of programmers from the ILP32 era made assumptions
that sizeof(int) == sizeof(long) == sizeof(void*) which would not hold true
for the LP64/LLP64 era.</p>

<p>One important point the paper makes makes that’s easily missed is that typedef
wasn’t added to C until 1977 when hardware manufactures still couldn’t agree on
how many bits were in a char (CHAR_BITS) and some machines were using 24b
addressing schemes.  stdint.h and inttypes.h did not exist yet.</p>

<p><a href="/blog/2016/05/15/whats-in-a-word/">This article</a>
talks about two main categories of effects of switching from ILP32 to LP64 and
has excellent examples of problematic code.  That section near the end is worth
the read alone and makes excellent points to look for during code review.</p>

<h3>Conclusion</h3>

<p>Word size or ISA doesn’t tell you anything about sizeof(int), sizeof(long), or
sizeof(long long).  We also saw that one machine can support multiple different
data models (when I compiled and ran the same code with the -m32 flag).</p>

<p>The C standard tells you minimum guaranteed sizes for these types, but the data
model (part of the ABI, external to but abiding by the C standard) is what
tells you about the specifics sizes of standard integers and pointers.</p>

<h3>Further Reading</h3>

<ul>
<li><a href="http://www.unix.org/version2/whatsnew/lp64_wp.html">64-Bit Programming Models: Why LP64?</a></li>
<li><a href="https://queue.acm.org/detail.cfm?id=1165766">The Long Road to 64 Bits</a></li>
<li><a href="http://www.unix.org/whitepapers/64bit.html">The UNIX System &mdash; 64bit and Data Size Neutrality</a></li>
<li><a href="https://en.wikipedia.org/wiki/64-bit_computing#64-bit_data_models">64-bit data models</a></li>
<li><a href="https://docs.oracle.com/cd/E19620-01/805-3024/lp64-1/index.html">C Language Data Type Models: LP64 and ILP32</a></li>
<li><a href="https://blogs.oracle.com/nike/entry/ilp64_lp64_llp64">ILP64, LP64, LLP64</a></li>
<li><a href="https://en.wikipedia.org/wiki/X32_ABI">x32 ABI</a></li>
<li><a href="http://stackoverflow.com/a/9162072">difference between stdint.h and inttypes.h</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa384083%28v=vs.85%29.aspx">Abstract Data Models</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa384264%28v=vs.85%29.aspx">The New Data Types</a></li>
<li><a href="http://stackoverflow.com/a/13413892">Is there any reason not to use fixed width integer types (e.g. uint8_t)?</a></li>
<li><a href="https://blogs.msdn.microsoft.com/oldnewthing/20050131-00/?p=36563/">Why did the Win64 team choose the LLP64 model?</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/05/15/whats-in-a-word/">What&#8217;s in a Word?</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-05-15T17:58:00-07:00" pubdate data-updated="true">May 15<span>th</span>, 2016</time>
        
         | <a href="/blog/2016/05/15/whats-in-a-word/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently, there some was some confusion between myself and a coworker over the
definition of a &ldquo;word.&rdquo;  I&rsquo;m currently working on a blog post about data
alignment and figured it would be good to clarify some things now, that we can
refer to later.</p>

<p>Having studied computer engineering and being quite fond of processor design,
when I think of a &ldquo;word,&rdquo; I think of the number of bits wide a processor&rsquo;s
general purpose registers are
(aka <a href="https://en.wikipedia.org/wiki/Word_%28computer_architecture%29#Size_families">word size</a>).
This places hard requirements on the largest representable number and address
space.  A 64 bit processor can represent 2<sup>64</sup>-1 (1.8x10<sup>19</sup>) as the largest
unsigned long integer, and address up to 2<sup>64</sup>-1 (16 EiB) different addresses in
memory.</p>

<p>Further, word size limits the possible combinations of operations the processor
can perform, length of immediate values used, inflates the size of binary files
and memory needed to store pointers, and puts pressure on instruction caches.</p>

<p>Word size also has implications on loads and stores based on alignment, as
we&rsquo;ll see in a follow up post.</p>

<p>When I think of 8 bit computers, I think of my first microcontroller: an
Arduino with an Atmel AVR processor.  When I think of 16 bit computers, I think
of my first game console, a Super Nintendo with a Ricoh 5A22.  When I think of
32 bit computers, I think of my first desktop with Intel&rsquo;s Pentium III.  And
when I think of 64 bit computers, I think modern smartphones with ARMv8
instruction sets.  When someone mentions a particular word size, what are the
machines that come to mind for you?</p>

<p>So to me, when someone&rsquo;s talking about a 64b processor, to that machine (and
me) a word is 64b.  When we&rsquo;re referring to a 8b processor, a word is 8b.</p>

<p>Now, some confusion.</p>

<p>Back in my previous blog posts about
<a href="/blog/2014/04/18/lets-write-some-x86-64/">x86-64 assembly</a>,
<a href="/blog/2015/05/25/interpreter-compiler-jit/">JITs</a>, or
<a href="/blog/2016/01/20/debugging-x86-64-assembly-with-lldb-and-dtrace/">debugging</a>,
you might have seen me use instructions that have suffixes of b for byte (8b),
w for word (16b), dw for double word (32b), and qw for quad word (64b) (since
SSE2 there&rsquo;s also double quadwords of 128b).</p>

<p>Wait a minute!  How suddenly does a &ldquo;word&rdquo; refer to 16b on a 64b processor, as
opposed to a 64b &ldquo;word?&rdquo;</p>

<p>In short, historical baggage.  Intel&rsquo;s first hit processor was the
<a href="https://en.wikipedia.org/wiki/Intel_4004">4004</a>,
a 4b processor released in 1971.  It wasn&rsquo;t until 1979 that Intel created the
16b
<a href="https://en.wikipedia.org/wiki/Intel_8086">8086 processor</a>.</p>

<p>The 8086 was created to compete with other 16b processors that beat it to the
market, like the
<a href="https://en.wikipedia.org/wiki/Zilog_Z80">Zilog Z80</a>
(any Gameboy emulator fans out there?  Yes, I know about the Sharp LR35902).
The 8086 was the first design in the
<a href="https://en.wikipedia.org/wiki/X86">x86 family</a>,
and it allowed for the same assembly syntax from the earlier 8008, 8080, and
8085 to be reassembled for it.  The 8086&rsquo;s little brother (8088) would be used
in
<a href="https://en.wikipedia.org/wiki/IBM_Personal_Computer#Open_standards">IBM&rsquo;s PC</a>,
and the rest is history.  x86 would become one of the most successful
ISAs in history.</p>

<p>For backwards compatibility, it seems that both Microsoft&rsquo;s (whose success has
tracked that of x86 since MS-DOS and IBM&rsquo;s PC) and Intel&rsquo;s documentation refers
to words still as being 16b. This allowed 16b PE32+ executables to be run on
32b or even 64b newer versions of Windows, without requiring recompilation of
source or source code modification.</p>

<p>This isn&rsquo;t necessarily wrong to refer to a word based on backwards
compatibility, it&rsquo;s just important to understand the context in which the term
&ldquo;word&rdquo; is being used, and that there might be some confusion if you have a
background with x86 assembly, Windows API programming, or processor design.</p>

<p>So the next time someone asks: why does Intel&rsquo;s documentation commonly refer to
a &ldquo;word&rdquo; as 16b, you can tell them that the x86 and x86-64 ISAs have maintained
the notion of a word being 16b since the first x86 processor, the 8086, which
was a 16b processor.</p>

<p><em>Side Note: for an excellent historical perspective programming early x86
chips, I recommend Michael Abrash&rsquo;s</em>
<a href="http://www.gamedev.net/page/resources/_/technical/graphics-programming-and-theory/graphics-programming-black-book-r1698">Graphics Programming Black Book</a>.
<em>For instance he talks about 8086&rsquo;s little brother, the 8088, being a 16b chip
but only having an 8b bus with which to access memory. This caused a mysterious</em>
<a href="http://downloads.gamedev.net/pdf/gpbb/gpbb4.pdf">&ldquo;cycle eater&rdquo;</a>
<em>to prevent fast access to 16b variables, though they were the processor&rsquo;s
natural size.  Michael also alludes to alignment issues we&rsquo;ll see in a follow
up post.</em></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/20/debugging-x86-64-assembly-with-lldb-and-dtrace/">Intro to Debugging X86-64 Assembly</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-01-20T20:04:00-08:00" pubdate data-updated="true">Jan 20<span>th</span>, 2016</time>
        
         | <a href="/blog/2016/01/20/debugging-x86-64-assembly-with-lldb-and-dtrace/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;m hacking on an assembly project, and wanted to document some of the tricks I
was using for figuring out what was going on.  This post might seem a little
basic for folks who spend all day heads down in gdb or who do this stuff
professionally, but I just wanted to share a quick intro to some tools that
others may find useful.
(<a href="https://pchiusano.github.io/2014-10-11/defensive-writing.html">oh god, I&rsquo;m doing it</a>)</p>

<p>If your coming from gdb to lldb, there&rsquo;s a few differences in commands.  LLDB
has
<a href="http://lldb.llvm.org/lldb-gdb.html">great documentation</a>
on some of the differences. Everything in this post about LLDB is pretty much
there.</p>

<p>The bread and butter commands when working with gdb or lldb are:</p>

<ul>
<li>r (run the program)</li>
<li>s (step in)</li>
<li>n (step over)</li>
<li>finish (step out)</li>
<li>c (continue)</li>
<li>q (quit the program)</li>
</ul>


<p>You can hit enter if you want to run the last command again, which is really
useful if you want to keep stepping over statements repeatedly.</p>

<p>I&rsquo;ve been using LLDB on OSX.  Let&rsquo;s say I want to debug a program I can build,
but is crashing or something:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>sudo lldb ./asmttpd web_root
</span></code></pre></td></tr></table></div></figure>


<p>Setting a breakpoint on jump to label:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">(</span>lldb<span class="o">)</span> b sys_write
</span><span class='line'>Breakpoint 3: <span class="nv">where</span> <span class="o">=</span> asmttpd<span class="sb">`</span>sys_write, <span class="nv">address</span> <span class="o">=</span> 0x00000000000029ae
</span></code></pre></td></tr></table></div></figure>


<p>Running the program until breakpoint hit:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">(</span>lldb<span class="o">)</span> r
</span><span class='line'>Process 32236 launched: <span class="s1">&#39;./asmttpd&#39;</span> <span class="o">(</span>x86_64<span class="o">)</span>
</span><span class='line'>Process 32236 stopped
</span><span class='line'>* thread <span class="c">#1: tid = 0xe69b9, 0x00000000000029ae asmttpd`sys_write, queue = &#39;com.apple.main-thread&#39;, stop reason = breakpoint 3.1</span>
</span><span class='line'>    frame <span class="c">#0: 0x00000000000029ae asmttpd`sys_write</span>
</span><span class='line'>asmttpd<span class="sb">`</span>sys_write:
</span><span class='line'>-&gt;  0x29ae &lt;+0&gt;: pushq  %rdi
</span><span class='line'>    0x29af &lt;+1&gt;: pushq  %rsi
</span><span class='line'>    0x29b0 &lt;+2&gt;: pushq  %rdx
</span><span class='line'>    0x29b1 &lt;+3&gt;: pushq  %r10
</span></code></pre></td></tr></table></div></figure>


<p>Seeing more of the current stack frame:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">(</span>lldb<span class="o">)</span> d
</span><span class='line'>asmttpd<span class="sb">`</span>sys_write:
</span><span class='line'>-&gt;  0x29ae &lt;+0&gt;:  pushq  %rdi
</span><span class='line'>    0x29af &lt;+1&gt;:  pushq  %rsi
</span><span class='line'>    0x29b0 &lt;+2&gt;:  pushq  %rdx
</span><span class='line'>    0x29b1 &lt;+3&gt;:  pushq  %r10
</span><span class='line'>    0x29b3 &lt;+5&gt;:  pushq  %r8
</span><span class='line'>    0x29b5 &lt;+7&gt;:  pushq  %r9
</span><span class='line'>    0x29b7 &lt;+9&gt;:  pushq  %rbx
</span><span class='line'>    0x29b8 &lt;+10&gt;: pushq  %rcx
</span><span class='line'>    0x29b9 &lt;+11&gt;: movq   %rsi, %rdx
</span><span class='line'>    0x29bc &lt;+14&gt;: movq   %rdi, %rsi
</span><span class='line'>    0x29bf &lt;+17&gt;: movq   <span class="nv">$0x1</span>, %rdi
</span><span class='line'>    0x29c6 &lt;+24&gt;: movq   <span class="nv">$0x2000004</span>, %rax
</span><span class='line'>    0x29cd &lt;+31&gt;: syscall
</span><span class='line'>    0x29cf &lt;+33&gt;: popq   %rcx
</span><span class='line'>    0x29d0 &lt;+34&gt;: popq   %rbx
</span><span class='line'>    0x29d1 &lt;+35&gt;: popq   %r9
</span><span class='line'>    0x29d3 &lt;+37&gt;: popq   %r8
</span><span class='line'>    0x29 &lt;+39&gt;: popq   %r10
</span><span class='line'>    0x29d7 &lt;+41&gt;: popq   %rdx
</span><span class='line'>    0x29d8 &lt;+42&gt;: popq   %rsi
</span><span class='line'>    0x29d9 &lt;+43&gt;: popq   %rdi
</span><span class='line'>    0x29da &lt;+44&gt;: retq
</span></code></pre></td></tr></table></div></figure>


<p>Getting a back trace (call stack):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">(</span>lldb<span class="o">)</span> bt
</span><span class='line'>* thread <span class="c">#1: tid = 0xe69b9, 0x00000000000029ae asmttpd`sys_write, queue = &#39;com.apple.main-thread&#39;, stop reason = breakpoint 3.1</span>
</span><span class='line'>  * frame <span class="c">#0: 0x00000000000029ae asmttpd`sys_write</span>
</span><span class='line'>    frame <span class="c">#1: 0x00000000000021b6 asmttpd`print_line + 16</span>
</span><span class='line'>    frame <span class="c">#2: 0x0000000000002ab3 asmttpd`start + 35</span>
</span><span class='line'>    frame <span class="c">#3: 0x00007fff9900c5ad libdyld.dylib`start + 1</span>
</span><span class='line'>    frame <span class="c">#4: 0x00007fff9900c5ad libdyld.dylib`start + 1</span>
</span></code></pre></td></tr></table></div></figure>


<p>peeking at the upper stack frame:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">(</span>lldb<span class="o">)</span> up
</span><span class='line'>frame <span class="c">#1: 0x00000000000021b6 asmttpd`print_line + 16</span>
</span><span class='line'>asmttpd<span class="sb">`</span>print_line:
</span><span class='line'>    0x21b6 &lt;+16&gt;: movabsq <span class="nv">$0x30cb</span>, %rdi
</span><span class='line'>    0x21c0 &lt;+26&gt;: movq   <span class="nv">$0x1</span>, %rsi
</span><span class='line'>    0x21c7 &lt;+33&gt;: callq  0x29ae                    ; sys_write
</span><span class='line'>    0x21cc &lt;+38&gt;: popq   %rcx
</span></code></pre></td></tr></table></div></figure>


<p>back down to the breakpoint-halted stack frame:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">(</span>lldb<span class="o">)</span> down
</span><span class='line'>frame <span class="c">#0: 0x00000000000029ae asmttpd`sys_write</span>
</span><span class='line'>asmttpd<span class="sb">`</span>sys_write:
</span><span class='line'>-&gt;  0x29ae &lt;+0&gt;: pushq  %rdi
</span><span class='line'>    0x29af &lt;+1&gt;: pushq  %rsi
</span><span class='line'>    0x29b0 &lt;+2&gt;: pushq  %rdx
</span><span class='line'>    0x29b1 &lt;+3&gt;: pushq  %r10
</span></code></pre></td></tr></table></div></figure>


<p>dumping the values of registers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">(</span>lldb<span class="o">)</span> register <span class="nb">read</span>
</span><span class='line'>General Purpose Registers:
</span><span class='line'>       <span class="nv">rax</span> <span class="o">=</span> 0x0000000000002a90  asmttpd<span class="sb">`</span>start
</span><span class='line'>       <span class="nv">rbx</span> <span class="o">=</span> 0x0000000000000000
</span><span class='line'>       <span class="nv">rcx</span> <span class="o">=</span> 0x00007fff5fbffaf8
</span><span class='line'>       <span class="nv">rdx</span> <span class="o">=</span> 0x00007fff5fbffa40
</span><span class='line'>       <span class="nv">rdi</span> <span class="o">=</span> 0x00000000000030cc  start_text
</span><span class='line'>       <span class="nv">rsi</span> <span class="o">=</span> 0x000000000000000f
</span><span class='line'>       <span class="nv">rbp</span> <span class="o">=</span> 0x00007fff5fbffa18
</span><span class='line'>       <span class="nv">rsp</span> <span class="o">=</span> 0x00007fff5fbff9b8
</span><span class='line'>        <span class="nv">r8</span> <span class="o">=</span> 0x0000000000000000
</span><span class='line'>        <span class="nv">r9</span> <span class="o">=</span> 0x00007fff7b1670c8  atexit_mutex + 24
</span><span class='line'>       <span class="nv">r10</span> <span class="o">=</span> 0x00000000ffffffff
</span><span class='line'>       <span class="nv">r11</span> <span class="o">=</span> 0xffffffff00000000
</span><span class='line'>       <span class="nv">r12</span> <span class="o">=</span> 0x0000000000000000
</span><span class='line'>       <span class="nv">r13</span> <span class="o">=</span> 0x0000000000000000
</span><span class='line'>       <span class="nv">r14</span> <span class="o">=</span> 0x0000000000000000
</span><span class='line'>       <span class="nv">r15</span> <span class="o">=</span> 0x0000000000000000
</span><span class='line'>       <span class="nv">rip</span> <span class="o">=</span> 0x00000000000029ae  asmttpd<span class="sb">`</span>sys_write
</span><span class='line'>    <span class="nv">rflags</span> <span class="o">=</span> 0x0000000000000246
</span><span class='line'>        <span class="nv">cs</span> <span class="o">=</span> 0x000000000000002b
</span><span class='line'>        <span class="nv">fs</span> <span class="o">=</span> 0x0000000000000000
</span><span class='line'>        <span class="nv">gs</span> <span class="o">=</span> 0x0000000000000000
</span></code></pre></td></tr></table></div></figure>


<p>read just one register:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">(</span>lldb<span class="o">)</span> register <span class="nb">read </span>rdi
</span><span class='line'>     <span class="nv">rdi</span> <span class="o">=</span> 0x00000000000030cc  start_text
</span></code></pre></td></tr></table></div></figure>


<p>When you&rsquo;re trying to figure out what system calls are made by some C code,
using dtruss is very helpful.  dtruss is available on OSX and seems to be some
kind of wrapper around DTrace.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>cat sleep.c
</span><span class='line'><span class="c">#include &lt;time.h&gt;</span>
</span><span class='line'>int main <span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  struct timespec <span class="nv">rqtp</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    2,
</span><span class='line'>    0
</span><span class='line'>  <span class="o">}</span>;
</span><span class='line'>
</span><span class='line'>  nanosleep<span class="o">(</span>&amp;rqtp, NULL<span class="o">)</span>;
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>clang sleep.c
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>sudo dtruss ./a.out
</span><span class='line'>...all kinds of fun stuff
</span><span class='line'>__semwait_signal<span class="o">(</span>0xB03, 0x0, 0x1<span class="o">)</span>    <span class="o">=</span> -1 Err#60
</span></code></pre></td></tr></table></div></figure>


<p>If you compile with <code>-g</code> to emit debug symbols, you can use lldb&rsquo;s disassemble
command to get the equivalent assembly:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>clang sleep.c -g
</span><span class='line'><span class="nv">$ </span>lldb a.out
</span><span class='line'><span class="o">(</span>lldb<span class="o">)</span> target create <span class="s2">&quot;a.out&quot;</span>
</span><span class='line'>Current executable <span class="nb">set </span>to <span class="s1">&#39;a.out&#39;</span> <span class="o">(</span>x86_64<span class="o">)</span>.
</span><span class='line'><span class="o">(</span>lldb<span class="o">)</span> b main
</span><span class='line'>Breakpoint 1: <span class="nv">where</span> <span class="o">=</span> a.out<span class="sb">`</span>main + 16 at sleep.c:3, <span class="nv">address</span> <span class="o">=</span> 0x0000000100000f40
</span><span class='line'><span class="o">(</span>lldb<span class="o">)</span> r
</span><span class='line'>Process 33213 launched: <span class="s1">&#39;/Users/Nicholas/code/assembly/asmttpd/a.out&#39;</span> <span class="o">(</span>x86_64<span class="o">)</span>
</span><span class='line'>Process 33213 stopped
</span><span class='line'>* thread <span class="c">#1: tid = 0xeca04, 0x0000000100000f40 a.out`main + 16 at sleep.c:3, queue = &#39;com.apple.main-thread&#39;, stop reason = breakpoint 1.1</span>
</span><span class='line'>    frame <span class="c">#0: 0x0000000100000f40 a.out`main + 16 at sleep.c:3</span>
</span><span class='line'>   1    <span class="c">#include &lt;time.h&gt;</span>
</span><span class='line'>   2    int main <span class="o">()</span> <span class="o">{</span>
</span><span class='line'>-&gt; 3      struct timespec <span class="nv">rqtp</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>   4        2,
</span><span class='line'>   5        0
</span><span class='line'>   6      <span class="o">}</span>;
</span><span class='line'>   7
</span><span class='line'><span class="o">(</span>lldb<span class="o">)</span> disassemble
</span><span class='line'>a.out<span class="sb">`</span>main:
</span><span class='line'>    0x100000f30 &lt;+0&gt;:  pushq  %rbp
</span><span class='line'>    0x100000f31 &lt;+1&gt;:  movq   %rsp, %rbp
</span><span class='line'>    0x100000f34 &lt;+4&gt;:  subq   <span class="nv">$0x20</span>, %rsp
</span><span class='line'>    0x100000f38 &lt;+8&gt;:  leaq   -0x10<span class="o">(</span>%rbp<span class="o">)</span>, %rdi
</span><span class='line'>    0x100000f3c &lt;+12&gt;: xorl   %eax, %eax
</span><span class='line'>    0x100000f3e &lt;+14&gt;: movl   %eax, %esi
</span><span class='line'>-&gt;  0x100000f40 &lt;+16&gt;: movq   0x49<span class="o">(</span>%rip<span class="o">)</span>, %rcx
</span><span class='line'>    0x100000f47 &lt;+23&gt;: movq   %rcx, -0x10<span class="o">(</span>%rbp<span class="o">)</span>
</span><span class='line'>    0x100000f4b &lt;+27&gt;: movq   0x46<span class="o">(</span>%rip<span class="o">)</span>, %rcx
</span><span class='line'>    0x100000f52 &lt;+34&gt;: movq   %rcx, -0x8<span class="o">(</span>%rbp<span class="o">)</span>
</span><span class='line'>    0x100000f56 &lt;+38&gt;: callq  0x100000f68               ; symbol stub <span class="k">for</span>: nanosleep
</span><span class='line'>    0x100000f5b &lt;+43&gt;: xorl   %edx, %edx
</span><span class='line'>    0x100000f5d &lt;+45&gt;: movl   %eax, -0x14<span class="o">(</span>%rbp<span class="o">)</span>
</span><span class='line'>    0x100000f60 &lt;+48&gt;: movl   %edx, %eax
</span><span class='line'>    0x100000f62 &lt;+50&gt;: addq   <span class="nv">$0x20</span>, %rsp
</span><span class='line'>    0x100000f66 &lt;+54&gt;: popq   %rbp
</span><span class='line'>    0x100000f67 &lt;+55&gt;: retq
</span></code></pre></td></tr></table></div></figure>


<p>Anyways, I&rsquo;ve been learning some interesting things about OSX that I&rsquo;ll be
sharing soon. If you&rsquo;d like to learn more about x86-64 assembly programming,
you should read my other posts about
<a href="/blog/2014/04/18/lets-write-some-x86-64/">writing x86-64</a>
and a toy
<a href="/blog/2015/05/25/interpreter-compiler-jit/">JIT for Brainfuck</a>
(<a href="https://www.reddit.com/r/programming/comments/377ov9/interpreter_compiler_jit/crkkrz4">the creator of Brainfuck liked it</a>).</p>

<p>I should also do a post on
<a href="http://rr-project.org/">Mozilla&rsquo;s rr</a>,
because it can do amazing things like step backwards.  Another day&hellip;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/08/14/my-siggraph-2015-experience/">My SIGGRAPH 2015 Experience</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-08-14T10:10:00-07:00" pubdate data-updated="true">Aug 14<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/08/14/my-siggraph-2015-experience/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I was recently lucky enough to get to attend my first SIGGRAPH conference this
year.  While I didn&rsquo;t attend any talks, I did spend some time in the expo. Here
is a collection of some of the neat things I saw at SIGGRAPH 2015.  Sorry it&rsquo;s
not more collected; I didn&rsquo;t have the intention of writing a blog post until
after folks kept asking me &ldquo;how was it?&rdquo;</p>

<h2>VR</h2>

<p>Most booths had demos on VR headsets.  Many were DK2&rsquo;s and GearVR&rsquo;s.  AMD and
NVIDIA had Crescent Bay&rsquo;s (next gen VR headset).  It was noticeably lighter than
the DK2, and I thought it rendered better quality.  It had nicer cable bundling,
and
headphones built in, that could fold up and lock out of the way that made it
nice to put on/take off.  I also tried a Sony Morpheus.  They had a very
engaging demo that was a tie in to the upcoming movie about tight rope walking,
&ldquo;The Walk&rdquo;.  They had a thin PVC pipe taped to the floor that you had to
balance on, and a fan, and you were tight rope walking between the Twin Towers.
Looking down and trying to balance was terrifying.  There were some demos with
a strange mobile VR setup where folks had a backpack on that had an open laptop
hanging off the back and could walk around.  Toyota and Ford had demos where you
could inspect their vehicles in virtual space.  I did not see a single HTC/Valve
Vive at SIGGRAPH.</p>

<p><img class="center" src="/images/siggraph/s8.jpg">
<img class="center" src="/images/siggraph/s1.jpg">
<img class="center" src="/images/siggraph/s3.jpg">
<img class="center" src="/images/siggraph/s2.jpg">
<img class="center" src="/images/siggraph/s4.jpg"></p>

<h2>AR</h2>

<p>Epson had some AR glasses. They were very glasses friendly, unlike most VR
headsets.  The nose piece was flexible, and if you flattened it out, the headset
could rest on top of your glasses and worked well.  The headset had some very
thick compound lenses.  There was a front facing camera and they had a simple
demo using image recognition of simple logos (like QR codes) that helped provide
position data.  There were other demos with orientation tracking that worked
well.  They didn&rsquo;t have positional sensor info, but had some hack that tried to
estimate positional velocity off the angular momentum (I spoke with the
programmer who implemented it).  <a href="https://moverio.epson.biz/">https://moverio.epson.biz/</a></p>

<h2>Holograms</h2>

<p>There was a demo of holograms using tilted pieces of plastic arranged in a box.
Also, there was a multiple (200+) projector array that projected a scene onto a
special screen.  When walking around the screen, the viewing angle always seemed
correct.  It was very convincing, except for the jarring restart of the animated
loop which could be smoothed out (think looping/seamless gifs).</p>

<p><img class="center" src="/images/siggraph/s5.jpg"></p>

<h2>VR/3D video</h2>

<p>Google cardboard had a booth showing off 3D videos from youtube.  I had a hard
time telling if the video were stereoscopic or monoptic since the demo videos
only had things in the distance so it was hard to tell if parallax was
implemented correctly.  A bunch of booths were showing off 3D video, but as far
as I could tell, all of the correctly rendered stereoscopic shots were computer
rendered.  I could not find a single instance with footage shot from a
stereoscopic rig, though I tried.</p>

<h2>Booths/Expo</h2>

<p>NVIDIA and Intel had the largest booths, followed by Pixar&rsquo;s Renderman.  Felt
like a GDC event, smaller, but definitely larger than GDC next.  More focus on
shiny photorealism demos, artistic tools, less on game engines themselves.</p>

<h2>Vulcan/OpenGL ES 3.2</h2>

<p>Intel had demos of Vulcan and OpenGL ES 3.2.  For 3.2 they were showing off
tessellation shaders, I think.  For the Vulcan demo, they had a cool demo showing
how with
a particle demo scene rendered with OpenGL 4, a single CPU was pegged, it was
using a lot of power, and had pretty abysmal framerate.  When rendering the same
scene with Vulcan, they were able to more evenly distribute the workload across
CPUs, achieve higher framerate, while using less power.  The API to Vulcan is
<em>still</em> not published, so no source code is available. It was explained to me
that Vulcan is still not thread safe; instead you get the freedom to implement
synchronization rather than the driver.</p>

<h2>Planetarium</h2>

<p>There was a neat demo of a planetarium projector being repurposed to display
an &ldquo;on rails&rdquo; demo of a virtual scene.  You didn&rsquo;t get parallax since it was
being projected on a hemisphere, but it was neat in that like IMAX your entire
FOV was encompassed, but you could move your head, not see any pixels, and
didn&rsquo;t experience any motion sickness or disorientation.</p>

<p><img class="center" src="/images/siggraph/s7.jpg"></p>

<h2>X3D/X3DOM</h2>

<p>I spoke with some folks at the X3D booth about X3DOM.  To me, it seems like a
bunch of previous attempts have kind of added on too much complexity in an
effort to support every use case under the sun, rather than just accept
limitations, so much so that getting started writing hello world became
difficult.  Some of the folks I spoke to at the booth echoed this sentiment, but
also noted the lack of authoring tools as things that hurt adoption.  I have
some neat things I&rsquo;m working on in this space, based on this and other prior
works, that I plan on showing off at the upcoming BrazilJS.</p>

<h2>Maker Faire</h2>

<p>There was a cool maker faire, some things I&rsquo;ll have to order for family members
(young hackers in training) were <a href="http://cannybots.com/">Canny bots</a>,
<a href="http://ebeeproject.net/">eBee</a> and <a href="http://www.withpiper.com/">Piper</a>.</p>

<p><img class="center" src="/images/siggraph/s6.jpg"></p>

<h2>Experimental tech</h2>

<p>Bunch of neat input devices, one I liked used directional sound as tactile
feedback.  One demo was rearranging icons on a home screen.  Rather than touch
the screen, there was a field of tiny speakers that would blast your finger with
sound when it entered to simulate the feeling of vibration. It would vibrate
to let you know you had &ldquo;grabbed&rdquo; and icon, and then drag it.</p>

<h2>Book Signing</h2>

<p>This was the first time I got to see my book printed in physical form!  It
looked gorgeous, hardcover printed in color.  I met about half of the fellow
authors who were also at SIGGRAPH, and our editor.  I even got to meet Eric
Haines, who reviewed my chapter before publication!</p>

<p><img class="center" src="/images/siggraph/s9.jpg">
<img class="center" src="/images/siggraph/s10.jpg">
<img class="center" src="/images/siggraph/s11.jpg"></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/23/additional-c-slash-c-plus-plus-tooling/">Additional C/C++ Tooling</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-07-23T21:10:00-07:00" pubdate data-updated="true">Jul 23<span>rd</span>, 2015</time>
        
         | <a href="/blog/2015/07/23/additional-c-slash-c-plus-plus-tooling/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://shop.oreilly.com/product/0636920025108.do">21st Century C by Ben Klemens</a>
was a great read. It had a section with an
intro to autotools, git, and gdb.
There are a few other useful tools that came to mind that I&rsquo;ve used when
working with C and C++ codebases. These tools are a great way to start
contributing to
<a href="https://github.com/nickdesaulniers/What-Open-Source-Means-To-Me#what-open-source-means-to-me">Open Source</a>
C &amp; C++ codebases; running these tools on
the code or adding them to the codebases.  A lot of these favor command line,
open source utilities. See how many you are familiar with!</p>

<h2>Build Tools</h2>

<h3>CMake</h3>

<p>The first tool I&rsquo;d like to take a look at is
<a href="http://www.cmake.org/overview/">CMake</a>.  CMake is yet another build tool; I
realize how contentious it is to even discuss one of the many.  From my
experience working with
<a href="https://kripken.github.io/emscripten-site/docs/introducing_emscripten/about_emscripten.html">Emscripten</a>,
we recommend the use of CMake for people
writing portable C/C++ programs.  CMake is able to emit Makefiles for unixes,
project files for Xcode on OSX, and project files for Visual Studio on Windows.
There are also a few other &ldquo;generators&rdquo; that you can use.</p>

<p>I&rsquo;ve been really impressed with CMake&rsquo;s modules for
<a href="http://www.cmake.org/cmake/help/v3.0/command/find_package.html">finding dependencies</a>
and
<a href="http://www.cmake.org/cmake/help/v3.0/module/ExternalProject.html">another for fetching and building external dependencies</a>.
I think
<a href="https://www.youtube.com/watch?v=nshzjMDD79w">C++ needs a package manager badly</a>,
and I think CMake would be a solid foundation for one.</p>

<p>The syntax isn&rsquo;t the greatest, but when I wanted to try to build one of my C++
projects on Windows which I know nothing about developing on, I was able to
install CMake and Visual Studio and get my project building.  If you can build
your code on one platform, it will usually build on the others.</p>

<p>If you&rsquo;re not worried about writing cross platform C/C++, maybe CMake is not
worth the effort, but I find it useful.  I wrestle with the syntax sometimes,
but documentation is not bad and it&rsquo;s something you deal with early on in the
development of a project and hopefully never have to touch again (how I wish
that were true).</p>

<h2>Code Formatters</h2>

<h3>ClangFormat</h3>

<p>Another contentious point of concern amongst developers is code style.
<a href="http://google-styleguide.googlecode.com/svn/trunk/cppguide.html">Big companies</a>
with lots of C++ code have
<a href="https://developer.mozilla.org/en-US/docs/Mozilla/Developer_guide/Coding_Style#CC_practices">documents</a>
explaining their stylistic choices.  Don&rsquo;t waste another hour of your life
arguing about something that really doesn&rsquo;t matter.
<a href="http://clang.llvm.org/docs/ClangFormat.html">ClangFormat</a> will help you
codify your style and format your code for you to match the style.  Simply
write the code however you want, and run the formatter on it before commiting
it.</p>

<p>It can also emit a .clang-format file that you can commit and clang-format will automatically look for that file and use the rules codified there.</p>

<h2>Linters</h2>

<h3>Flint / Flint++</h3>

<p><a href="https://github.com/facebook/flint">Flint</a> is a C++ linter in use at Facebook.
Since it moved from being
implemented in C++ to D, I&rsquo;ve had issues building it.  I&rsquo;ve had better luck
with a fork that&rsquo;s pure C++ without any of the third party dependencies Flint
originally had, called
<a href="https://github.com/L2Program/FlintPlusPlus">Flint++</a>.  While not quite full-on
static analyzers, both can be used for finding potential issues in your code
ahead of time. Linters can look at individual files in isolation; you don&rsquo;t
have to wait for long recompiles like you would with a static analyzer.</p>

<h2>Static Analyzers</h2>

<h3>Scan-build</h3>

<p><a href="http://clang-analyzer.llvm.org/scan-build.html">Scan-build</a> is a static
analyzer for C and C++ code.  You build your code &ldquo;through&rdquo; it, then use the
sibling tool scan-view to see the results.  Scan-view will emit and open an
html file that shows a list of the errors it detected.  It will insert
hyperlinks into the resulting document that step you through how certain
conditions could lead to a null pointer dereference, for example.  You can also
save and share those html files with others in the project. Static analyzers
will help you catch bugs at compile time before you run the code.</p>

<h2>Runtime Sanitizers</h2>

<h3>ASan and UBSan</h3>

<p>Clang&rsquo;s Address (ASan) and Undefined Behavior (UBSan) sanitizers are simply
compiler flags that can be used to detect errors at runtime.  ASan and UBSan
two of the more popular tools, but there are actually a ton and more being
implemented.  See the list
<a href="http://clang.llvm.org/docs/UsersManual.html#controlling-code-generation">here</a>.
These sanitizers will catch bugs at runtime, so you&rsquo;ll have to run the code
to notice any violations, at variable runtime performance costs per sanitizer.
ASan and TSan (Thread Sanitizer) made it into gcc4.8 and UBSan is in gcc4.9.</p>

<h2>Header Analysis</h2>

<h3>Include What You Use</h3>

<p><a href="https://github.com/include-what-you-use/include-what-you-use">Include What You Use</a>
(IWYU) helps you find unused or unnecessary <code>#include</code> preprocessor directives.
It should be obvious how this can help improve compile times. IWYU can also
help cut down on recompiles by recommending forward declarations under certain
conditions.
I look forward to the C++ module proposal being adopted, but until then this
tool can help you spot cruft that can be removed.</p>

<h2>Rapid Recompiles</h2>

<h3>ccache</h3>

<p><a href="https://ccache.samba.org/">ccache</a> greatly improves recompile times by caching
the results of parts of the compilation process.
<a href="https://github.com/nickdesaulniers/dotfiles/blob/49984b3e82022e5ce82e778fc8ce990f8e1e554a/.mozconfig#L1">I use when building Firefox</a>,
and it saves a great deal of time.</p>

<h3>distcc</h3>

<p><a href="https://github.com/distcc/distcc">distcc</a> is a distributed build system.
<a href="http://blog.dholbert.org/">Some folks at Mozilla</a> speed up their Firefox builds with it.</p>

<h2>Memory Leak Detectors</h2>

<h3>Valgrind</h3>

<p><a href="http://valgrind.org/info/about.html">Valgrind</a> has a
<a href="http://valgrind.org/info/about.html">suite of tools</a>, my
favorite being memcheck for finding memory leaks. Unfortunately, it doesn&rsquo;t
seem to work on OSX since 10.10.
<a href="https://code.google.com/p/address-sanitizer/wiki/ComparisonOfMemoryTools">This page</a>
referring to ASan seems to indicate that it can do everything Valgrind&rsquo;s
Memcheck can, at less of a runtime performance cost, but I&rsquo;m not sure how true
this is exactly.</p>

<h3>leaks</h3>

<p>A much more primitive tool for finding leaks from the command line, BSD&rsquo;s have
<code>leaks</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">MallocStackLogging</span><span class="o">=</span>1 ./a.out
</span><span class='line'>leaks a.out
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<h2>Profilers</h2>

<h3>Perf</h3>

<p>Perf, and
<a href="http://www.brendangregg.com/flamegraphs.html">Brendan Gregg&rsquo;s tools for emitting SVG flamegraphs</a>
from the output
are helpful for finding where time is spent in a program. In fact, there are
numerous perfomance analysis tools that are Linux specific.  My recommendation
is spend some time on <a href="http://www.brendangregg.com/linuxperf.html">Brendan Gregg&rsquo;s blog</a>.</p>

<h3>DTrace</h3>

<p>OSX doesn&rsquo;t have the same tooling as Linux, but DTrace was ported to it.  I&rsquo;ve
used it to find sampling profiles of my code before. Again,
<a href="http://www.brendangregg.com/dtrace.html">Brendan Gregg&rsquo;s blog</a> is a good
resource; there are some fantastic DTrace one liners.</p>

<h2>Debuggers</h2>

<h3>lldb</h3>

<p>lldb is analogous to gdb.  I can&rsquo;t say I have enough experience with LLDB and GDB to note the difference between the two, but LLDB did show the relative statements forward and back from the current statement by default.  I&rsquo;m informed by my friends/mortal enemies using emacs that this is less of an issue when using emacs/gdb in combination.</p>

<h2>Fuzzers</h2>

<h3>American Fuzzy Lop</h3>

<p><a href="http://lcamtuf.coredump.cx/afl/">American Fuzzy Lop</a> (AFL) is a neat program
that performs fuzzing on programs
that take inputs from files and repeatedly runs the program, modifies the
input trying to get full code coverage, and tries to find crashes.  It&rsquo;s been
getting lots of attention lately, and while I haven&rsquo;t used it myself yet, it
seems like a very powerful tool. Mozilla employs the use of fuzzers on their
JavaScript engine, for instance (not AFL, but
<a href="http://www.squarefree.com/2007/08/02/introducing-jsfunfuzz/">one developed in house</a>).</p>

<h2>Disassemblers</h2>

<h3>gobjdump</h3>

<p>If you really need to make sure the higher level code you&rsquo;re writing is getting
translated into the assembly your expecting, <code>gobjdump -S</code> will intermix the
emitted binary&rsquo;s disassembled assembly and the source code.  This was used
extensively while developing <a href="/blog/2015/05/25/interpreter-compiler-jit/">my Brainfuck JIT</a>.</p>

<h2>Conclusion</h2>

<p>Hopefully you learned of some useful tools that you should know about when
working with C or C++.  What did I miss?</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/25/interpreter-compiler-jit/">Interpreter, Compiler, JIT</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-05-25T08:35:00-07:00" pubdate data-updated="true">May 25<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/05/25/interpreter-compiler-jit/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Interpreters and compilers are interesting programs, themselves used to run or
translate other programs, respectively.  Those other programs that might be
interpreted might be languages like JavaScript, Ruby, Python, PHP, and Perl.  The
other programs that might be compiled are C, C++, and to some extent Java and
C#.</p>

<p>Taking the time to do translation to native machine code ahead of
time can result in better performance at runtime, but an interpreter can get to work right away without spending any time translating.  There happens to be a sweet spot
somewhere in between interpretation and compilation that combines the best of
both worlds.  Such a technique
is called Just In Time (JIT) compiling.  While interpreting, compiling, and JIT&#8217;ing code might sound radically different, they&rsquo;re actually strikingly similar.  In
this post, I hope to show how similar by comparing the code for an interpreter,
a compiler, and a JIT compiler for the language Brainfuck in around 100 lines
of C code each.</p>

<p>All of the code in the post is up on <a href="https://github.com/nickdesaulniers/bf_interpreter_jit_compiler">GitHub</a>.</p>

<div class="embed-video-container"><iframe src="//www.youtube.com/embed/_C5AHaS1mOA" allowfullscreen></iframe></div>


<p>Brainfuck is an interesting, if hard to read, language.  It only has eight
operations it can perform <code>&gt; &lt; + - . , [ ]</code>, yet is Turing complete.  There&rsquo;s nothing really to
lex; each character is a token, and if the token is not one of the eight
operators, it&rsquo;s ignored.  There&rsquo;s also not much of a grammar to parse; the
forward jumping and backwards jumping operators should be matched for well
formed input, but that&rsquo;s about it.  In this post, we&rsquo;ll skip over validating
input assuming well formed input so we can focus on the interpretation/code
generation.  You can read more about it on the
<a href="http://en.wikipedia.org/wiki/Brainfuck">Wikipedia page</a>,
which we&rsquo;ll be using as a reference throughout.</p>

<p>A Brainfuck program operates on a 30,000 element byte array initialized to all
zeros.  It starts off with an instruction pointer, that initially points to the
first element in the data array or &ldquo;tape.&rdquo;  In C code for an interpreter that
might look like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// Initialize the tape with 30,000 zeroes.</span>
</span><span class='line'><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tape</span> <span class="p">[</span><span class="mi">30000</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Set the pointer to point at the left most cell of the tape.</span>
</span><span class='line'><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">tape</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, since we&rsquo;re performing an operation for each character in the Brainfuck
source, we can have a for loop over every character with a nested switch
statement containing case statements for each operator.</p>

<p>The first two operators, <code>&gt;</code> and <code>&lt;</code> increment and decrement the data pointer.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="sc">&#39;&gt;&#39;</span>: <span class="o">++</span><span class="n">ptr</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="k">case</span> <span class="sc">&#39;&lt;&#39;</span>: <span class="o">--</span><span class="n">ptr</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>One thing that could be bad is that because the interpreter is written in C and
we&rsquo;re representing the tape as an array but we&rsquo;re not validating our inputs,
there&rsquo;s potential for stack buffer overrun since we&rsquo;re not performing bounds
checks.  Again, punting and assuming well formed input to keep the code and the
point more precise.</p>

<p>Next up are the <code>+</code> and <code>-</code> operators, used for incrementing and decrementing
the cell pointed to by the data pointer by one.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="sc">&#39;+&#39;</span>: <span class="o">++</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="k">case</span> <span class="sc">&#39;-&#39;</span>: <span class="o">--</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The operators <code>.</code> and <code>,</code> provide Brainfuck&rsquo;s only means of input or output, by
writing the value pointed to by the instruction pointer to stdout as an ASCII
value, or reading one byte from stdin as an ASCII value and writing it to the
cell pointed to by the instruction pointer.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="sc">&#39;.&#39;</span>: <span class="n">putchar</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="k">case</span> <span class="sc">&#39;,&#39;</span>: <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">();</span> <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, our looping constructs, <code>[</code> and <code>]</code>.  From the definition on Wikipedia
for <code>[</code>: <code>if the byte at the data pointer is zero, then instead of moving the
instruction pointer forward to the next command, jump it forward to the command
after the matching ] command</code> and for <code>]</code>: <code>if the byte at the data pointer is
nonzero, then instead of moving the instruction pointer forward to the next
command, jump it back to the command after the matching [ command.</code></p>

<p>I interpret that as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="sc">&#39;[&#39;</span>:
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">loop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">loop</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">current_char</span> <span class="o">=</span> <span class="n">input</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">current_char</span> <span class="o">==</span> <span class="sc">&#39;]&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="o">--</span><span class="n">loop</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">current_char</span> <span class="o">==</span> <span class="sc">&#39;[&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="o">++</span><span class="n">loop</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="k">case</span> <span class="sc">&#39;]&#39;</span>:
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">loop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">loop</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">current_char</span> <span class="o">=</span> <span class="n">input</span><span class="p">[</span><span class="o">--</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">current_char</span> <span class="o">==</span> <span class="sc">&#39;[&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="o">--</span><span class="n">loop</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">current_char</span> <span class="o">==</span> <span class="sc">&#39;]&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="o">++</span><span class="n">loop</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Where the variable <code>loop</code> keeps track of open brackets for which we&rsquo;ve not seen
a matching close bracket, aka our nested depth.</p>

<p>So <a href="https://github.com/nickdesaulniers/bf_interpreter_jit_compiler/blob/master/interpreter.c">we can see the interpreter is quite basic</a>, in around 50 SLOC were able to
read a byte, and immediately perform an action based on the operator.  How we
perform that operation might not be the fastest though.</p>

<p>How about if we want to compile the Brainfuck source code to native machine
code?  Well, we need to know a little bit about our host machine&rsquo;s Instruction
Set Architecture (ISA) and Application Binary Interface (ABI).  The rest of the
code in this post will not be as portable as the above C code, since it assumes
an x86-64 ISA and UNIX ABI.  Now would be a good time to <a href="/blog/2014/04/18/lets-write-some-x86-64/">take a detour and learn more about writing assembly for x86-64</a>.  The interpreter is even portable enough to <a href="https://github.com/nickdesaulniers/bf_interpreter_jit_compiler#emscripten">build with Emscripten and run in a browser</a>!</p>

<p>For our compiler, we&rsquo;ll iterate over every character in the source file again,
switching on the recognized operator.  This time, instead of performing an
action right away, we&rsquo;ll print assembly instructions to stdout.  Doing so
requires running the compiler on an input file, redirecting stdout to a file,
then running the system assembler and linker on that file.  We&rsquo;ll stick with
just compiling and not assembling (though it&rsquo;s not too difficult), and linking
(for now).</p>

<p>First, we need to print a prologue for our compiled code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">prologue</span> <span class="o">=</span>
</span><span class='line'>  <span class="s">&quot;.text</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>  <span class="s">&quot;.globl _main</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>  <span class="s">&quot;_main:</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>  <span class="s">&quot;  pushq %rbp</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>  <span class="s">&quot;  movq %rsp, %rbp</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>  <span class="s">&quot;  pushq %r12</span><span class="se">\n</span><span class="s">&quot;</span>        <span class="c1">// store callee saved register</span>
</span><span class='line'>  <span class="s">&quot;  subq $30008, %rsp</span><span class="se">\n</span><span class="s">&quot;</span> <span class="c1">// allocate 30,008 B on stack, and realign</span>
</span><span class='line'>  <span class="s">&quot;  leaq (%rsp), %rdi</span><span class="se">\n</span><span class="s">&quot;</span> <span class="c1">// address of beginning of tape</span>
</span><span class='line'>  <span class="s">&quot;  movl $0, %esi</span><span class="se">\n</span><span class="s">&quot;</span>     <span class="c1">// fill with 0&#39;s</span>
</span><span class='line'>  <span class="s">&quot;  movq $30000, %rdx</span><span class="se">\n</span><span class="s">&quot;</span> <span class="c1">// length 30,000 B</span>
</span><span class='line'>  <span class="s">&quot;  call _memset</span><span class="se">\n</span><span class="s">&quot;</span>      <span class="c1">// memset</span>
</span><span class='line'>  <span class="s">&quot;  movq %rsp, %r12&quot;</span><span class="p">;</span>
</span><span class='line'><span class="n">puts</span><span class="p">(</span><span class="n">prologue</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>During the linking phase, we&rsquo;ll make sure to link in libc so we can call
memset.  What we&rsquo;re doing is backing up callee saved registers we&rsquo;ll be using,
stack allocating the tape, realigning the stack (<a href="/blog/2014/04/18/lets-write-some-x86-64/">x86-64 ABI point #1</a>), copying
the address of the only item on the stack into a register for our first
argument, setting the second argument to the constant <code>0</code>, the third arg to
<code>30000</code>, then calling memset.  Finally, we use the callee saved register %r12
as our instruction pointer, which is the address into a value on the stack.</p>

<p>We
can expect the call to memset to result in a segfault if simply subtract just
30000B, and not realign for the 2 registers (64 b each, 8 B each) we pushed on
the stack.  The first pushed register aligns the stack on a 16 B boundary, the
second misaligns it; that&rsquo;s why we allocate an additional 8 B on the stack
(<a href="/blog/2014/04/18/lets-write-some-x86-64/">x86-64 ABI point #1</a>).  The stack is mis-aligned upon function entry in x86-64.
30000 is a multiple of 16.</p>

<p><img class="center" src="/images/compiler_stack_alignment.png"></p>

<p>Moving the instruction pointer (<code>&gt;</code>, <code>&lt;</code>) and modifying the pointed to value
(<code>+</code>, <code>-</code>) are straight-forward:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="sc">&#39;&gt;&#39;</span>:
</span><span class='line'>  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;  inc %r12&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="k">case</span> <span class="sc">&#39;&lt;&#39;</span>:
</span><span class='line'>  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;  dec %r12&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="k">case</span> <span class="sc">&#39;+&#39;</span>:
</span><span class='line'>  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;  incb (%r12)&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="k">case</span> <span class="sc">&#39;-&#39;</span>:
</span><span class='line'>  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;  decb (%r12)&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>For output, <code>.</code>, we need to copy the pointed to byte into the register for the
first argument to putchar.  We
explicitly zero out the register before calling putchar, since it takes an int
(32 b), but we&rsquo;re only copying a char (8 b) (Look up C&rsquo;s type promotion rules for more info).  x86-64 has an instruction that does both, movzXX, Where the first X is the source size (b, w) and the second is the destination size (w, l, q).  Thus movzbl moves a <strong>b</strong>yte (8 b) into a doub<strong>l</strong>e word (32 b).  %rdi and %edi are the same register, but %rdi is the full
64 b register, while %edi is the lowest (or least significant) 32 b.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="sc">&#39;.&#39;</span>:
</span><span class='line'>  <span class="c1">// move byte to double word and zero upper bits since putchar takes an</span>
</span><span class='line'>  <span class="c1">// int.</span>
</span><span class='line'>  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;  movzbl (%r12), %edi&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;  call _putchar&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Input (<code>,</code>) is easy; call getchar, move the resulting lowest byte into the cell
pointed to by the instruction pointer.  %al is the lowest 8 b of the 64 b %rax register.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="sc">&#39;,&#39;</span>:
</span><span class='line'>  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;  call _getchar&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;  movb %al, (%r12)&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>As usual, the looping constructs (<code>[</code> &amp; <code>]</code>) are much more work.  We have to
match up jumps to matching labels, but for an assembly program, labels must be
unique.  One way we can solve for this is whenever we encounter an opening
brace, push a monotonically increasing number that represents the numbers of
opening brackets we&rsquo;ve seen so far onto a stack like data structure.  Then, we
do our comparison and jump to what will be the label that should be produced by
the matching close label.  Next, we insert our starting label, and finally
increment the number of brackets seen.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="sc">&#39;[&#39;</span>:
</span><span class='line'>  <span class="n">stack_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stack</span><span class="p">,</span> <span class="n">num_brackets</span><span class="p">);</span>
</span><span class='line'>  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;  cmpb $0, (%r12)&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;  je bracket_%d_end</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num_brackets</span><span class="p">);</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;bracket_%d_start:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num_brackets</span><span class="o">++</span><span class="p">);</span>
</span><span class='line'>  <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>For close brackets, we pop the number of brackets seen (or rather, number of
pending open brackets which we have yet to see a matching close bracket) off of
the stack, do our comparison, jump to the matching start label, and finally
place our end label.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="sc">&#39;]&#39;</span>:
</span><span class='line'>  <span class="n">stack_pop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stack</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">matching_bracket</span><span class="p">);</span>
</span><span class='line'>  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;  cmpb $0, (%r12)&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;  jne bracket_%d_start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">matching_bracket</span><span class="p">);</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;bracket_%d_end:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">matching_bracket</span><span class="p">);</span>
</span><span class='line'>  <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>So for sequential loops (<code>[][]</code>) we can expect the relevant assembly to look
like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='gas'><span class='line'>  <span class="nf">cmpb</span> <span class="no">$0</span><span class="p">,</span> <span class="p">(</span><span class="nv">%r12</span><span class="p">)</span>
</span><span class='line'>  <span class="nf">je</span> <span class="no">bracket_0_end</span>
</span><span class='line'><span class="nl">bracket_0_start:</span>
</span><span class='line'>
</span><span class='line'>  <span class="nf">cmpb</span> <span class="no">$0</span><span class="p">,</span> <span class="p">(</span><span class="nv">%r12</span><span class="p">)</span>
</span><span class='line'>  <span class="nf">jne</span> <span class="no">bracket_0_start</span>
</span><span class='line'><span class="nl">bracket_0_end:</span>
</span><span class='line'>
</span><span class='line'>  <span class="nf">cmpb</span> <span class="no">$0</span><span class="p">,</span> <span class="p">(</span><span class="nv">%r12</span><span class="p">)</span>
</span><span class='line'>  <span class="nf">je</span> <span class="no">bracket_1_end</span>
</span><span class='line'><span class="nl">bracket_1_start:</span>
</span><span class='line'>
</span><span class='line'>  <span class="nf">cmpb</span> <span class="no">$0</span><span class="p">,</span> <span class="p">(</span><span class="nv">%r12</span><span class="p">)</span>
</span><span class='line'>  <span class="nf">jne</span> <span class="no">bracket_1_start</span>
</span><span class='line'><span class="nl">bracket_1_end:</span>
</span></code></pre></td></tr></table></div></figure>


<p>and for nested loops (<code>[[]]</code>), we can expect assembly like the following (note
the difference in the order of numbered start and end labels):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='gas'><span class='line'>  <span class="nf">cmpb</span> <span class="no">$0</span><span class="p">,</span> <span class="p">(</span><span class="nv">%r12</span><span class="p">)</span>
</span><span class='line'>  <span class="nf">je</span> <span class="no">bracket_0_end</span>
</span><span class='line'><span class="nl">bracket_0_start:</span>
</span><span class='line'>
</span><span class='line'>  <span class="nf">cmpb</span> <span class="no">$0</span><span class="p">,</span> <span class="p">(</span><span class="nv">%r12</span><span class="p">)</span>
</span><span class='line'>  <span class="nf">je</span> <span class="no">bracket_1_end</span>
</span><span class='line'><span class="nl">bracket_1_start:</span>
</span><span class='line'>
</span><span class='line'>  <span class="nf">cmpb</span> <span class="no">$0</span><span class="p">,</span> <span class="p">(</span><span class="nv">%r12</span><span class="p">)</span>
</span><span class='line'>  <span class="nf">jne</span> <span class="no">bracket_1_start</span>
</span><span class='line'><span class="nl">bracket_1_end:</span>
</span><span class='line'>
</span><span class='line'>  <span class="nf">cmpb</span> <span class="no">$0</span><span class="p">,</span> <span class="p">(</span><span class="nv">%r12</span><span class="p">)</span>
</span><span class='line'>  <span class="nf">jne</span> <span class="no">bracket_0_start</span>
</span><span class='line'><span class="nl">bracket_0_end:</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, we need an epilogue to clean up the stack and callee saved registers
after ourselves.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">epilogue</span> <span class="o">=</span>
</span><span class='line'>  <span class="s">&quot;  addq $30008, %rsp</span><span class="se">\n</span><span class="s">&quot;</span> <span class="c1">// clean up tape from stack.</span>
</span><span class='line'>  <span class="s">&quot;  popq %r12</span><span class="se">\n</span><span class="s">&quot;</span> <span class="c1">// restore callee saved register</span>
</span><span class='line'>  <span class="s">&quot;  popq %rbp</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>  <span class="s">&quot;  ret</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span class='line'><span class="n">puts</span><span class="p">(</span><span class="n">epilogue</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The compiler is a pain when modifying and running a Brainfuck
program; it takes a couple extra commands to compile the Brainfuck program to
assembly, assemble the assembly into an object file, link it into an
executable, and run it whereas with the interpreter we can just run it.  The
trade off is that the compiled version is quite a bit faster.  How much faster?
Let&rsquo;s save that for later.</p>

<p>Wouldn&rsquo;t it be nice if there was a translation &amp; execution technique that
didn&rsquo;t force us to compile our code every time we changed it and wanted to run
it, but also performed closer to that of compiled code?  That&rsquo;s where a JIT
compiler comes in!</p>

<p>For the basics of JITing code, make sure you read <a href="/blog/2013/04/03/basic-jit/">my previous article on the basics of JITing code in C</a>.  We&rsquo;re going to follow the same technique of
creating executable memory, copying bytes into that memory, casting it to a
function pointer, then calling it.  Just like the interpreter and the compiler,
we&rsquo;re going to do a unique action for each recognized token.  What&rsquo;s different is
that for each operator, we&rsquo;re going to push opcodes into a dynamic array, that
way it can grow based on our sequential reading of input and will simplify our calculation of relative offsets for branching operations.</p>

<p>The other special thing we&rsquo;re going to do it that we&rsquo;re going to pass
the address of our libc functions (memset, putchar, and getchar) into our
JIT&#8217;ed function at runtime.  This avoids those kooky stub functions you might
see in a disassembled executable.  That means we&rsquo;ll be invoking our JIT&#8217;ed
function like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">typedef</span> <span class="kt">void</span><span class="o">*</span> <span class="nf">fn_memset</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">);</span>
</span><span class='line'><span class="k">typedef</span> <span class="kt">int</span> <span class="nf">fn_putchar</span> <span class="p">(</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'><span class="k">typedef</span> <span class="kt">int</span> <span class="nf">fn_getchar</span> <span class="p">();</span>
</span><span class='line'><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">jitted_func</span><span class="p">)</span> <span class="p">(</span><span class="n">fn_memset</span><span class="p">,</span> <span class="n">fn_putchar</span><span class="p">,</span> <span class="n">fn_getchar</span><span class="p">)</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
</span><span class='line'><span class="n">jitted_func</span><span class="p">(</span><span class="n">memset</span><span class="p">,</span> <span class="n">putchar</span><span class="p">,</span> <span class="n">getchar</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Where mem is our mmap&#8217;ed executable memory with our opcodes copied into it, and
the typedef&rsquo;s are for the respective function signatures for our function
pointers we&rsquo;ll be passing to our JIT&#8217;ed code.  We&rsquo;re kind of getting ahead of
ourselves, but knowing how we will invoke the dynamically created executable
code will give us an idea of how the code itself will work.</p>

<p>The prologue is quite a bit involved, so we&rsquo;ll take it step at a time.  First,
we have the usual prologue:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">char</span> <span class="n">prologue</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="mh">0x55</span><span class="p">,</span> <span class="c1">// push rbp</span>
</span><span class='line'>  <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xE5</span><span class="p">,</span> <span class="c1">// mov rsp, rbp</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we want to back up our callee saved registers that we&rsquo;ll be using.  Expect horrific and difficult to debug bugs if you forget to do this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="c1">// pushq %r12</span>
</span><span class='line'>  <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="c1">// pushq %r13</span>
</span><span class='line'>  <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="c1">// pushq %r14</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this point, %rdi will contain the address of memset, %rsi will contain the
address of putchar, and %rdx will contain the address of getchar, see
<a href="/blog/2014/04/18/lets-write-some-x86-64/">x86-64 ABI point #2</a>.  We want to store these in callee saved registers before
calling any of them, else they may clobber %rdi, %rsi, or %rdx since they&rsquo;re
not &ldquo;callee saved,&rdquo; rather &ldquo;call clobbered.&rdquo;  See <a href="/blog/2014/04/18/lets-write-some-x86-64/">x86-64 ABI point #4</a>.</p>

<p><img class="center" src="/images/prologue1.png"></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="c1">// movq %rdi, %r12</span>
</span><span class='line'>  <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="c1">// movq %rsi, %r13</span>
</span><span class='line'>  <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xD6</span><span class="p">,</span> <span class="c1">// movq %rdx, %r14</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this point, %r12 will contain the address of memset, %r13 will contain the
address of putchar, and %r14 will contain the address of getchar.</p>

<p><img class="center" src="/images/prologue2.png"></p>

<p>Next up is allocating 30008 B on the stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// subq $30008, %rsp</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is our first hint at how numbers, whose value is larger than the maximum
representable value in a byte, are represented on x86-64.  Where in this
instruction is the value 30008?  The answer is the 4 byte sequence
<code>0x38, 0x75, 0x00, 0x00</code>.  The x86-64 architecture is &ldquo;Little Endian,&rdquo; which
means that the least significant bit (LSB) is first and the most significant
bit (MSB) is last.  When humans do math, they typically represent numbers the
other way, or “Big Endian.”  Thus we write decimal ten as &ldquo;10&rdquo; and not &ldquo;01.&rdquo;
So that means that <code>0x38, 0x75, 0x00, 0x00</code> in Little Endian is
<code>0x00, 0x00, 0x75, 0x38</code> in Big Endian, which then is
<code>7*16^3+5*16^2+3*16^1+8*16^0</code>
which is <code>30008</code> in decimal, the amount of bytes we want to subtract from the
stack. We&rsquo;re allocating an additional 8 B on the stack for alignment
requirements, similar to the compiler.  By pushing even numbers of 64 b
registers, we need to realign our stack pointer.</p>

<p><img class="center" src="/images/prologue3.png"></p>

<p>Next in the prologue, we set up and call memset:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="c1">// address of beginning of tape</span>
</span><span class='line'>  <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="c1">// leaq (%rsp), %rdi</span>
</span><span class='line'>  <span class="c1">// fill with 0&#39;s</span>
</span><span class='line'>  <span class="mh">0xBE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// movl $0, %esi</span>
</span><span class='line'>  <span class="c1">// length 30,000 B</span>
</span><span class='line'>  <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xC7</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// movq $30000, %rdx</span>
</span><span class='line'>  <span class="c1">// memset</span>
</span><span class='line'>  <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="c1">// callq *%r12</span>
</span></code></pre></td></tr></table></div></figure>


<p>After invoking memset, %rdi, %rsi, &amp; %rcx will contain garbage values since
they are &ldquo;call clobbered&rdquo; registers.  At this point we no longer need memset,
so we now use %r12 as our instruction pointer.  %rsp will point to the top
(technically the bottom) of the stack, which is the beginning of our memset&#8217;ed
tape.  That&rsquo;s the end of our prologue.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xE4</span> <span class="c1">// movq %rsp, %r12</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p><img class="center" src="/images/prologue4.png"></p>

<p>We can then push our prologue into our dynamic array implementation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">vector_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instruction_stream</span><span class="p">,</span> <span class="n">prologue</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">prologue</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we iterate over our Brainfuck program and switch on the operations again.
For pointer increment and decrement, we just nudge %r12.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="sc">&#39;&gt;&#39;</span>:
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">opcodes</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xC4</span> <span class="c1">// inc %r12</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="n">vector_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instruction_stream</span><span class="p">,</span> <span class="n">opcodes</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">opcodes</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="k">case</span> <span class="sc">&#39;&lt;&#39;</span>:
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">opcodes</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xCC</span> <span class="c1">// dec %r12</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="n">vector_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instruction_stream</span><span class="p">,</span> <span class="n">opcodes</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">opcodes</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>That extra fun block in the switch statement is because in C/C++, we <a href="http://stackoverflow.com/a/8550253/1027966">can&rsquo;t
define variables in the branches of switch statements</a>.</p>

<p>Pointer deref then increment/decrement are equally uninspiring:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="sc">&#39;+&#39;</span>:
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">opcodes</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xFE</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x24</span> <span class="c1">// incb (%r12)</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="n">vector_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instruction_stream</span><span class="p">,</span> <span class="n">opcodes</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">opcodes</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="k">case</span> <span class="sc">&#39;-&#39;</span>:
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">opcodes</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xFE</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x24</span> <span class="c1">// decv (%r12)</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="n">vector_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instruction_stream</span><span class="p">,</span> <span class="n">opcodes</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">opcodes</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>I/O might be interesting, but in x86-64 we have an opcode for calling the
function at the end of a pointer.  %r13 contains the address of putchar while
%r14 contains the address of getchar.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="sc">&#39;.&#39;</span>:
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">opcodes</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">,</span> <span class="mh">0xB6</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="c1">// movzbl (%r12), %edi</span>
</span><span class='line'>      <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xD5</span> <span class="c1">// callq *%r13</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="n">vector_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instruction_stream</span><span class="p">,</span> <span class="n">opcodes</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">opcodes</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="k">case</span> <span class="sc">&#39;,&#39;</span>:
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">opcodes</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xD6</span><span class="p">,</span> <span class="c1">// callq *%r14</span>
</span><span class='line'>      <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x24</span> <span class="c1">// movb %al, (%r12)</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="n">vector_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instruction_stream</span><span class="p">,</span> <span class="n">opcodes</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">opcodes</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now with our looping constructs, we get to the fun part.  With the compiler, we
deferred the concept of &ldquo;relocation&rdquo; to the assembler.  We simply emitted
labels, that the assembler turned into relative offsets (jumps by values
relative to the last byte in the jump instruction).  We&rsquo;ve found ourselves in a
Catch-22 though: how many bytes forward do we jump to the matching close
bracket that we haven&rsquo;t seen yet?</p>

<p>Normally, an assembler might have a data structure known as a
&ldquo;relocation table.&rdquo;  It keeps track of the first byte after a label and jumps,
rewriting jumps-to-labels (which aren&rsquo;t kept around in the resulting binary
executable) to relative jumps.  Spidermonkey, Firefox&rsquo;s JavaScript Virtual
Machine has two classes for this, <a href="http://mxr.mozilla.org/mozilla-central/source/js/src/jit/MacroAssembler.cpp">MacroAssembler</a> and <a href="http://mxr.mozilla.org/mozilla-central/source/js/src/jit/Label.h">Label</a>.  Spidermonkey
embeds a linked list in the opcodes it generates for jumps with which it&rsquo;s yet
to see a label for.  Once it finds the label, it walks the linked list (which
itself is embedded in the emitted instruction stream) patching up these
locations as it goes.</p>

<p>For Brainfuck, we don&rsquo;t have to anything quite as fancy since each label only
ends up having one jump site.  Instead, we can use a stack of integers that are
offsets into our dynamic array, and do the relocation once we know where
exactly we&rsquo;re jumping to.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="sc">&#39;[&#39;</span>:
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">opcodes</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// cmpb $0, (%r12)</span>
</span><span class='line'>      <span class="c1">// Needs to be patched up</span>
</span><span class='line'>      <span class="mh">0x0F</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="c1">// je &lt;32b relative offset, 2&#39;s compliment, LE&gt;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="n">vector_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instruction_stream</span><span class="p">,</span> <span class="n">opcodes</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">opcodes</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">stack_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">relocation_table</span><span class="p">,</span> <span class="n">instruction_stream</span><span class="p">.</span><span class="n">size</span><span class="p">);</span> <span class="c1">// create a label after</span>
</span><span class='line'>  <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>First we push the compare and jump opcodes, but for now we leave the relative
offset blank (four zero bytes).  We will come back and patch it up later.
Then, we push the current length of dynamic array, which just so happens to be
the offset into the instruction stream of the next instruction.</p>

<p>All of the relocation magic happens in the case for the closing bracket.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="sc">&#39;]&#39;</span>:
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">opcodes</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// cmpb $0, (%r12)</span>
</span><span class='line'>      <span class="c1">// Needs to be patched up</span>
</span><span class='line'>      <span class="mh">0x0F</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="c1">// jne &lt;33b relative offset, 2&#39;s compliment, LE&gt;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="n">vector_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instruction_stream</span><span class="p">,</span> <span class="n">opcodes</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">opcodes</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="c1">// ...</span>
</span></code></pre></td></tr></table></div></figure>


<p>First, we push our comparison and jump instructions into the dynamic array.
We should know the relative offset we need to jump back to at this point, and
thus don&rsquo;t need to push four empty bytes, but it makes the following math a
little simpler, as were not done yet with this case.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="c1">// ...</span>
</span><span class='line'>  <span class="n">stack_pop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">relocation_table</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">relocation_site</span><span class="p">);</span>
</span><span class='line'>  <span class="n">relative_offset</span> <span class="o">=</span> <span class="n">instruction_stream</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">relocation_site</span><span class="p">;</span>
</span><span class='line'>  <span class="c1">// ...</span>
</span></code></pre></td></tr></table></div></figure>


<p><img class="center" src="/images/relative_jump_unknown.png"></p>

<p>We pop the matching offset into the dynamic array (from the matching open
bracket), and calculate the difference from the current size of the instruction
stream to the matching offset to get our relative offset.  What&rsquo;s interesting
is that this offset is equal in magnitude for the forward and backwards jumps
that we now need to patch up.  We simply go back in our instruction stream 4 B,
and write that relative offset negated as a 32 b LE number (patching our
backwards jump), then go back to the site of our forward jump minus 4 B and
write that relative offset as a 32 b LE number (patching our forwards jump).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="c1">// ...</span>
</span><span class='line'>  <span class="n">vector_write32LE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instruction_stream</span><span class="p">,</span> <span class="n">instruction_stream</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="n">relative_offset</span><span class="p">);</span>
</span><span class='line'>  <span class="n">vector_write32LE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instruction_stream</span><span class="p">,</span> <span class="n">relocation_site</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="n">relative_offset</span><span class="p">);</span>
</span><span class='line'>  <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Thus, when writing a JIT, one must worry about manual relocation.  From the
<a href="http://www.intel.com/content/dam/www/public/us/en/documents/manuals/64-ia-32-architectures-software-developer-instruction-set-reference-manual-325383.pdf">Intel 64 and IA-32 Architectures Software Developer’s Manual Volume 2 (2A, 2B &amp; 2C): Instruction Set Reference, A-Z</a> &ldquo;A relative offset
(rel8, rel16, or rel32) is generally specified as a label in assembly code, but
at the machine code level, it is encoded as a signed, 8-bit or 32-bit immediate
value, which is added to the instruction pointer.&rdquo;</p>

<p>The last thing we push onto our instruction stream is clean up code in the
epilogue.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">char</span> <span class="n">epilogue</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0xC4</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// addq $30008, %rsp</span>
</span><span class='line'>  <span class="c1">// restore callee saved registers</span>
</span><span class='line'>  <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="c1">// popq %r14</span>
</span><span class='line'>  <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x5D</span><span class="p">,</span> <span class="c1">// popq %r13</span>
</span><span class='line'>  <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="c1">// popq %r12</span>
</span><span class='line'>  <span class="mh">0x5d</span><span class="p">,</span> <span class="c1">// pop rbp</span>
</span><span class='line'>  <span class="mh">0xC3</span> <span class="c1">// ret</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="n">vector_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instruction_stream</span><span class="p">,</span> <span class="n">epilogue</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">epilogue</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>A dynamic array of bytes isn&rsquo;t really useful, so we need to create executable
memory the size of the current instruction stream and copy all of the machine
opcodes into it, cast it to a function pointer, call it, and finally clean up:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">void</span><span class="o">*</span> <span class="n">mem</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">instruction_stream</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">PROT_WRITE</span> <span class="o">|</span> <span class="n">PROT_EXEC</span><span class="p">,</span>
</span><span class='line'>  <span class="n">MAP_ANON</span> <span class="o">|</span> <span class="n">MAP_PRIVATE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="n">memcpy</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">instruction_stream</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">instruction_stream</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
</span><span class='line'><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">jitted_func</span><span class="p">)</span> <span class="p">(</span><span class="n">fn_memset</span><span class="p">,</span> <span class="n">fn_putchar</span><span class="p">,</span> <span class="n">fn_getchar</span><span class="p">)</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
</span><span class='line'><span class="n">jitted_func</span><span class="p">(</span><span class="n">memcpy</span><span class="p">,</span> <span class="n">putchar</span><span class="p">,</span> <span class="n">getchar</span><span class="p">);</span>
</span><span class='line'><span class="n">munmap</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">instruction_stream</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
</span><span class='line'><span class="n">vector_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instruction_stream</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note: we could have used the instruction stream rewinding technique to move the address of memset, putchar, and getchar as 64 b immediate values into %r12-%r14, which would have <a href="https://github.com/nickdesaulniers/bf_interpreter_jit_compiler/pull/6/files">simplified our JIT&rsquo;d function&rsquo;s type signature</a>.</p>

<p>Compile that, and we now have <a href="https://github.com/nickdesaulniers/bf_interpreter_jit_compiler/blob/master/jit.c">a function that will JIT compile and execute Brainfuck in roughly 141 SLOC</a>.  And, we can make changes to our Brainfuck program and not have to recompile it like we did with the Brainfuck compiler.</p>

<p>Hopefully it&rsquo;s becoming apparent how similar an interpreter, compiler, and JIT
behave.  In the interpreter, we immediately execute some operation.  In the
compiler, we emit the equivalent text based assembly instructions corresponding
to what the higher level language might get translated to in the interpreter.
In the JIT, we emit the binary opcodes into executable memory and manually
perform relocation, where the binary opcodes are equivalent to the text based
assembly we might emit in the compiler.  A production ready JIT would probably have macros for each operation in the JIT would perform, so the code would look more like the compiler rather than raw arrays of bytes (though the preprocessor would translate those macros into such).  The entire process is basically disassembling C code with <code>gobjdump -S -M suffix a.out</code>, and punching in hex like one would a Gameshark.</p>

<p>Compare pointer incrementing from the three:</p>

<p>Interpreter:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="sc">&#39;&gt;&#39;</span>: <span class="o">++</span><span class="n">ptr</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Compiler:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="sc">&#39;&gt;&#39;</span>:
</span><span class='line'>  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;  inc %r12&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>JIT:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="sc">&#39;&gt;&#39;</span>:
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">opcodes</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xC4</span> <span class="c1">// inc %r12</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="n">vector_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instruction_stream</span><span class="p">,</span> <span class="n">opcodes</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">opcodes</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Or compare the full sources of the <a href="https://github.com/nickdesaulniers/bf_interpreter_jit_compiler/blob/master/interpreter.c">the interpreter</a>, <a href="https://github.com/nickdesaulniers/bf_interpreter_jit_compiler/blob/master/compiler.c">the compiler</a>, and <a href="https://github.com/nickdesaulniers/bf_interpreter_jit_compiler/blob/master/jit.c">the JIT</a>. Each at ~100 lines of code should be fairly easy to digest.</p>

<p>Let&rsquo;s now examine the performance of these three.  One of the longer running
Brainfuck programs I can find is <a href="https://github.com/nickdesaulniers/bf_interpreter_jit_compiler/blob/master/samples/mandelbrot.b">one that prints the Mandelbrot set as ASCII art to stdout</a>.</p>

<p><video width='' height='' preload='none' controls poster=''><source src='/video/jit.mp4 ' ></video></p>

<p>Running the UNIX command <code>time</code> on the interpreter, compiled
result, and the JIT, we should expect numbers similar to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="err">$</span> <span class="n">time</span> <span class="p">.</span><span class="o">/</span><span class="n">interpreter</span> <span class="p">..</span><span class="o">/</span><span class="n">samples</span><span class="o">/</span><span class="n">mandelbrot</span><span class="p">.</span><span class="n">b</span>
</span><span class='line'><span class="mf">43.54</span><span class="n">s</span> <span class="n">user</span> <span class="mf">0.03</span><span class="n">s</span> <span class="n">system</span> <span class="mi">99</span><span class="o">%</span> <span class="n">cpu</span> <span class="mf">43.581</span> <span class="n">total</span>
</span><span class='line'>
</span><span class='line'><span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">compiler</span> <span class="p">..</span><span class="o">/</span><span class="n">samples</span><span class="o">/</span><span class="n">mandelbrot</span><span class="p">.</span><span class="n">b</span> <span class="o">&gt;</span> <span class="n">temp</span><span class="p">.</span><span class="n">s</span><span class="p">;</span> <span class="p">..</span><span class="o">/</span><span class="n">assemble</span><span class="p">.</span><span class="n">sh</span> <span class="n">temp</span><span class="p">.</span><span class="n">s</span><span class="p">;</span> <span class="n">time</span> <span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span>
</span><span class='line'><span class="mf">3.24</span><span class="n">s</span> <span class="n">user</span> <span class="mf">0.01</span><span class="n">s</span> <span class="n">system</span> <span class="mi">99</span><span class="o">%</span> <span class="n">cpu</span> <span class="mf">3.254</span> <span class="n">total</span>
</span><span class='line'>
</span><span class='line'><span class="err">$</span> <span class="n">time</span> <span class="p">.</span><span class="o">/</span><span class="n">jit</span> <span class="p">..</span><span class="o">/</span><span class="n">samples</span><span class="o">/</span><span class="n">mandelbrot</span><span class="p">.</span><span class="n">b</span>
</span><span class='line'><span class="mf">3.27</span><span class="n">s</span> <span class="n">user</span> <span class="mf">0.01</span><span class="n">s</span> <span class="n">system</span> <span class="mi">99</span><span class="o">%</span> <span class="n">cpu</span> <span class="mf">3.282</span> <span class="n">total</span>
</span></code></pre></td></tr></table></div></figure>


<p>The interpreter is an order of magnitude slower than the compiled result or run
of the JIT.  Then again, the interpreter isn&rsquo;t able to jump back and forth as
efficiently as the compiler or JIT, since it scans back and forth for matching
brackets O(N), while the other two can jump to where they need to go in a few instructions O(1).  A production interpreter would probably translate the higher level language to a byte code, and thus be able to calculate the offsets used for jumps directly, rather than scanning back and forth.</p>

<p>The interpreter bounces back and forth between looking up an operation, then
doing something based on the operation, then lookup, etc..  The compiler and JIT preform the translation first, then the execution, not interleaving the two.</p>

<p>The compiled result is the fastest, as expected, since it doesn&rsquo;t have the
overhead the JIT does of having to read the input file or build up the
instructions to execute at runtime.  The compiler has read
and translated the input file ahead of time.</p>

<p>What if we take into account the
time it takes to compile the source code, and run it?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="err">$</span> <span class="n">time</span> <span class="p">(.</span><span class="o">/</span><span class="n">compiler</span> <span class="p">..</span><span class="o">/</span><span class="n">samples</span><span class="o">/</span><span class="n">mandelbrot</span><span class="p">.</span><span class="n">b</span> <span class="o">&gt;</span> <span class="n">temp</span><span class="p">.</span><span class="n">s</span><span class="p">;</span> <span class="p">..</span><span class="o">/</span><span class="n">assemble</span><span class="p">.</span><span class="n">sh</span> <span class="n">temp</span><span class="p">.</span><span class="n">s</span><span class="p">;</span> <span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span><span class="p">)</span>
</span><span class='line'><span class="mf">3.27</span><span class="n">s</span> <span class="n">user</span> <span class="mf">0.08</span><span class="n">s</span> <span class="n">system</span> <span class="mi">99</span><span class="o">%</span> <span class="n">cpu</span> <span class="mf">3.353</span> <span class="n">total</span>
</span></code></pre></td></tr></table></div></figure>


<p>Including the time it takes to compile the code then run it, the compiled
results are now slightly slower than the JIT (though I bet the multiple processes we start up are suspect), but with the JIT we pay the price
to compile each and every time we run our code.  With the compiler, we pay that
tax once.  When compilation time is cheap, as is the case with our Brainfuck
compiler &amp; JIT, it makes sense to prefer the JIT; it allows us to quickly make
changes to our code and re-run it.  When compilation is expensive, we might
only want to pay the compilation tax once, especially if we plan on running the
program repeatedly.</p>

<p>JIT&rsquo;s are neat but compared to compilers can be more complex to
implement.  They also repeatedly re-parse input files and re-build instruction
streams at runtime. Where they can shine is bridging the gap for dynamically
typed languages where the runtime itself is much more dynamic, and thus harder
(if not, impossible) to optimize ahead of time.  Being able to jump into JIT&rsquo;d
native code from an
interpreter and back gives you the best of both (interpreted and compiled)
worlds.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/22/public-key-crypto-code-example/">Hidden in Plain Sight - Public Key Crypto</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-22T11:48:00-08:00" pubdate data-updated="true">Feb 22<span>nd</span>, 2015</time>
        
         | <a href="/blog/2015/02/22/public-key-crypto-code-example/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>How is it possible for us to communicate securely when there&rsquo;s the possibility
of a third party eavesdropping on us?  How can we communicate private secrets
through public channels?  How do such techniques enable us to bank online and
carry out other sensitive transactions on the Internet while trusting numerous
relays?  In this post, I hope
to explain public key cryptography, with actual code examples, so that the
concepts are a little more concrete.</p>

<p>First, please check out this excellent video on public key crypto:</p>

<div class="embed-video-container"><iframe src="//www.youtube.com/embed/YEBfamv-_do" allowfullscreen></iframe></div>


<p>Hopefully that explains the gist of the technique, but what might it actually
look like in code?  Let&rsquo;s take a look at example code in JavaScript using the
Node.js crypto module.  We&rsquo;ll later compare the upcoming WebCrypto API and
look at a TLS handshake.</p>

<p>Meet Alice.  Meet Bob. Meet Eve.  Alice would like to send Bob a secret
message.  Alice would not like Eve to view the message.  Assume Eve can
intercept, but not tamper with, everything Alice and Bob try to share with each
other.</p>

<p>Alice chooses a modular exponential key group, such as modp4, then creates a
public and private key.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">group</span> <span class="o">=</span> <span class="s2">&quot;modp4&quot;</span><span class="p">;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">aliceDH</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">getDiffieHellman</span><span class="p">(</span><span class="nx">group</span><span class="p">);</span>
</span><span class='line'><span class="nx">aliceDH</span><span class="p">.</span><span class="nx">generateKeys</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>A modular exponential key group is simply a &ldquo;sufficiently large&rdquo; prime number,
paired with a generator (specific number), such as those defined in
<a href="http://tools.ietf.org/html/rfc2412">RFC2412</a> and
<a href="http://tools.ietf.org/html/rfc3526">RFC3526</a>.</p>

<p>The public key is meant to be shared; it is ok for Eve to know the public key.
The private key must not ever be shared, even with the person communicating to.</p>

<p>Alice then shares her public key and group with Bob.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">Public</span> <span class="nx">Key</span><span class="o">:</span>
</span><span class='line'> <span class="o">&lt;</span><span class="nx">Buffer</span> <span class="mi">96</span> <span class="mi">33</span> <span class="nx">c5</span> <span class="mi">9</span><span class="nx">e</span> <span class="nx">b9</span> <span class="mi">07</span> <span class="mi">3</span><span class="nx">e</span> <span class="nx">f2</span> <span class="nx">ec</span> <span class="mi">56</span> <span class="mi">6</span><span class="nx">d</span> <span class="nx">f4</span> <span class="mi">1</span><span class="nx">a</span> <span class="nx">b4</span> <span class="nx">f8</span> <span class="mi">4</span><span class="nx">c</span> <span class="mi">77</span> <span class="nx">e6</span> <span class="mi">5</span><span class="nx">f</span> <span class="nx">a0</span> <span class="mi">93</span> <span class="nx">cf</span> <span class="mi">32</span> <span class="nx">d3</span> <span class="mi">22</span> <span class="mi">42</span> <span class="nx">c8</span> <span class="nx">b4</span> <span class="mi">7</span><span class="nx">b</span> <span class="mi">2</span><span class="nx">b</span> <span class="mi">1</span><span class="nx">f</span> <span class="nx">a9</span> <span class="mi">55</span> <span class="mi">86</span> <span class="mi">05</span> <span class="nx">a4</span> <span class="mi">60</span> <span class="mi">17</span> <span class="nx">ae</span> <span class="nx">f9</span> <span class="nx">ee</span> <span class="nx">bf</span> <span class="nx">b3</span> <span class="nx">c9</span> <span class="mi">05</span> <span class="nx">a9</span> <span class="mi">31</span> <span class="mi">31</span> <span class="mi">94</span> <span class="mi">0</span><span class="nx">f</span> <span class="p">...</span> <span class="o">&gt;</span>
</span><span class='line'><span class="nx">Group</span><span class="o">:</span>
</span><span class='line'> <span class="nx">modp14</span>
</span></code></pre></td></tr></table></div></figure>


<p>Bob now creates a public and private key pair with the same group as Alice.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">bobDH</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">getDiffieHellman</span><span class="p">(</span><span class="nx">group</span><span class="p">);</span>
</span><span class='line'><span class="nx">bobDH</span><span class="p">.</span><span class="nx">generateKeys</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Bob shares his public key with Alice.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">Public</span> <span class="nx">key</span><span class="o">:</span>
</span><span class='line'> <span class="o">&lt;</span><span class="nx">Buffer</span> <span class="nx">ee</span> <span class="nx">d7</span> <span class="nx">e2</span> <span class="mi">00</span> <span class="nx">e5</span> <span class="mi">82</span> <span class="mi">11</span> <span class="nx">eb</span> <span class="mi">67</span> <span class="nx">ab</span> <span class="mi">50</span> <span class="mi">20</span> <span class="mi">30</span> <span class="mi">81</span> <span class="nx">b1</span> <span class="mi">74</span> <span class="mi">7</span><span class="nx">a</span> <span class="mi">51</span> <span class="mi">0</span><span class="nx">d</span> <span class="mi">7</span><span class="nx">e</span> <span class="mi">2</span><span class="nx">a</span> <span class="nx">de</span> <span class="nx">b7</span> <span class="nx">df</span> <span class="nx">db</span> <span class="nx">cf</span> <span class="nx">ac</span> <span class="mi">57</span> <span class="nx">de</span> <span class="nx">a4</span> <span class="nx">f0</span> <span class="nx">bd</span> <span class="nx">bc</span> <span class="nx">b5</span> <span class="mi">7</span><span class="nx">e</span> <span class="nx">ea</span> <span class="nx">df</span> <span class="nx">b0</span> <span class="mi">3</span><span class="nx">b</span> <span class="nx">c3</span> <span class="mi">3</span><span class="nx">a</span> <span class="nx">e2</span> <span class="nx">fa</span> <span class="mi">0</span><span class="nx">e</span> <span class="nx">ed</span> <span class="mi">22</span> <span class="mi">90</span> <span class="mi">31</span> <span class="mi">01</span> <span class="mi">67</span> <span class="p">...</span> <span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Alice and Bob now compute a shared secret.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">aliceSecret</span> <span class="o">=</span> <span class="nx">aliceDH</span><span class="p">.</span><span class="nx">computeSecret</span><span class="p">(</span><span class="nx">bobDH</span><span class="p">.</span><span class="nx">getPublicKey</span><span class="p">(),</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;hex&quot;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">bobSecret</span> <span class="o">=</span> <span class="nx">bobDH</span><span class="p">.</span><span class="nx">computeSecret</span><span class="p">(</span><span class="nx">aliceDH</span><span class="p">.</span><span class="nx">getPublicKey</span><span class="p">(),</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;hex&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Alice and Bob have now derived a shared secret from each others&#8217; public keys.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">aliceSecret</span> <span class="o">===</span> <span class="nx">bobSecret</span><span class="p">;</span> <span class="c1">// =&gt; true</span>
</span></code></pre></td></tr></table></div></figure>


<p>Meanwhile, Eve has intercepted Alice and Bob&rsquo;s public keys and group.  Eve
tries to compute the same secret.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">eveDH</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">getDiffieHellman</span><span class="p">(</span><span class="nx">group</span><span class="p">);</span>
</span><span class='line'><span class="nx">eveDH</span><span class="p">.</span><span class="nx">generateKeys</span><span class="p">();</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">eveSecret</span> <span class="o">=</span> <span class="nx">eveDH</span><span class="p">.</span><span class="nx">computeSecret</span><span class="p">(</span><span class="nx">aliceDH</span><span class="p">.</span><span class="nx">getPublicKeys</span><span class="p">(),</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;hex&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">eveSecret</span> <span class="o">===</span> <span class="nx">aliceSecret</span><span class="p">;</span> <span class="c1">// =&gt; false</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is because Alice&rsquo;s secret is derived from Alice and Bob&rsquo;s private keys,
which Eve does not have.  Eve may not realize her secret is not the same as
Alice and Bob&rsquo;s until later.</p>

<p>That was asymmetric encryption; using different keys.  The shared secret may
now be used in symmetric encryption; using the same keys.</p>

<p>Alice creates a symmetric block cypher using her favorite algorithm, a hash of
their secret as a key, and random bytes as an initialization vector.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">cypher</span> <span class="o">=</span> <span class="s2">&quot;aes-256-ctr&quot;</span><span class="p">;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">hash</span> <span class="o">=</span> <span class="s2">&quot;sha256&quot;</span><span class="p">;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">aliceIV</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">aliceHashedSecret</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="nx">hash</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="nx">aliceSecret</span><span class="p">).</span><span class="nx">digest</span><span class="p">(</span><span class="s2">&quot;binary&quot;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">aliceCypher</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createCypher</span><span class="p">(</span><span class="nx">cypher</span><span class="p">,</span> <span class="nx">aliceHashedSecret</span><span class="p">,</span> <span class="nx">aliceIV</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Alice then uses her cypher to encrypt her message to Bob.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">cypherText</span> <span class="o">=</span> <span class="nx">aliceCypher</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Alice then sends the cypher text, cypher, and hash to Bob.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">cypherText</span><span class="o">:</span>
</span><span class='line'> <span class="o">&lt;</span><span class="nx">Buffer</span> <span class="nx">bd</span> <span class="mi">29</span> <span class="mi">96</span> <span class="mi">83</span> <span class="nx">fa</span> <span class="nx">a8</span> <span class="mi">7</span><span class="nx">d</span> <span class="mi">9</span><span class="nx">c</span> <span class="nx">ea</span> <span class="mi">90</span> <span class="nx">ab</span><span class="o">&gt;</span>
</span><span class='line'><span class="nx">cypher</span><span class="o">:</span>
</span><span class='line'> <span class="nx">aes</span><span class="o">-</span><span class="mi">256</span><span class="o">-</span><span class="nx">ctr</span>
</span><span class='line'><span class="nx">hash</span><span class="o">:</span>
</span><span class='line'> <span class="nx">sha256</span>
</span></code></pre></td></tr></table></div></figure>


<p>Bob now constructs a symmetric block cypher using the algorithm from Alice,
and a hash of their shared secret.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">bobHashedSecret</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="nx">hash</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="nx">bobSecret</span><span class="p">).</span><span class="nx">digest</span><span class="p">(</span><span class="s2">&quot;binary&quot;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">bobCypher</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createDecipher</span><span class="p">(</span><span class="nx">cypher</span><span class="p">,</span> <span class="nx">bobHashedSecret</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Bob now decyphers the encrypted message (cypher text) from Alice.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">plainText</span> <span class="o">=</span> <span class="nx">bobCypher</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">cypherText</span><span class="p">);</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">plainText</span><span class="p">);</span> <span class="c1">// =&gt; &quot;I love you&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Eve has intercepted the cypher text, cypher, hash, and tries to decrypt it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">eveHashedSecret</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="nx">hash</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="nx">eveSecret</span><span class="p">).</span><span class="nx">digest</span><span class="p">(</span><span class="s2">&quot;binary&quot;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">eveCypher</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createDecipher</span><span class="p">(</span><span class="nx">cypher</span><span class="p">,</span> <span class="nx">eveHashedSecret</span><span class="p">);</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">eveCypher</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">cypherText</span><span class="p">).</span><span class="nx">toString</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// =&gt; ��_r](�i)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here&rsquo;s where Eve realizes her secret is not correct.</p>

<p>This prevents passive eavesdropping, but not active man-in-the-middle (MITM)
attacks.  For example, how does Alice know that the messages she was supposedly
receiving from Bob actually came from Bob, not Eve posing as Bob?</p>

<p>Today, we use a system of certificates to provide authentication.  This system
certainly <a href="http://thenextweb.com/insider/2015/02/19/lenovo-caught-installing-adware-new-computers/">has</a> its
<a href="https://deadbeefsec.wordpress.com/2012/09/30/who-do-you-trust-why-certificate-authorities-are-a-cartel/">flaws</a>,
but it is what we use today.  This is more advanced topic that won&rsquo;t be covered
here.  Trust is a funny thing.</p>

<p>What&rsquo;s interesting to note is that the prime and generator used to generate
Diffie-Hellman public and private keys have strings that represent the
corresponding modular key exponential groups, ie &ldquo;modp14&rdquo;.  Web crypto&rsquo;s API
gives you
<a href="https://hg.mozilla.org/mozilla-central/file/d866ac7f8606/dom/crypto/test/test_WebCrypto_DH.html#l30">finer grain control</a>
to specify the generator and
<a href="https://hg.mozilla.org/mozilla-central/file/d866ac7f8606/dom/crypto/test/test-vectors.js#l662">large prime number</a>
in a Typed Array.  I&rsquo;m not sure why this is; if it allows you to have finer
grain control, or allows you to support newer groups before the implementation
does?  To me, it seems like a source for errors to be made; hopefully someone
will make a library to provide these prime/generator pairs.</p>

<p>One issue with my approach is that I assumed that Alice and Bob both had
support for the same hashing algorithms, modular exponential key group, and
symmetric block cypher.  In the real world, this is not always the case.
Instead, it is much more common for the client to broadcast publicly all of the
algorithms it supports, and the server to pick one.  This list of algorithms is
called a &ldquo;suite,&rdquo; ie &ldquo;cypher suit.&rdquo; I learned this the hard way recently trying
to
<a href="https://stribika.github.io/2015/01/04/secure-secure-shell.html">upgrade</a>
the <a href="https://wiki.mozilla.org/Security/Guidelines/OpenSSH">cypher suit</a>
on my ssh server and finding out that
<a href="https://mochtu.de/2015/01/07/updating-openssh-on-mac-os-x-10-10-yosemite/">my client did not support the lastest cyphers</a>. In this case, Alice and Bob might not have the same
versions of Node.js, which statically link their own versions of OpenSSL. Thus,
one should use <code>cryto.getCiphers()</code> and <code>crypto.getHashes()</code> before assuming
the party they&rsquo;re communicating to can do the math to decrypt. We&rsquo;ll see &ldquo;cypher
suites&rdquo; come up again in TLS handshakes. The NSA
<a href="http://en.wikipedia.org/wiki/NSA_Suite_B_Cryptography">publishes a list of endorsed cryptographic components</a>,
for what it&rsquo;s worth.  There are also neat tricks we can do to prevent the
message from being decrypted at a later time should the private key be
compromised and encrytped message recorded, called Perfect Forward Secrecy.</p>

<p>Let&rsquo;s take a look now at how a browser does a TLS handshake.  Here&rsquo;s a
capture from Wireshark of me navigating to <a href="https://google.com.">https://google.com.</a> First we have a
TLSv1.2 Client Hello to start the handshake.  Here we can see a list of the
cypher suites.</p>

<p><img class="center" src="/images/tls_1_client_hello.png"></p>

<p>Next is the response from the server, a TLSv1.2 Server Hello.  Here you can see
the server has picked a cypher to use.</p>

<p><img class="center" src="/images/tls_2_server_hello.png"></p>

<p>The server then sends its certificate, which contains a copy of its public key.</p>

<p><img class="center" src="/images/tls_3_server_cert.png"></p>

<p>Now that we&rsquo;ve agreed on a cypher suite, the client now sends its public key.
The server sets up a session, that way it may abbreviate the handshake in the
future. Finally, the client may now start making requests to the server with
encrypted application data.</p>

<p><img class="center" src="/images/tls_4_key_exchange.png"></p>

<p>For more information on TLS handshakes, you should read
<a href="https://www.igvita.com/">Ilya Grigorik&rsquo;s</a>
High Performance Browser Networking book chapter
<a href="http://chimera.labs.oreilly.com/books/1230000000545/ch04.html#TLS_HANDSHAKE">TLS Handshake</a>,
<a href="https://wiki.mozilla.org/Security/Server_Side_TLS#DHE_handshake_and_dhparam">Mozilla OpSec&rsquo;s fantastic wiki</a>,
and
<a href="http://security.stackexchange.com/questions/20803/how-does-ssl-tls-work/20833">this exellent Stack Exchange post</a>.
As you might imagine, all of these back and forth trips made during the TLS
handshake add latency overhead when compared to unencrypted HTTP requests.</p>

<p>I hope this post helped you understand how we can use cryptography to exchange
secret information through public channels.  This isn&rsquo;t enough information to
implement a perfectly secure system; end to end security means one single
mistake can compromise the entire system.  Peer review and open source,
<a href="https://danielmiessler.com/writing/cryptography_opensource/">battle tested</a>
implementations
<a href="http://dodcio.defense.gov/OpenSourceSoftwareFAQ.aspx#Q%3a_Doesn.27t_hiding_source_code_automatically_make_software_more_secure.3F">go a long way</a>.</p>

<blockquote><p>A cryptosystem should be secure even if everything about the system, except the key, is public knowledge.</p><footer><strong>Kerckhoffs&#8217;s principle</strong></footer></blockquote>


<p>I wanted to write this post because I believe abstinence-only crypto education
isn&rsquo;t working and I cant stand when anyone acts like part of a cabal from their
ivory tower to those trying to learn new things.
Someone will surely cite
<a href="http://matasano.com/articles/javascript-cryptography/">Javascript Cryptography Considered Harmful</a>,
which while valid, misses my point of simply trying to show people more concrete
basics with code examples.
The first crypto system you implement will have its holes, but you
can&rsquo;t go from ignorance of crypto to perfect knowledge without implementing a
few imperfect systems.  Don&rsquo;t be afraid to, just don&rsquo;t start with trying to protect
high value data.  Crypto is dangerous, because it can be difficult to
impossible to tell when your system fails.
<a href="https://nickdesaulniers.github.io/blog/2014/04/18/lets-write-some-x86-64/">Assembly</a>
is also akin to juggling knives, but at least
you&rsquo;ll usually segfault if you mess up and program execution will halt.</p>

<p>With upcoming APIs like
<a href="http://www.w3.org/TR/service-workers/#security-considerations">Service Workers requiring TLS</a>,
protocols like <a href="http://http2.github.io/faq/#does-http2-require-encryption">HTTP2</a>,
pushes for all <a href="http://blog.codinghorror.com/should-all-web-traffic-be-encrypted/">web traffic to be encrypted</a>,
and <a href="https://nickdesaulniers.github.io/blog/2013/07/03/why-ill-be-marching-this-4th/">shitty things governments</a>,
<a href="http://www.theguardian.com/technology/2015/jan/16/david-cameron-encryption-lavabit-ladar-levison">politicians</a>,
and <a href="https://www.youtube.com/watch?v=fpbOEoRrHyU">ISPs</a> do,
web developers are going to have to start boning up on their crypto knowledge.</p>

<p>What are your recommendations for correctly learning crypto?  Leave me some
thoughts in the comments below.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/01/25/writing-my-first-book-chapter/">Writing My First Technical Book Chapter</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-01-25T20:50:00-08:00" pubdate data-updated="true">Jan 25<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/01/25/writing-my-first-book-chapter/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It&rsquo;s a feeling of immense satisfaction when we complete a major achievement.
Being able to say &ldquo;it&rsquo;s done&rdquo; is such a great stress relief.  Recently, I
completed work on my first publication, a chapter about Emscripten for the
upcoming book
<a href="http://www.crcpress.com/product/isbn/9781498716079">WebGL Insights</a>
to be published by CRC Press in time for
<a href="http://s2015.siggraph.org/">SIGGRAPH 2015</a>.</p>

<p>One of the life goals I&rsquo;ve had for a while is writing a book.  A romantic idea
it seems to have your ideas transcribed to a medium that will outlast your
bones.  It&rsquo;s enamoring to hold books from long dead authors, and see that their
ideas are still valid and powerful.  Being able to write a book, in my eyes,
provides some form of life after death.  Though, one could imagine ancestors
reading blog posts from long dead relatives via utilities like the
<a href="https://web.archive.org/web/20141218200253/http://nickdesaulniers.github.io/">Internet Archive&rsquo;s WayBack Machine</a>.</p>

<p>Writing about highly technical content places an upper limit on the usefulness
of the content, and shows as &ldquo;dated&rdquo; quickly.  A book I recently ordered was
<a href="http://shop.oreilly.com/product/0636920033707.do">Scott Meyers&#8217; Effective Modern C++</a>.
This title strikes me, because what
exactly do we consider <em>modern</em> or <em>contemporary</em>?  Those adjectives only make
sense in a time limited context.  When C++ undergoes another revolution,
Scott&rsquo;s book may become irrelevant, at which point the adjective <em>modern</em>
becomes incorrect.  Not that I think Scott&rsquo;s book or my own is time-limited in
usefulness; more that technical books&#8217; duration of usefulness is significantly
less than philosophical works like <em>1984</em> or <em>Brave New World</em>.  Almost like having
a record in a sport is a feather in one&rsquo;s cap, until the next best thing comes
along and you&rsquo;re forgotten to time.</p>

<p>Somewhat short of my goal of writing an entire book, I only wrote a single
chapter for a book.  It&rsquo;s interesting to see that a lot of graphics programming
books seem to follow the format of one author per chapter or at least multiple
authors.  Such book series as <em>GPU Gems</em>, <em>Shader X</em>, and <em>GPU Pro</em> follow this
pattern, which is interesting.  After seeing how much work goes into one
chapter, I think I&rsquo;m content with not writing an entire book, though I may
revisit that decision later in life.</p>

<p>How did this all get started?  I had followed Graham Sellers on Twitter and saw
<a href="http://octopress.org/2015/01/15/octopress-3.0-is-coming/">a tweet from him</a>
about a call to authors for WebGL Insights.  Explicitly in the linked to page
under the call for authors was interest in proposals about Emscripten and
asm.js.</p>

<p><a href="https://twitter.com/grahamsellers/status/504974663848456193">Tweet</a></p>

<p>At the time, I was headlong into a project helping Disney port Where&rsquo;s My Water
from C++ to JavaScript using Emscripten.  I was intimately familiar with
Emscripten, having been trained by one of its most prolific contributors,
<a href="http://clb.demon.fi/">Jukka Jylänki</a>.
Also, Emscripten&rsquo;s creator,
<a href="http://mozakai.blogspot.com/">Alon Zakai</a>, sat on the other side
of the office from me, so I was constantly pestering him about how to do
different things with Emscripten.  The #emscripten irc channel on
irc.mozilla.org is very active, but there&rsquo;s no substitute for being able to
have a second pair of eyes look over your shoulder when something is going
wrong.</p>

<p>Knowing Emscripten&rsquo;s strengths and limitations, seeing interest in the subject
I knew a bit about (but wouldn&rsquo;t consider myself an expert in), and having the
goal of writing something to be published in book form, this was my opportunity
to seize.</p>

<p>I wrote up a quick proposal with a few figures about why Emscripten was
important and how it worked, and sent it off with fingers crossed.  Initially,
I was overjoyed to learn when my proposal was accepted, but then there was a
slow realization that I had a lot of work to do.  The editor,
<a href="http://www.seas.upenn.edu/~pcozzi/">Patrick Cozzi</a>, set up
<a href="https://github.com/WebGLInsights/WebGLInsights-1">a GitHub repo</a>
for our additional code and figures, a mailing
list, and sent us a chapter template document detailing the process.  We had 6
weeks to write the rough draft, then 6 weeks to work with reviewers to get the
chapter done.  The chapter was written as a Google Doc, so that we could have
explicit control over who we shared the document with, and what kinds of
editing power they had over the document.  I think this approach worked well.</p>

<p>I had most of the content written by week 2.  This was surprising to me,
because I&rsquo;m a heavy procrastinator.  The only issue was that the number of
pages I wrote was double the allowed amount; way over page count.  I was
worried about the amount of content, but told myself to try not to be attached
to the content, just as you shouldn&rsquo;t stay attached with your code.</p>

<p>I took the additional 4 weeks I had left to finish the rough draft to invite
some of my friends and coworkers to provide feedback.  It&rsquo;s useful to have a
short list of people who have ever offered to help in this regard or owe you
one.  You&rsquo;ll also want a diverse team of reviewers that are either close to the
subject matter, or approaching it as new information.  This allows you to stay
technically correct, while not presuming your readers know everything that you
do.</p>

<p>The strategy worked out well; some of the content I had initially written about
how JavaScript VMs and JITs speculate types was straight up wrong.  While it
played nicely into the narrative I was weaving, someone more well versed in
JavaScript virtual machines would be able to call BS on my work.  The reviewers
who weren&rsquo;t as close to subject matter were able to point out when logical
progressions did not follow.</p>

<p>Fear of being publicly corrected prevents a lot of people from blogging or
contributing to open source.  It&rsquo;s important to not stay attached to your work,
especially when you need to make cuts.  When push came to shove, I did have
difficulty removing sections.</p>

<p>Lets say you have three sequential sections: A, B, &amp; C.  If section A and
section B both set up section C, and someone tells you section B has to go, it
can be difficult to cut section B because as the author you may think it&rsquo;s
really important to include B for the lead into C.  My recommendation is sum up
the most important idea from section B and add it to the end of section A.</p>

<p>For the last six weeks, the editor, some invited third parties, and other
authors reviewed my chapter.  It was great that others even followed along and
pointed out when I was making assumptions based on specific compiler or
browser.
<a href="http://erich.realtimerendering.com/">Eric Haines</a> even reviewed my chapter!
That was definitely a highlight for me.</p>

<p>We used a Google Sheet to keep track of the state of reviews.  Reviewers were
able to comment on sections of the chapter.  What was nice was that you were
able to keep using the comment as a thread, responding directly to a
criticism.  What didn&rsquo;t work so well was then once you edited that line, the
comment and thus the thread was lost.</p>

<p>Once everything was done, we zipped up the assets to be used as figures,
submitted bios, and wrote a tips and tricks section.  Now, it&rsquo;s just a long
waiting game until the book is published.</p>

<p>As far as dealing with the publisher, I didn&rsquo;t have much interaction.  Since
the book was assembled by a dedicated editor, Patrick did most of the leg work.
I only asked that what royalties I would receive be donated to Mozilla, which
the publisher said would be too small (est $250) to be worth the paperwork.  It
would be against my advice if you were thinking of writing a technical book for
the sole reason of monetary benefit.  I&rsquo;m excited to be receiving a hard cover
copy of the book when it&rsquo;s published.  I&rsquo;ll also have to see if I can find my
way to SIGGRAPH this year; I&rsquo;d love to meet my fellow authors in person and
potential readers.  Just seeing the list of authors was really a who&rsquo;s-who of
folks doing cool WebGL stuff.</p>

<p>If you&rsquo;re interested in learning more about working with Emscripten, asm.js,
and WebGL, I sugguest you pick up a copy of WebGL Insights in August when it&rsquo;s
published.  A big thank you to my reviewers: Eric Haines, Havi Hoffman,
Jukka Jylänki, Chris Mills, Traian Stanev, Luke Wagner, and Alon Zakai.</p>

<p>So that was a little bit about my first experience with authorship.  I&rsquo;d be
happy to follow up with any further questions you might have for me.  Let me
know in the comments below, on Twitter, HN, or wherever and I&rsquo;ll probably find
it!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/18/lets-write-some-x86-64/">Let&#8217;s Write Some X86-64</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-18T16:16:00-07:00" pubdate data-updated="true">Apr 18<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/04/18/lets-write-some-x86-64/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p>&#8230;&#8220;&#8216;Our speech interposes itself between apprehension and truth like a dusty pane or warped mirror.  The tongue of Eden was like a flawless glass; a light of total understanding streamed through it.  Thus Babel was a second Fall.&#8217; And Isaac the Blind, an early Kabbalist, said that, to quote Gershom Scholem&#8217;s translation, &#8216;The speech of men is connected with divine speech and all language whether heavenly or human derives from one source: the Divine Name.&#8217; The practical kabbalists, the sorcerers, bore the title Ba&#8217;al Shem, meaning &#8216;master of the divine name.&#8217;&#8221;</p><p>&#8220;The machine language of the world,&#8221; Hiro says.</p><p>&#8220;Is this another analogy?&#8221;</p><p>&#8220;Computers speak machine language,&#8221; Hiro says.  &#8220;It&#8217;s written in ones and zeroes - binary code.  At the lowest level, all computers are programmed with strings of ones and zeroes.  When you program in machine language, you are controlling the computer at its brainstem, the root of its existence.  It&#8217;s the tongue of Eden.  But it&#8217;s very difficult to work in machine language because you go crazy after a while, working at such a minute level.  So a whole Babel of computer languages has been created for programmers: FORTRAN, BASIC, COBOL, LISP, Pascal, C, PROLOG, FORTH.  You talk to the computer in one of these languages, and a piece of software called a compiler converts it into machine language.  But you never can tell exactly what the compiler is doing.  It doesn&#8217;t always come out the way you want.  Like a dusty pane or warped mirror. A really advanced hacker comes to understand the true inner workings of the machine – he sees through the language he&#8217;s working in and glimpses the secret functioning of the binary code – becomes a Ba&#8217;al Shem of sorts.&#8221;</p><footer><strong>Hiro Protagonist and The Librarian</strong> <cite>Snow Crash by Neal Stephenson</cite></footer></blockquote>


<p>This a beautiful quote, one that I think truly captures the relationship between
higher level languages and the Instruction Set Architecture (ISA)&rsquo;s machine
code, though this is from the angle of controlling the machine with its
implementation specific quirks which can detract from what you&rsquo;re actually
trying to do.</p>

<p>This blog is meant for those who don&rsquo;t know x86-64 assembly, but maybe know a
little C, and are curious about code generation.  Or maybe if you&rsquo;ve ever tried
to hand write x86-64 assembly, and got stuck trying to understand the tooling or
seemingly random segfaults from what appears to be valid instructions.</p>

<p>I really enjoy writing code in CoffeeScript
and C, so I have a quick anecdote about CoffeeScript though you don&rsquo;t need to
know the language.  When writing CoffeeScript, I find myself frequently using a
<a href="https://github.com/kchmck/vim-coffee-script">vim plugin</a>
to view the emitted JavaScript.  I
<strong>know</strong> when CoffeeScript emits less than optimal JavaScript.  For example in
the code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">nick = </span><span class="nf">-&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">x</span> <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">100</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>I know that CoffeeScript is going to push the results of the call to
<code>console.log</code> into an array
and return that, because of the implicit return of the final expression in a
function body, which in this case happens to be a for loop (array comprehension
being treated itself as an expression).  The emitted JavaScript looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">nick</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">nick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_results</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">_results</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">x</span> <span class="o">=</span> <span class="o">++</span><span class="nx">_i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">_results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">_results</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>By putting a seemingly meaningless undefined statement as the final statement in
the function body, we can significantly reduce what the function is doing and
decrease the number of allocations:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">nick = </span><span class="nf">-&gt;</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">x</span> <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">100</span><span class="p">]</span>
</span><span class='line'>  <span class="kc">undefined</span>
</span></code></pre></td></tr></table></div></figure>


<p>emits:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">nick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">_i</span><span class="p">;</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">x</span> <span class="o">=</span> <span class="o">++</span><span class="nx">_i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">void</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>That <code>return void 0</code> may seem odd, but functions in JavaScript without an
explicit return value return <code>undefined</code>, but since the <code>undefined</code> identifier
can be reassigned to, the expression <code>void 0</code>
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/void">evaluates to the value</a>
<code>undefined</code>.</p>

<p>You can see that making the CoffeeScript function body slightly longer and
adding a seemingly meaningless lone undefined statement at the end of the
function body, the emitted JavaScript does not allocate an array or waste time
pushing the results of <code>console.log</code>, which would be <code>undefined</code>, into that
array a hundred times.  This reminds me of how seemingly meaningless noop
instructions can keep a processor&rsquo;s pipeline full by preventing stalls, though
a pipeline stall doesn&rsquo;t change the correctness of a program, so it&rsquo;s an
imperfect analogy.</p>

<p>Now I&rsquo;m not saying that you should be thinking about these kinds of
optimizations when programming at such a high level, as they might be premature.
I shared with you this example because while writing C code, and reading
<a href="http://www.drdobbs.com/parallel/graphics-programming-black-book/184404919">Michael Abrash&rsquo;s Graphics Programming Black Book</a>,
<em>I wondered to myself if hardcore C
programmers also would know the equivalent assembly instructions that would be
emitted from their higher level C code</em> (before optimizing compilers even
existed).</p>

<p>In college, I was taught 68k and MIPS ISAs.
To understand x86-64 we need to be able to write and run it.
Unfortunately, I did not have the training to know how to do so.  My 68k code
was run on a MCU from a FreeScale IDE in Windows, so the process might as well
have been indistinguishable from magic to me.  I understood that you&rsquo;d start
with low level source, in (somewhat) human readable instructions that would be
converted to binary representing op codes.  The assembler would then translate
the assembly into non-executable object files that contained binary code that
had placeholders for sections of code defined in other object files.  The linker
would then be used to replace the placeholders with the now combined binary
code&rsquo;s relative positions and then converted into an executable.  But how do I
do this from my x86-64 machine itself?  The goto book I&rsquo;ve been recommended many
times is
<a href="http://www.wrox.com/WileyCDA/WroxTitle/productCd-0764579010.html">Professional Assembly Language by Richard Blum</a>,
but this book only
covers x86, not x86-64.  There&rsquo;s been some very big changes to the ABI between
x86 and x86-64.  You may be familiar with Application Programmer Interfaces
(<a href="http://en.wikipedia.org/wiki/Api">APIs</a>),
but what is an
<a href="http://en.wikipedia.org/wiki/Application_binary_interface">Application Binary Interface</a>?
I think of an ABI as how
two pieces of native code interact with one another, such as calling convention
(how arguments are passed to functions at the ISA level).</p>

<p>I&rsquo;m very lucky to have the privilege to work with a compiler engineer, Dan Gohman,
who has worked on a variety of compilers.  I was citing a
<a href="http://lists.cs.uiuc.edu/pipermail/llvmdev/2011-October/043719.html">particular email of Dan</a>&rsquo;s
for some time before he came to work with us, when I
would talk about how the naming of LLVM gives the imagery of a virtual machine,
though it&rsquo;s more so a compiler intermediate representation.  Dan is an amazing
and patient resource who has helped me learn more about the
subtleties of the x86-64 ABI.  Throughout this blog, I&rsquo;ll copy some responses to
questions I&rsquo;ve had answered by Dan.</p>

<p>Our first goal is to write an x86-64 program that does nothing, but that we can
build.  Assembly files typically have the .s file extension, so let&rsquo;s fire up
our text editor and get started.  I&rsquo;ll be doing my coding from OSX 10.8.5, but
most examples will work from Linux.  All of my symbol names, like _main, _exit,
and _printf, are prefixed with
underscores, as Darwin requires. Most Linux systems don&rsquo;t require this, so
Linux users should omit the leading underscores from all such names.  Unfortunately,
I cannot figure out how to link with ld in Linux, so I recommend trying to
understand what <code>gcc -v your_obj_file.o</code> is doing, and
<a href="http://www.lisha.ufsc.br/teaching/os/exercise/hello.html">this might help</a>.
Let me know in the comments if there&rsquo;s an easy way to use ld when linking your
object files from linux and I&rsquo;ll be happy to post an edit.</p>

<p>Let&rsquo;s start with this fragment and get it building, then I&rsquo;ll cover what it&rsquo;s
doing.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='gas'><span class='line'><span class="na">.text</span>
</span><span class='line'><span class="na">.globl</span> <span class="no">_main</span>
</span><span class='line'><span class="nl">_main:</span>
</span><span class='line'>  <span class="nf">subq</span> <span class="no">$8</span><span class="p">,</span> <span class="nv">%rsp</span>
</span><span class='line'>  <span class="nf">movq</span> <span class="no">$0</span><span class="p">,</span> <span class="nv">%rdi</span>
</span><span class='line'>  <span class="nf">call</span> <span class="no">_exit</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s use OSX&rsquo;s built in assembler (as) and linker (ld).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='gas'><span class='line'><span class="nf">as</span> <span class="no">nothing.s</span> <span class="p">-</span><span class="no">o</span> <span class="no">nothing.o</span>
</span><span class='line'><span class="nf">ld</span> <span class="p">-</span><span class="no">lc</span> <span class="p">-</span><span class="no">macosx_version_min</span> <span class="mi">10</span><span class="no">.8.5</span> <span class="no">nothing.o</span> <span class="p">-</span><span class="no">o</span> <span class="no">nothing</span>
</span></code></pre></td></tr></table></div></figure>


<p>We should now be able to run <code>./nothing</code> without any segfaults.  Without
<code>-macosx_version_min 10.8.5</code> I get a warning and my executable segfaults.</p>

<p>Now let&rsquo;s create a basic generic Makefile to help us automate these steps.
Watch your step; archaic syntax ahead.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="nv">SOURCES</span> <span class="o">=</span> <span class="k">$(</span>wildcard *.s<span class="k">)</span>
</span><span class='line'><span class="nv">OBJECTS</span> <span class="o">=</span> <span class="k">$(</span>SOURCES:.s<span class="o">=</span>.o<span class="k">)</span>
</span><span class='line'><span class="nv">EXECUTABLES</span> <span class="o">=</span> <span class="k">$(</span>OBJECTS:.o<span class="o">=</span><span class="k">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Generic rule</span>
</span><span class='line'><span class="c"># $&lt; is the first dependency name</span>
</span><span class='line'><span class="c"># $@ is the target filename</span>
</span><span class='line'><span class="nf">%.o</span><span class="o">:</span> <span class="m">%.s</span>
</span><span class='line'>  as <span class="nv">$&lt;</span> -o <span class="nv">$@</span>
</span><span class='line'>
</span><span class='line'><span class="nf">default</span><span class="o">:</span> <span class="m">$(OBJECTS)</span>
</span><span class='line'>  <span class="k">for </span>exe in <span class="k">$(</span>EXECUTABLES<span class="k">)</span> ; <span class="k">do</span> <span class="se">\</span>
</span><span class='line'>    ld -lc -macosx_version_min 10.8.5 <span class="nv">$$</span>exe.o -o <span class="nv">$$</span>exe ; <span class="se">\</span>
</span><span class='line'>  <span class="k">done</span>
</span><span class='line'>
</span><span class='line'><span class="nf">.PHONY</span><span class="o">:</span> <span class="m">clean</span>
</span><span class='line'><span class="nf">clean</span><span class="o">:</span>
</span><span class='line'>  rm *.o
</span><span class='line'>  <span class="k">for </span>exe in <span class="k">$(</span>EXECUTABLES<span class="k">)</span> ; <span class="k">do</span> <span class="se">\</span>
</span><span class='line'>    rm <span class="nv">$$</span>exe ; <span class="se">\</span>
</span><span class='line'>  <span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>


<p>By the time you read this, I&rsquo;ve already forgotten how half of that code works.
But, this will allow us to run <code>make</code> to assemble and link all of our .s files
individually, and <code>make clean</code> to remove our object and executable files.
Surely you can whip up a better build script?  Let me know in the comments
below.</p>

<p>So now let&rsquo;s go back to our assembly file and go over it line by line.  Again,
it looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='gas'><span class='line'><span class="na">.text</span>
</span><span class='line'><span class="na">.globl</span> <span class="no">_main</span>
</span><span class='line'><span class="nl">_main:</span>
</span><span class='line'>  <span class="nf">subq</span> <span class="no">$8</span><span class="p">,</span> <span class="nv">%rsp</span>
</span><span class='line'>  <span class="nf">movq</span> <span class="no">$0</span><span class="p">,</span> <span class="nv">%rdi</span>
</span><span class='line'>  <span class="nf">call</span> <span class="no">_exit</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>.text</code> is the text section.  This section defines the instructions that the
processor will execute.  There can be other sections as well.  We&rsquo;ll see more
later, but the &ldquo;data&rdquo; section
typically has static variables that have been initialized with non null (and non
zero) values, where as &ldquo;bss&rdquo; will have static but non initialized values.  Also,
there will be a heap and a stack although you don&rsquo;t declare them as you would
for text or data.</p>

<p>Next up is the global directive.  The global directive tells the linker that
there will be a section named _main that it may call into, making the _main
section visible to other sections.  You may be
<a href="http://stackoverflow.com/a/5908708/1027966">wondering</a>
why directives and sections both begin with a dot.</p>

<blockquote><p>&#8217;.&#8221; isn&#8217;t a valid identifier character in C, so way back when it became common to use &#8216;.&#8221; as a prefix in the assembler and linker in order to avoid clashing with C symbol names. This unfortunately was used for both section names and directives, because both can appear in contexts where a simple parser wouldn&#8217;t be able to disambiguate otherwise.</p><p>I don&#8217;t know why they used the same convention for directives and section names, but they did, and it&#8217;s not practical to change it now.</p><footer><strong>Dan Gohman</strong></footer></blockquote>


<p>Ok now the subtraction instruction.  We&rsquo;ve got a bit to go over with just this
one line.  The first is the instruction itself.  The sub instruction has
numerous suffixes that specify how many bytes to operate on.  The typical
convention for numerous instructions is to have a suffix of b for 1 byte
(8 bits), w for a word (2 bytes, 16 bits), l for a long or
double word (4 bytes, 32 bits), and q for a quad word (8 bytes, 64 bits).
Leaving off the suffix, the assembler will try and guess based off of the
operands, which can lead to obscure bugs.  So subq operates on 64 bits.
Extending this we should be able to recognize that subb operates on 8 bits, subw
operates on 16 bits, subl operates on 32 bits, and subq operates on 64 bits.
What&rsquo;s important to understand is that instruction suffix is dictated by the
inputs and destination size.  See Figure 3-3 of the
<a href="http://amd-dev.wpengine.netdna-cdn.com/wordpress/media/2012/10/24592_APM_v11.pdf">AMD64 ABI</a>.</p>

<p>Ok now let&rsquo;s look at the full instruction <code>subq $8, %rsp</code>.  The current order of
the operands is known as the AT&amp;T syntax, where the destination is specified
last
(<a href="http://stackoverflow.com/q/972602/1027966">as opposed to the Intel syntax</a>,
where the destination follows the instruction name ex. <code>subq rsp, 8</code>).</p>

<blockquote><p>I&#8217;m biased towards AT&T-syntax because GCC, LLVM, and icc (at least on Unix-like platforms) all use it, so it&#8217;s what I&#8217;m used to by necessity. People familiar with assembly languages on other platforms sometimes find it feels backwards from what they&#8217;re used to, but it is learnable.</p><footer><strong>Dan Gohman</strong></footer></blockquote>


<p>I&rsquo;m writing my examples in AT&amp;T syntax simply because when I compile my C code
from clang with the -S flag, or run my object files through gobjdump, I get AT&amp;T
syntax by default (though I&rsquo;m sure there are flags for either AT&amp;T or Intel
syntaxes).  Also, the ABI
docs are in AT&amp;T.  What are your thoughts on the two different syntaxes?  Let me
know in the comments below.</p>

<p>So when we say <code>subq $8, %rsp</code>, we&rsquo;re subtracting the immediate value of 8 from
the stack pointer (the register %rsp contains our stack pointer).  But
why are we doing this?  This is something that is left out from some of the
basic hello world assembly programs I&rsquo;ve seen.  This is the first ABI point I
want to make:</p>

<h2>x86-64 ABI point 1: function calls need the stack pointer to be aligned by a multiple of 16 bytes.</h2>

<p>By default, they are off by 8 on function entry.  See
Section 3.2.2 page 16 of the
<a href="http://www.x86-64.org/documentation_folder/abi-0.99.pdf">ABI</a>.</p>

<p>Why is the stack pointer misaligned by 8 bytes on function entry?  I&rsquo;m going to
punt on the answer to that for a bit, but I promise I&rsquo;ll come back to it.  The
most important thing is that that call instruction later on will fail unless we
align our stack pointer, which started out misaligned.  If we comment it out
(pound signs, #, comment out the rest of the line) and make our executable,
we&rsquo;ll get a segfault.  You could even add 8 bytes to the stack pointer and our
basic example would work (we just need a multiple of 16 remember), but when we
learn later (I promise) about how the stack works in x86-64, we&rsquo;ll see we can
mess things up by adding rather than subtracting.</p>

<p>Next up we&rsquo;re moving the immediate value 0x0 into %rdi.  You may have heard that
arguments to functions are pushed on the stack in reverse order, but that&rsquo;s an
old x86 convention.  With the addition of 8 more general purpose registers, we
now pass up to the first 6 arguments in registers (then push the rest, if any,
on the stack in reverse order).  The convention (in OSX and Linux) is our second
ABI point:</p>

<h2>x86-64 ABI point 2: The calling conventions for function invocations require passing integer arguments in the following sequence of registers: %rdi, %rsi, %rdx, %rcx, %r8, %r9, then pushing the rest on the stack in reverse order.</h2>

<p>See <a href="http://www.x86-64.org/documentation_folder/abi-0.99.pdf">section 3.2.3</a>
under &ldquo;Passing&rdquo;.  Warning:
<a href="http://msdn.microsoft.com/en-us/library/ms235286.aspx">Microsoft has a different calling convention</a>.
This is quite troubling to me, because I assumed that Instruction Set
Architectures were created so that the same code could run on two different
machines with the same microarchitecture, but because the ISA does not define
how arguments would be passed, this ambiguity is left up to the OS implementor
to decide.  Thus the same code may not run on two different machines with the
same microarchitecture if their operating systems are incompatible at the ABI
layer.</p>

<p><em>UPDATE</em>: Further, I just learned that <a href="http://nelhagedebugsshit.tumblr.com/post/84342207533/things-i-learned-writing-a-jit-in-go">Go, and C code compiled by 6c don’t use
the &ldquo;normal&rdquo; SysV ABI and calling convention, but have their own.</a></p>

<p>What our goal is is to call <code>exit(0);</code> where exit is defined in libc, which we
link against during the linking phase with with flag <code>-lc</code>.  This is another
punt on system calls.  So to invoke exit with the first integer argument of 0,
we first need to move the immediate value of 0x0 into %rdi.  Now if you run your
executable from your shell, then <code>echo $?</code>, you should see that the previous
command&rsquo;s exit code was 0.  Try changing the exit code to 42 and verify that it
works successfully.</p>

<p>Ok, well a program that does nothing is more boring than hello world.  Now that
we have our build setup out of the way, let&rsquo;s make a hello world program.  If
you&rsquo;re familiar with ASCII tables, we can use putchar from libc since we&rsquo;re
already linking to it.  Use <code>man putchar</code> to look at its signature and
<a href="http://www.asciitable.com/">this ASCII table</a> to move immediate values into a
certain register (remember the
calling convention, point #2) and make sure you setup the stack pointer before
any calls and exit after all other calls.</p>

<p>I&rsquo;ll leave that up to an exercise for the reader.  Let&rsquo;s use a string and
printf.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='gas'><span class='line'><span class="na">.data</span>
</span><span class='line'><span class="nl">_hello:</span>
</span><span class='line'>  <span class="na">.asciz</span> <span class="s">&quot;hello world\n&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="na">.text</span>
</span><span class='line'><span class="na">.globl</span> <span class="no">_main</span>
</span><span class='line'><span class="nl">_main:</span>
</span><span class='line'>  <span class="nf">subq</span> <span class="no">$8</span><span class="p">,</span> <span class="nv">%rsp</span>
</span><span class='line'>
</span><span class='line'>  <span class="nf">movb</span> <span class="no">$0</span><span class="p">,</span> <span class="nv">%al</span>
</span><span class='line'>  <span class="nf">leaq</span> <span class="no">_hello</span><span class="p">(</span><span class="nv">%rip</span><span class="p">),</span> <span class="nv">%rdi</span>
</span><span class='line'>  <span class="nf">call</span> <span class="no">_printf</span>
</span><span class='line'>
</span><span class='line'>  <span class="nf">movq</span> <span class="no">$0</span><span class="p">,</span> <span class="nv">%rdi</span>
</span><span class='line'>  <span class="nf">call</span> <span class="no">_exit</span>
</span></code></pre></td></tr></table></div></figure>


<p>First up is our data section <code>.data</code>.  I previously mentioned the data section
contains global non null and non 0 variables.  You can see here that the string
itself becomes part of the binary by using the unix command <code>strings</code> and
passing your executable as the first argument.  Further, if you pass your
executable to hexdump you can even see the ASCII codes in hex:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='gas'><span class='line'><span class="err">0001020</span> <span class="err">68</span> <span class="err">65</span> <span class="err">6</span><span class="nf">c</span> <span class="mi">6</span><span class="no">c</span> <span class="mi">6</span><span class="no">f</span> <span class="mi">20</span> <span class="mi">77</span> <span class="mi">6</span><span class="no">f</span> <span class="mi">72</span> <span class="mi">6</span><span class="no">c</span> <span class="mi">64</span> <span class="mi">0</span><span class="no">a</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>
</span></code></pre></td></tr></table></div></figure>


<p>Also, we can run our binary through objdump as well and see the string:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='gas'><span class='line'><span class="nf">gobjdump</span> <span class="p">-</span><span class="no">j</span> <span class="no">.data</span> <span class="p">-</span><span class="no">s</span> <span class="no">hello_world</span>
</span><span class='line'><span class="na">...</span>
</span><span class='line'><span class="nf">Contents</span> <span class="no">of</span> <span class="no">section</span> <span class="no">.data</span><span class="p">:</span>
</span><span class='line'> <span class="err">2020</span> <span class="err">68656</span><span class="nf">c6c</span> <span class="mi">6</span><span class="no">f20776f</span> <span class="mi">726</span><span class="no">c640a</span> <span class="mi">00</span>        <span class="no">hello</span> <span class="no">world..</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ok so now we&rsquo;re moving an immediate value of 0x0 to %al.  %al is 1 byte wide, so
we use the b suffix on the mov instruction.  The next important point of the ABI
has to do with functions that use a variable number of arguments (varargs), like
printf does:</p>

<h2>x86-64 ABI point 3: Variadic functions need to have the number of vector arguments specified in %al.</h2>

<p>This will make printf debugging hard without.  Also in
<a href="http://www.x86-64.org/documentation_folder/abi-0.99.pdf">section 3.2.3 under passing</a>.</p>

<p>If you don&rsquo;t know what vector arguments are, no worries!  I&rsquo;m not going to cover
them.  Just know that without this, the contents of %al may work in a basic
example, where we haven&rsquo;t touched %al, %ax, %eax, or %rax yet, but we shouldn&rsquo;t
bank on it being 0x0.  In fact we shouldn&rsquo;t bank on most registers being
preserved after a function call.  Now&rsquo;s a good time to talk about volatility:</p>

<h2>x86-64 ABI point 4: Most registers are not preserved across function calls.</h2>

<p>Only %rbx, %rsp, %rbp, and %r12-%r15 (and some others) are.  These are called
&ldquo;call saved&rdquo; or &ldquo;non volatile&rdquo; registers.  The rest should be considered &ldquo;call
clobbered&rdquo; or &ldquo;volatile.&rdquo;  That means every time we invoke a call like printf,
we need to reset %al, since it is the lower 8 bits of %rax which is the 1st
return register, so it is always clobbered.</p>

<p>The next instruction loads the effective address of the string relative to the
current instruction pointer into %rdi, the first argument for printf.
<a href="https://developer.apple.com/library/mac/documentation/DeveloperTools/Reference/Assembler/040-Assembler_Directives/asm_directives.html">The .asciz directive</a> appends the null byte for us, since C strings are null
terminated.</p>

<p>With this knowledge, can you modify hello world to print &ldquo;hello world 42&rdquo;,
without putting 42 into the string in the data section?  Hint: you&rsquo;ll need a
placeholder in your string and need to know the x86-64 calling convention to
pass an additional argument to printf.</p>

<p>Finally, let&rsquo;s talk about the stack.  When we create automatic variables in C,
they are created in the segment called the stack.  On x86-64 the stack starts
at some arbitrary address (virtual memory backed by physical memory) and &ldquo;grows&rdquo;
downwards.  That is why we subtracted 8 bytes, rather than add 8 bytes to the
stack for alignment earlier.
<a href="http://eli.thegreenplace.net/2011/02/04/where-the-top-of-the-stack-is-on-x86/">The metaphor of a stack of plates is kinda upside-down</a>
as additional plates (variables) are going underneath the current
bottom plate if you can imagine, in this case.  The stack grows towards the
heap, and it is possible for them to collide if you don&rsquo;t ask the OS to expand
your data segment (sbrk).</p>

<p><img class="center" src="/images/stack.png"> <a href="http://mcfunley.com/the-debugger-extension-part-6-scanning-threads">credit</a></p>

<p>Let&rsquo;s say we want to call something like memset, which from <code>man memset</code> we can
see takes an address, a value to fill, and a number of bytes to fill.  The
equivalent of say this C code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;inttypes.h&gt;</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kt">int8_t</span> <span class="n">array</span> <span class="p">[</span><span class="mi">16</span><span class="p">];</span>
</span><span class='line'>  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">array</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
</span><span class='line'>  <span class="kt">int8_t</span><span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">array</span><span class="p">;</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Current byte: %&quot;</span> <span class="n">PRId8</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
</span><span class='line'>  <span class="o">++</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Current byte: %&quot;</span> <span class="n">PRId8</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
</span><span class='line'>  <span class="o">++</span><span class="n">ptr</span><span class="p">;</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Current byte: %&quot;</span> <span class="n">PRId8</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Well, that might look like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='gas'><span class='line'><span class="na">.data</span>
</span><span class='line'><span class="nl">_answer:</span>
</span><span class='line'>  <span class="na">.asciz</span> <span class="s">&quot;Current byte: %d\n&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="na">.text</span>
</span><span class='line'><span class="na">.globl</span> <span class="no">_main</span>
</span><span class='line'><span class="nl">_main:</span>
</span><span class='line'>  <span class="nf">subq</span> <span class="no">$8</span><span class="p">,</span> <span class="nv">%rsp</span>
</span><span class='line'>
</span><span class='line'>  <span class="nf">subq</span> <span class="no">$16</span><span class="p">,</span> <span class="nv">%rsp</span> <span class="c"># allocate 16B</span>
</span><span class='line'>  <span class="nf">leaq</span> <span class="p">(</span><span class="nv">%rsp</span><span class="p">),</span> <span class="nv">%rdi</span> <span class="c"># first arg, &amp;array</span>
</span><span class='line'>  <span class="nf">movq</span> <span class="no">$42</span><span class="p">,</span> <span class="nv">%rsi</span> <span class="c"># second arg, 42</span>
</span><span class='line'>  <span class="nf">movq</span> <span class="no">$16</span><span class="p">,</span> <span class="nv">%rdx</span><span class="p">,</span> <span class="c"># third arg, 16B</span>
</span><span class='line'>  <span class="nf">call</span> <span class="no">_memset</span>
</span><span class='line'>
</span><span class='line'>  <span class="nf">leaq</span> <span class="no">_answer</span><span class="p">(</span><span class="nv">%rip</span><span class="p">),</span> <span class="nv">%rdi</span>
</span><span class='line'>  <span class="nf">movq</span> <span class="no">$0</span><span class="p">,</span> <span class="nv">%rsi</span>
</span><span class='line'>  <span class="nf">movb</span> <span class="p">(</span><span class="nv">%rsp</span><span class="p">),</span> <span class="nv">%sil</span> <span class="c"># these two are equavlent to movzql (%rsp), %esi</span>
</span><span class='line'>  <span class="nf">movb</span> <span class="no">$0</span><span class="p">,</span> <span class="nv">%al</span>
</span><span class='line'>  <span class="nf">call</span> <span class="no">_printf</span>
</span><span class='line'>
</span><span class='line'>  <span class="nf">incq</span> <span class="p">(</span><span class="nv">%rsp</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nf">leaq</span> <span class="no">_answer</span><span class="p">(</span><span class="nv">%rip</span><span class="p">),</span> <span class="nv">%rdi</span>
</span><span class='line'>  <span class="nf">movq</span> <span class="no">$0</span><span class="p">,</span> <span class="nv">%rsi</span>
</span><span class='line'>  <span class="nf">movb</span> <span class="p">(</span><span class="nv">%rsp</span><span class="p">),</span> <span class="nv">%sil</span>
</span><span class='line'>  <span class="nf">movb</span> <span class="no">$0</span><span class="p">,</span> <span class="nv">%al</span>
</span><span class='line'>  <span class="nf">call</span> <span class="no">_printf</span>
</span><span class='line'>
</span><span class='line'>  <span class="nf">leaq</span> <span class="no">_answer</span><span class="p">(</span><span class="nv">%rip</span><span class="p">),</span> <span class="nv">%rdi</span>
</span><span class='line'>  <span class="nf">movq</span> <span class="no">$0</span><span class="p">,</span> <span class="nv">%rsi</span>
</span><span class='line'>  <span class="nf">movb</span> <span class="mi">1</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">),</span> <span class="nv">%sil</span>
</span><span class='line'>  <span class="nf">movb</span> <span class="no">$0</span><span class="p">,</span> <span class="nv">%al</span>
</span><span class='line'>  <span class="nf">call</span> <span class="no">_printf</span>
</span><span class='line'>
</span><span class='line'>  <span class="nf">addq</span> <span class="no">$16</span><span class="p">,</span> <span class="nv">%rsp</span> <span class="c"># clean up stack</span>
</span><span class='line'>
</span><span class='line'>  <span class="nf">movq</span> <span class="no">$0</span><span class="p">,</span> <span class="nv">%rdi</span>
</span><span class='line'>  <span class="nf">call</span> <span class="no">_exit</span>
</span></code></pre></td></tr></table></div></figure>


<p>This isn&rsquo;t a perfect example because I&rsquo;m not allocating space for the ptr on the
stack.  Instead, I&rsquo;m using the %rsp register to keep track of the address I&rsquo;m
working with.</p>

<p>What we&rsquo;re doing is allocating 16B on the stack.  Remember we need to keep %rsp
aligned on 16B boundaries, making it a multiple of 16B.  If we needed a non 16B
multiple, we could allocate more than needed on the stack, and then do some
arithmetic later when access our automatic variables.</p>

<p>For memset, we need to pass the address of our first argument.  In x86-64, the
stack grows downwards, but our variables &ldquo;point&rdquo; upwards, so %rsp and the higher
16B is the memory addresses of our array, with %rsp currently pointing to the
front.  The rest you should recognize by now as part of the calling convention.</p>

<p>In the next grouping of instructions, we want to verify that memset set every
byte to 42 (0x2A).  So what we&rsquo;ll do is copy the first byte from our array,
currently pointed to by %rsp, to the lower 8b of %rsi which is named %sil.  It&rsquo;s
important to zero out the 64b contents of %rsi first, since it may have been
clobbered by our previous call to memset.</p>

<p>Then we dereference and increment the value pointed to by our array pointer,
<code>++(*ptr)</code> or <code>++array[0]</code>.  Now <code>array[0]</code> is <code>43</code>, not <code>42</code>.</p>

<p>In the next grouping of instructions, we print the second byte of our array,
<code>array[1]</code>, and get <code>42</code> from memset.  Now we could try to increment the stack
pointer itself by one, but then the call to printf will fail, so instead when we
load the value of <code>array[1]</code>, we do some pointer arithmetic
<code>movb 1(%rsp), %sil</code>.
This is relative addressing, though you&rsquo;ve already seen this with loading the
strings.  You might wonder why I&rsquo;m not loading the byte in the other
&ldquo;direction,&rdquo; say <code>movb -1(%rsp), %sil</code>.  Well, that goes back to my point that
while the stack pointer moves down as we allocate automatic variables, their
address and memory they take up &ldquo;points up.&rdquo;</p>

<p>Finally, we clean up our automatic variable&rsquo;s allocated space on the stack.
Note that we do not zero out that memory.  A preceding function call might
overwrite that data on the stack, but until it does or unless we explicitly zero
it out, a buffer overrun could accidentally read that data a la Heartbleed.</p>

<p>Now I did promise I would talk about why the stack pointer is misaligned by 8
bytes on function entry.  That is because unoptimized functions typically have a
function prolog and epilog.  Typically, besides creating
room on the stack for automatic variables at the beginning of a function, we
typically want to save the frame AKA base pointer, %rbp, on the stack.  Since
%rbp is 64b or 8B and the push instruction will decrement the stack pointer by
8b, this will align the misaligned stack to a 16B multiple.  So
in function bodies, you&rsquo;ll typically see:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='gas'><span class='line'><span class="nl">my_func:</span>
</span><span class='line'>  <span class="nf">push</span> <span class="nv">%rbp</span>
</span><span class='line'>  <span class="nf">movq</span> <span class="nv">%rsp</span><span class="p">,</span> <span class="nv">%rbp</span>
</span><span class='line'>  <span class="c"># your code here...</span>
</span><span class='line'>  <span class="nf">popq</span> <span class="nv">%rbp</span>
</span><span class='line'>  <span class="nf">ret</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="http://www.yosefk.com/blog/getting-the-call-stack-without-a-frame-pointer.html">This great article</a>
explains that you may want to profile your running
application, or look at the call stack in a debugger, and by having a linked
list of stack frames of the function that invoked yours and it&rsquo;s caller and so
on in a dedicated register makes it trivial to know the call stack at any given
point in runtime.  Since we&rsquo;re always pushing %rbp immediately thereby saving it
on the stack and putting our stack pointer (%rsp) in the base pointer (%rbp)
(later restoring it, %rbp is call saved), we can
keep popping %rbp then moving our stack pointer to that value
to see that quux was called by bar was called by foo
(<code>foo(bar(quux()));</code>).  Now you saw that I was able to write code that clearly
worked without the three additonal instructions in the prolog and epilog, and
indeed that&rsquo;s what happens with <em>optimized</em> code emitted from your compiler.
And since GDB uses something called DWARF (adds symbols to your objects)
anyways, it isn&rsquo;t a huge issue to remove the prolog and epilog.</p>

<p>So, I think I&rsquo;ve shown you enough to get started hand writing assembly.  To
learn more, you should write the higher level C code for what you&rsquo;re trying to
do and then
<a href="http://www.expobrain.net/2013/06/16/disassembly-c-code-for-fun-part-1/">study the emitted assembly</a>
by compiling with the -S flag.  With
clang, you&rsquo;ll probably see a bunch of stack check guards for each frame, but
those just prevent stack buffer overflows.  Try compiling simple conditionals
(jump forwards), then simple loops (jump backwards) without optimizations.
Jumping to sections and calling your own functions should be pretty
easy to figure out.  Hint: don&rsquo;t duplicate section names, but the assembler will
catch this and warn you pretty explicitly.</p>

<p>Don&rsquo;t let people discourage from learning assembly because &ldquo;compilers will
always beat you.&rdquo;  &ldquo;Just use LLVM or libjit or whatever for codegen.&rdquo;  Well,
existing solutions aren&rsquo;t perfect solutions in every scenario.  Someday you
might be tasked with doing codegen because LLVM is not optimal under certain
constraints.  You&rsquo;ll never know if
you can beat them unless you try; those most comfortable are those most
vulnerable.
I&rsquo;m afraid that if enough people are turned away from
learning the lower levels of programming because the higher level is
unquestionably
better, then assembly will ultimately be forgotten and the computer becomes a
black box again.  This is something that troubles me and that I see occurring
around me frequently; a lot of devs new to web
development conflate jquery with JavaScript, and Three.js with WebGL.  If you&rsquo;re
around the Bay Area, I&rsquo;ll be giving a talk at
<a href="http://html5devconf.com/">HTML5DevConf</a>
on May 22 demystifying Raw WebGL.  You should come and check it out.</p>

<p>In summary, remember:</p>

<ul>
<li>The stack pointer needs to be aligned by 16B multiples when calling another function.</li>
<li>Calling convention dictates passing arguments in %rdi, %rsi, %rdx, %rcx, %r8, %r9, then stack.</li>
<li>%al needs the number of vector arguments for variadic functions.</li>
<li>Know which registers are call saved (%rbx, %rsp, %rbp, and %r12-%r15 (and some others)) and call clobbered.</li>
</ul>


<p>Closing thoughts by Dan:</p>

<blockquote><p>To me, machine code doesn&#8217;t feel analogous to this concept of the divine name. I certainly wouldn&#8217;t describe it as &#8220;like a flawless glass; a light of total understanding streamed through it&#8221;. Even if you strip away all the accidental complexity, machine code is still permeated by mundane implementation-oriented concerns. Also, the abstractions which we use to organize and &#8220;understand&#8221; the program are gone; information is lost.</p><p>My imagination of a divine language looks a lot more like an idealized and cleaned-up LISP. It&#8217;d be capable of representing all known means of abstraction and combination (in the SICP sense), it might be thought of as a kind of super-language of which all of our real-world languages are just messy subsets.</p><footer><strong>Dan Gohman</strong></footer></blockquote>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/03/01/write-a-test-case/">Write a Test Case</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-01T13:22:00-08:00" pubdate data-updated="true">Mar 1<span>st</span>, 2014</time>
        
         | <a href="/blog/2014/03/01/write-a-test-case/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Your application just broke, oh no!  It couldn&rsquo;t have been <em>your</em> code, right?</p>

<p>I&rsquo;ve always had trouble spotting mistakes in my own work such as spelling,
grammar, mathematical, or even in programming.  With spelling or grammar,
office applications quickly pick up on my mistakes and underline them for me,
but most of my mistakes come from my own hubris.  I&rsquo;m confident in what I do,
and that gets me in trouble when I make little mistakes.  I&rsquo;m confident that I
solved this problem correctly and didn&rsquo;t make any small mistakes.  As a kid
competing in timed math competitions, I quickly learned that reviewing your
work cost time, so it was important to recognize where common mistakes would
crop up on certain problems and spend slightly extra time the first time
through those problem areas, rather than double checking the work in its
entirety, unless I had the time to spare.  Measure twice, cut once.</p>

<p>The same is true for programming.  Writing test cases is time consuming, and if
time is money, then it could be said that writing tests is costly.  There&rsquo;s
probably a logical fallacy in there.  In general, we hope that the time-cost of
writing test
cases will be recuperated by the time-cost of bugs caught, though it&rsquo;s not easy
to measure the time-cost of averted bugs.  I&rsquo;m all for test cases.  I think
that
<a href="http://sqlite.org/testing.html#coverage">SQLite having 100% branch coverage</a>
is incredible, truly an lofty
achievement.  People get bogged down in arguments over type systems where
testing is more of a must for languages without a compiler to catch certain
bugs.</p>

<p>Ok, so going back to your code, something is wrong.  But we&rsquo;re confident it
couldn&rsquo;t be <em>our</em> code.  Maybe it&rsquo;s one of those open source modules I&rsquo;m using
not being tested enough, or that pesky browser implementation, or this damned
OS.  It couldn&rsquo;t be <em>my</em> code.</p>

<p><strong>Prove it.</strong></p>

<p>I see bug reports all the time where people say your X breaks my Y, but when
asked to provide Y they can&rsquo;t for whatever software licensing reason.  The bug
resolver (person who is enabled to fix said bug in X), doesn&rsquo;t know at this
point whether the bug reporter (developer of Y) did their homework; the bug is
unconfirmed.  Both reporter and resolver are suspicious of each others&#8217; code.
<em>I</em> don&rsquo;t make silly mistakes, right?</p>

<p><img class="center" src="/images/dude.jpg"></p>

<p>So it&rsquo;s up to the resolver to work out a test case.  Being able to reproduce
said issue is the first goal to resolving a bug.  Just like scientific
statements aren&rsquo;t taken as fact until reproducible, so too will this bug be
merely conjecture at this point.  It kills me when the bug resolver closes an
issue because it <em>works for me</em>.  Nothing boils my blood more; I took the time
to try and help you and wasn&rsquo;t rewarded on some level so I feel that I wasted
my time.  But from where you stand the resolver is not correct, so again I
say&hellip;</p>

<p><strong>Prove it.</strong></p>

<p>I think that it&rsquo;s super hard to get meaningful feedback from users.  It&rsquo;s hard
for them to express why they&rsquo;re frustrated.  We as software developers don&rsquo;t
always point them in the right direction.  As users can have wide ranges of
technical capabilities, sometimes we as more technical oriented people have to
do a little hand holding.  For instance, from Firefox, how many hops does it
take to get from the application&rsquo;s menus to their open bug tracker,
<a href="https://bugzilla.mozilla.org/">bugzilla</a>?
Where can I report an issue?  How do I report an issue?
Do I annoy the hell out of the user until they rate my app?
Users might be complaining on Twitter, but that&rsquo;s sure as hell not where
devlopers are looking for bug reports.
Enabling the user to provide feedback could be
viewed as a double edged sword.  Can I make meaningful conclusions from the
torrent of feedback I&rsquo;m now getting?  Did I structure my form in such a way to
ask the right questions?  Should we make our issue tracker public?  Should we
make security issues that could harm users, if more widely understood, public?
Public to fellow employees, even?  What did you expect to happen, and is that
what actually happened?  This rabbit hole goes deep.</p>

<p>The other day, I was writing a patch for a large application that was developed
by someone else and that I still don&rsquo;t fully comprehend in its entirety. My
patch should have worked, why wasn&rsquo;t it working?  Probably something in this
person&rsquo;s code right?  Sure enough, I wrote a simple test case to eliminate
everything but the control variables, and it turns out <em>I was wrong</em>.</p>

<p>It&rsquo;s hard to get users to
do more than the bare minimum to report an issue, even at all, but to prevent
the issue from being ignored or closed because it works for the developer in
their environment, take the time to report it correctly the first time.
As someone who understands technology more than the average person, take the
time to write a cut down test case that
exposes the issue. The developer who looks at the issue will be grateful;
instead of wasting their time with something that may not even be a bug, you&rsquo;ve
just done something that would have to be done anyways if it is indeed a bug.
You might find that a reduced code size shows that it&rsquo;s in
fact not an issue with someone else&rsquo;s code, but in fact a simple mistake you
made somewhere in your monolithic application.  Or it might be exactly the
evidence you need to get someone&rsquo;s attention to fix said problem.  That test
case might even be included in the latest test suite.  Either way, you have now
proved beyond a reasonable doubt that the issue does not lie in your fault.</p>

<p><strong>Write a Test Case for Your Next Bug Report or Issue.</strong></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/3/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/01/18/finding-compiler-bugs-with-c-reduce/">Finding Compiler Bugs With C-Reduce</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/10/24/booting-a-custom-linux-kernel-in-qemu-and-debugging-it-with-gdb/">Booting a Custom Linux Kernel in QEMU and Debugging It With GDB</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/06/02/speeding-up-linux-kernel-builds-with-ccache/">Speeding Up Linux Kernel Builds With Ccache</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/09/05/gcc-vs-llvm-q3-2017-commit-rates-and-active-developer-counts/">GCC vs LLVM Q3 2017: Active Developer Counts</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/05/31/running-clang-tidy-on-the-linux-kernel/">Running Clang-Tidy on the Linux Kernel</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/nickdesaulniers">@nickdesaulniers</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'nickdesaulniers',
            count: 20,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - Nick Desaulniers -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'wangstabill';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>

<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link href=/css/fonts.css rel=stylesheet type=text/css><title>Cross Compiling C/C++ for Android</title><link rel=stylesheet href=/css/hugo-octopress.css><link rel=stylesheet href=https://nickdesaulniers.github.io/css/custom.css><link rel=stylesheet href=/css/fork-awesome.min.css><link href=https://nickdesaulniers.github.io/favicon.ico rel=icon><meta name=description content><meta name=keywords content><meta name=author content="Nick Desaulniers"><meta name=generator content="Hugo 0.109.0"></head><body><header role=banner><hgroup><h1><a href=https://nickdesaulniers.github.io/>Nick Desaulniers</a></h1><h2>The enemy's gate is down</h2></hgroup></header><nav role=navigation><fieldset class=mobile-nav><select onchange="location=this.value"><option value>Navigate…</option><option value=https://nickdesaulniers.github.io/about/>» About</option><option value=https://nickdesaulniers.github.io/blog/archives/>» Archives</option><option value=https://nickdesaulniers.github.io/>» Blog</option><option value=https://nickdesaulniers.github.io/publications/>» Publications</option><option value=https://nickdesaulniers.github.io/talks/>» Talks</option></select></fieldset><ul class=main-navigation><li><a href=https://nickdesaulniers.github.io/about/ title=About rel="noopener noreferrer">About</a></li><li><a href=https://nickdesaulniers.github.io/blog/archives/ title=Archives rel="noopener noreferrer">Archives</a></li><li><a href=https://nickdesaulniers.github.io/ title=Blog>Blog</a></li><li><a href=https://nickdesaulniers.github.io/publications/ title=Publications rel="noopener noreferrer">Publications</a></li><li><a href=https://nickdesaulniers.github.io/talks/ title=Talks rel="noopener noreferrer">Talks</a></li></ul><ul class=subscription><a href=https://nickdesaulniers.github.io/index.xml target=_blank type=application/rss+xml title=RSS rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a></ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer"><fieldset role=search><input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:https://nickdesaulniers.github.io/></fieldset></form></nav><div id=main><div id=content><div><article class=hentry role=article><header><p class=meta>Jul 1, 2016
- 3 minute read
- <a href=https://nickdesaulniers.github.io/blog/2016/07/01/android-cli/#disqus_thread>Comments</a>
- <a class=label href=https://nickdesaulniers.github.io/categories/arm/>ARM </a><a class=label href=https://nickdesaulniers.github.io/categories/android/>Android </a><a class=label href=https://nickdesaulniers.github.io/categories/c/>C </a><a class=label href=https://nickdesaulniers.github.io/categories/c++/>C++ </a><a class=label href=https://nickdesaulniers.github.io/categories/cross-compile/>cross compile</a></p><h1 class=entry-title>Cross Compiling C/C++ for Android</h1></header><div class=entry-content><p>Let’s say you want to build a hello world command line application in C or C++
and run it on your Android phone. How would you go about it? It’s not super
practical; apps visible and distributable to end users must use the framework
(AFAIK), but for folks looking to get into developing on ARM it’s likely they
have an ARM device in their pocket.</p><p>This post is for folks who typically invoke their compiler from the command
line, either explicitly, from build scripts, or other forms of automation.</p><p>At
<a href=https://twitter.com/LostOracle/status/697859368226697218 target=_blank rel=noopener>work</a>,
when working on Android, we typically checkout the entire Android source code
(
<a href=https://twitter.com/LostOracle/status/702569487531249664 target=_blank rel=noopener>which is huge</a>),
use <code>lunch</code> to configure a ton of environmental variables, then use Makefiles
with lots of includes and special vars. We don’t want to spend the time and
disk space checking out the Android source code just to have a working cross
compiler. Luckily, the Android tools team has an excellent utility to grab a
prebuilt cross compiler.</p><p>This assumes you’re building from a Linux host. Android is a distribution of
Linux, which is much easier to target from a Linux host. At home, I’ll usually
develop on my OSX machine, ssh’d into my headless Linux box. (iTerm2 and tmux
both have exclusive features, but I currently prefer iTerm2.)</p><p>The first thing we want to do is fetch the
<a href=https://developer.android.com/ndk/downloads/index.html target=_blank rel=noopener>Android NDK</a>.
Not the SDK, the NDK.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>➜  ~ curl -O <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span><span style=color:#cb4b16></span>  http://dl.google.com/android/repository/android-ndk-r12b-linux-x86_64.zip
</span></span><span style=display:flex><span>➜  ~ unzip android-ndk-r12b-linux-x86_64.zip
</span></span></code></pre></div><p>It would be helpful to install adb and fastboot, too. This might be different
for your distro’s package manager. Better yet may be to just build from
source.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>➜  ~ sudo apt-get install android-tools-adb android-tools-fastboot
</span></span></code></pre></div><p>Now for you Android device that you want to target, you’ll want to know the
ISA. Let’s say I want to target my Nexus 6P, which has an ARMv8-A ISA (the
first 64b ARM ISA).</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>➜  ~ ./android-ndk-r12b/build/tools/make_standalone_toolchain.py --arch arm64 <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span><span style=color:#cb4b16></span>  --install-dir ~/arm
</span></span></code></pre></div><p>This will create a nice standalone bundle in <code>~/arm</code>. It will contain our
cross compiler, linker, headers, libs, and
<a href=https://twitter.com/LostOracle/status/749297676223598592 target=_blank rel=noopener>sysroot (crt.o and friends)</a>.
Most Android devices are ARMv7-A, so you’d use <code>--arch arm</code>. See the other
supported architectures for cross compiling under
<a href=https://developer.android.com/ndk/guides/standalone_toolchain.html#itc target=_blank rel=noopener>table 4</a>.</p><p>You might also want to change your install-dir and possible add it to your
<code>$PATH</code>, or set <code>$CC</code> and <code>$CXX</code>.</p><p>Now we can compile <code>hello_world.c</code>.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>➜  ~ cat hello_world.c
</span></span><span style=display:flex><span><span style=color:#586e75>#include &lt;stdio.h&gt;</span>
</span></span><span style=display:flex><span>int main <span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>  puts<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;hello world&#34;</span><span style=color:#719e07>)</span>;
</span></span><span style=display:flex><span><span style=color:#719e07>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>➜  ~ ~/arm/bin/clang -pie hello_world.c
</span></span><span style=display:flex><span>➜  ~ file a.out
</span></span><span style=display:flex><span>a.out: ELF 64-bit LSB shared object, ARM aarch64, version <span style=color:#2aa198>1</span> <span style=color:#719e07>(</span>SYSV<span style=color:#719e07>)</span>, dynamically
</span></span><span style=display:flex><span>linked, interpreter /system/bin/linker64,
</span></span><span style=display:flex><span>BuildID<span style=color:#719e07>[</span>sha1<span style=color:#719e07>]=</span>ecc46648cf2c873253b3b522c0d14b91cf17c70f, not stripped
</span></span></code></pre></div><p><a href=http://stackoverflow.com/a/30547603 target=_blank rel=noopener>Since Android Lollipop</a>,
Android has required that executables be linked as
position independent (<code>-pie</code>) to help provide
<a href=https://en.wikipedia.org/wiki/Address_space_layout_randomization#Android target=_blank rel=noopener>ASLR</a>.</p><p><code>&lt;install-dir>/bin/</code> also has shell scripts with more full featured names like
<code>aarch64-linux-android-clang</code> if you prefer to have clearer named executables
in your $PATH.</p><p>Connect your phone, enable remote debugging, and accept the prompt for remote
debugging.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>➜  ~ adb push a.out /data/local/tmp/.
</span></span><span style=display:flex><span>➜  ~ adb shell <span style=color:#2aa198>&#34;./data/local/tmp/a.out&#34;</span>
</span></span><span style=display:flex><span>hello world
</span></span></code></pre></div><p>We’ll use this toolchain in a follow post to start writing some ARMv8-A
assembly. Stay tuned.</p></div><footer><p class=meta><span class="byline author vcard">Posted by <span class=fn>Nick Desaulniers</span></span>
<time>Jul 1, 2016</time></span></p><p class=meta><a class="basic-alignment left" href=https://nickdesaulniers.github.io/blog/2016/06/18/mutt-gmail-ubuntu/ title="Setting up mutt with gmail on Ubuntu">Setting up mutt with gmail on Ubuntu</a>
<a class="basic-alignment right" href=https://nickdesaulniers.github.io/blog/2016/08/13/object-files-and-symbols/ title="Object Files and Symbols">Object Files and Symbols</a></p><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//wangstabill.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></div><aside class="sidebar thirds"><section class="first odd"><p></p></section><ul class=sidebar-nav><li class=sidebar-nav-item><a target=_blank rel="noopener noreferrer" href=https://github.com/nickdesaulniers title=https://github.com/nickdesaulniers><i class="fa fa-github fa-3x"></i></a>
<a target=_blank rel="me noopener noreferrer" href=https://fosstodon.org/@llvm title=https://fosstodon.org/@llvm><i class="fa fa-mastodon fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/in/nick-desaulniers-75520334 title=https://www.linkedin.com/in/nick-desaulniers-75520334><i class="fa fa-linkedin fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.youtube.com/channel/UC68vgKSuS1Xjg9wpdvShfSQ title=https://www.youtube.com/channel/UC68vgKSuS1Xjg9wpdvShfSQ><i class="fa fa-youtube fa-3x"></i></a></li></ul><section class=even><h1>Recent Posts</h1><ul id=recent_posts><li class=post><a href=/blog/2023/02/01/forking-is-not-free-the-hidden-costs/>Forking is not free; the hidden costs</a></li><li class=post><a href=/blog/2023/01/27/critical-edge-splitting/>Critical Edge Splitting</a></li><li class=post><a href=/blog/2023/01/20/debugging-wframe-larger-than/>Debugging -Wframe-larger-than=</a></li><li class=post><a href=/blog/2020/04/06/off-by-two/>Off by Two</a></li></ul></section></aside></div></div><footer role=contentinfo><p>Copyright &copy; 2023 Nick Desaulniers - <a href=https://nickdesaulniers.github.io/license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.</p></footer><script>var _gaq=[["_setAccount","UA-36993986-1"],["_trackPageview"]];(function(e,t){var n=e.createElement(t),s=e.getElementsByTagName(t)[0];n.src=("https:"==location.protocol?"//ssl":"//www")+".google-analytics.com/ga.js",s.parentNode.insertBefore(n,s)})(document,"script")</script></body></html>
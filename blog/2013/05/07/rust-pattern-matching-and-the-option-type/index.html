<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link href=/css/fonts.css rel=stylesheet type=text/css><title>Rust: Pattern Matching and the Option Type</title><link rel=stylesheet href=/css/hugo-octopress.css><link rel=stylesheet href=https://nickdesaulniers.github.io/css/custom.css><link rel=stylesheet href=/css/fork-awesome.min.css><link href=https://nickdesaulniers.github.io/favicon.ico rel=icon><meta name=description content><meta name=keywords content><meta name=author content="Nick Desaulniers"><meta name=generator content="Hugo 0.109.0"></head><body><header role=banner><hgroup><h1><a href=https://nickdesaulniers.github.io/>Nick Desaulniers</a></h1><h2>The enemy's gate is down</h2></hgroup></header><nav role=navigation><fieldset class=mobile-nav><select onchange="location=this.value"><option value>Navigate…</option><option value=https://nickdesaulniers.github.io/about/>» About</option><option value=https://nickdesaulniers.github.io/blog/archives/>» Archives</option><option value=https://nickdesaulniers.github.io/>» Blog</option><option value=https://nickdesaulniers.github.io/publications/>» Publications</option><option value=https://nickdesaulniers.github.io/talks/>» Talks</option></select></fieldset><ul class=main-navigation><li><a href=https://nickdesaulniers.github.io/about/ title=About rel="noopener noreferrer">About</a></li><li><a href=https://nickdesaulniers.github.io/blog/archives/ title=Archives rel="noopener noreferrer">Archives</a></li><li><a href=https://nickdesaulniers.github.io/ title=Blog>Blog</a></li><li><a href=https://nickdesaulniers.github.io/publications/ title=Publications rel="noopener noreferrer">Publications</a></li><li><a href=https://nickdesaulniers.github.io/talks/ title=Talks rel="noopener noreferrer">Talks</a></li></ul><ul class=subscription><a href=https://nickdesaulniers.github.io/index.xml target=_blank type=application/rss+xml title=RSS rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a></ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer"><fieldset role=search><input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:https://nickdesaulniers.github.io/></fieldset></form></nav><div id=main><div id=content><div><article class=hentry role=article><header><p class=meta>May 7, 2013
- 11 minute read
- <a href=https://nickdesaulniers.github.io/blog/2013/05/07/rust-pattern-matching-and-the-option-type/#disqus_thread>Comments</a>
- <a class=label href=https://nickdesaulniers.github.io/categories/c++/>C++ </a><a class=label href=https://nickdesaulniers.github.io/categories/rust/>rust </a><a class=label href=https://nickdesaulniers.github.io/categories/null/>null </a><a class=label href=https://nickdesaulniers.github.io/categories/optional/>optional </a><a class=label href=https://nickdesaulniers.github.io/categories/pattern-matching/>pattern matching</a></p><h1 class=entry-title>Rust: Pattern Matching and the Option Type</h1></header><div class=entry-content><p>The other day I was thinking about the function for performing dynamic memory
allocation in the C standard library, malloc. From the manual pages,
<code>If successful, the malloc() function returns a pointer to allocated memory. If there is an error, it returns a NULL pointer and sets errno to ENOMEM.</code> One of the most common errors
when using malloc is not checking for allocation failure. The allocation is not
guaranteed to succeed and trying to use a NULL reference can lead to program
crashes.</p><p>So a common pattern we&rsquo;ll see is:</p><figure class=code><figcaption><span></span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#dc322f>int</span><span style=color:#719e07>*</span> nums <span style=color:#719e07>=</span> (<span style=color:#dc322f>int</span><span style=color:#719e07>*</span>) <span style=color:#268bd2>malloc</span>(<span style=color:#719e07>sizeof</span>(<span style=color:#dc322f>int</span>));
</span></span><span style=display:flex><span><span style=color:#719e07>if</span> (nums <span style=color:#719e07>==</span> <span style=color:#b58900>NULL</span>) {
</span></span><span style=display:flex><span>  <span style=color:#586e75>// handle error
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>} <span style=color:#719e07>else</span> {
</span></span><span style=display:flex><span>  <span style=color:#719e07>*</span>nums <span style=color:#719e07>=</span> <span style=color:#2aa198>7</span>;
</span></span><span style=display:flex><span>  <span style=color:#586e75>// operate on nums
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>  <span style=color:#268bd2>free</span>(nums);
</span></span><span style=display:flex><span>  nums <span style=color:#719e07>=</span> <span style=color:#b58900>NULL</span>;
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div></div></figure><p>Here we allocated space for an integer, cast the <code>void*</code> returned from malloc
to an <code>int*</code>, compared it against the <code>NULL</code> pointer, then freed the allocated
memory and removed the reference.</p><p>One of the big problems with the null pointer has to do with
safely dereferencing it. In C, dereferencing the null pointer is undefined
and usually leads to a segfault and program crash.</p><p>It can be so unsafe to work with null pointers that
C. A. R. Hoare refers to them as his billion-dollar mistake:</p><blockquote><p>I call it my billion-dollar mistake. It was the invention of the null reference in 1965. At that time, I was designing the first comprehensive type system for references in an object oriented language (ALGOL W). My goal was to ensure that all use of references should be absolutely safe, with checking performed automatically by the compiler. But I couldn&rsquo;t resist the temptation to put in a null reference, simply because it was so easy to implement. This has led to innumerable errors, vulnerabilities, and system crashes, which have probably caused a billion dollars of pain and damage in the last forty years.</p><footer><strong>C.A.R. Hoare</strong>
<cite><a href=http://www.infoq.com/presentations/Null-References-The-Billion-Dollar-Mistake-Tony-Hoare title=http://www.infoq.com/presentations/Null-References-The-Billion-Dollar-Mistake-Tony-Hoare rel="noopener noreferrer">Null References: The Billion Dollar Mistake, InfoQ</a></cite></footer></blockquote><p>So how do we represent the value of nothing? With an integer, for example, your
first instinct might be to use 0 to refer to no value. But 0 <em>is</em> a value, so
how do we represent the range of integer values but also whether there is a
value or not?</p><p>Rust, a systems programming language with a focus on safety and concurrency,
does not have the concept of a null pointer. Instead, it has a different
construct to represent the absence of value, a whole other structure called an
<a href=http://static.rust-lang.org/doc/core/option.html target=_blank rel=noopener>Option</a>. It is an
<a href=http://static.rust-lang.org/doc/core/option.html#enum-option target=_blank rel=noopener>enumerated type</a> that can
either be None (no value) or Some(T) (a specialization of type T).</p><p>So what the heck is an option type and how do we use it? The option type is
a polymorphic type (generic type that can be specialized) that encapsulates
either an empty constructor or the constructor of the original data type. Let&rsquo;s
take a trip down the rabbit hole to see how we use one. First, let&rsquo;s look at
some C++ code, and then translate it to Rust.</p><figure class=code><figcaption><span>option.cpp</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;iostream&gt; // cout, endl</span><span style=color:#719e07>
</span></span></span><span style=display:flex><span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;stdlib.h&gt; // rand</span><span style=color:#719e07>
</span></span></span><span style=display:flex><span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;time.h&gt; // time</span><span style=color:#719e07>
</span></span></span><span style=display:flex><span><span style=color:#719e07></span><span style=color:#719e07>using</span> <span style=color:#719e07>namespace</span> std;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75>// If there is a &#39;random error&#39; returns NULL
</span></span></span><span style=display:flex><span><span style=color:#586e75></span><span style=color:#719e07>const</span> <span style=color:#dc322f>int</span><span style=color:#719e07>*</span> <span style=color:#719e07>const</span> <span style=color:#268bd2>may_return_null</span> () {
</span></span><span style=display:flex><span>  srand(time(<span style=color:#b58900>NULL</span>));
</span></span><span style=display:flex><span>  <span style=color:#719e07>return</span> rand() <span style=color:#719e07>%</span> <span style=color:#2aa198>2</span> <span style=color:#719e07>==</span> <span style=color:#2aa198>1</span> <span style=color:#719e07>?</span> <span style=color:#719e07>new</span> <span style=color:#dc322f>int</span>(<span style=color:#2aa198>666</span>) <span style=color:#719e07>:</span> <span style=color:#b58900>NULL</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#dc322f>int</span> <span style=color:#268bd2>main</span> () {
</span></span><span style=display:flex><span>  <span style=color:#586e75>// if else
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>  <span style=color:#719e07>const</span> <span style=color:#dc322f>int</span><span style=color:#719e07>*</span> <span style=color:#719e07>const</span> x <span style=color:#719e07>=</span> may_return_null();
</span></span><span style=display:flex><span>  <span style=color:#719e07>if</span> (x) {
</span></span><span style=display:flex><span>    <span style=color:#586e75>// switch
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#719e07>switch</span> (<span style=color:#719e07>*</span>x) {
</span></span><span style=display:flex><span>      <span style=color:#719e07>case</span> <span style=color:#2aa198>777</span><span style=color:#719e07>:</span> cout <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;Lucky Sevens&#34;</span>        <span style=color:#719e07>&lt;&lt;</span> endl; <span style=color:#719e07>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#719e07>case</span> <span style=color:#2aa198>666</span><span style=color:#719e07>:</span> cout <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;Number of the Beast&#34;</span> <span style=color:#719e07>&lt;&lt;</span> endl; <span style=color:#719e07>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#719e07>case</span> <span style=color:#2aa198>42</span><span style=color:#719e07>:</span> cout  <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;Meaning of Life&#34;</span>     <span style=color:#719e07>&lt;&lt;</span> endl; <span style=color:#719e07>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#719e07>default</span><span style=color:#719e07>:</span> cout  <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;Nothing special&#34;</span>     <span style=color:#719e07>&lt;&lt;</span> endl; <span style=color:#719e07>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  } <span style=color:#719e07>else</span> {
</span></span><span style=display:flex><span>    cout <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;No value&#34;</span> <span style=color:#719e07>&lt;&lt;</span> endl;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#586e75>// single if
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>  <span style=color:#719e07>if</span> (<span style=color:#719e07>*</span>x <span style=color:#719e07>==</span> <span style=color:#2aa198>666</span>) {
</span></span><span style=display:flex><span>    cout <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;Did I mention that Iron Maiden is my favorite band?&#34;</span> <span style=color:#719e07>&lt;&lt;</span> endl;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div></div></figure><p>Let&rsquo;s step through this program line by line, starting in main.</p><figure class=code><figcaption><span>Line 14</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#719e07>const</span> <span style=color:#dc322f>int</span><span style=color:#719e07>*</span> <span style=color:#719e07>const</span> x <span style=color:#719e07>=</span> may_return_null();</span></span></code></pre></td></tr></table></div></div></div></figure><p>Here we&rsquo;re calling a function that may return null, just like malloc!</p><figure class=code><figcaption><span>Lines 8-9</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>srand(time(<span style=color:#b58900>NULL</span>));
</span></span><span style=display:flex><span><span style=color:#719e07>return</span> <span style=color:#268bd2>rand</span>() <span style=color:#719e07>%</span> <span style=color:#2aa198>2</span> <span style=color:#719e07>==</span> <span style=color:#2aa198>1</span> <span style=color:#719e07>?</span> <span style=color:#719e07>new</span> <span style=color:#dc322f>int</span>(<span style=color:#2aa198>666</span>) <span style=color:#719e07>:</span> <span style=color:#b58900>NULL</span>;</span></span></code></pre></td></tr></table></div></div></div></figure><p>In the body of <code>may_return_null</code> we seed the random number generator, generate a random number, mod it by 2
(so it can either be 0 or 1, 50-50 chance, hopefully), then either return a
pointer pointing to memory allocated on the heap or the null pointer. We also use the succinct
ternary operator, which gives us the power of a conditional statement in the
form of a concise expression.</p><figure class=code><figcaption><span>Line 15</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#719e07>if</span> (x) {</span></span></code></pre></td></tr></table></div></div></div></figure><p>We check if the pointer is valid, that is that it is safe to use, as <code>NULL</code> is
falsy in a C++ conditional. If it is, then we can safely dereference it. Let&rsquo;s
switch on the (dereferenced) value. Notice how we need to break to explicitly
prevent fall through, though
<a href="http://books.google.com/books?id=4vm2xK3yn34C&pg=PA37&lpg=PA38&dq=expert+c+fallthrough&source=bl&ots=Ho98ZhXF9X&sig=PebysT8-3zA_9B2aRkuvnz4mCmY&hl=en&sa=X&ei=j8CJUdeWMerJiwLQmICoDw&ved=0CC4Q6AEwAA#v=onepage&q=expert%20c%20fallthrough&f=false" target=_blank rel=noopener>97% of the time that&rsquo;s what you intend</a>.</p><figure class=code><figcaption><span>Lines 17-22</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#719e07>switch</span> (<span style=color:#719e07>*</span>x) {
</span></span><span style=display:flex><span>  <span style=color:#719e07>case</span> <span style=color:#2aa198>777</span><span style=color:#719e07>:</span> cout <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;Lucky Sevens&#34;</span>        <span style=color:#719e07>&lt;&lt;</span> endl; <span style=color:#719e07>break</span>;
</span></span><span style=display:flex><span>  <span style=color:#719e07>case</span> <span style=color:#2aa198>666</span><span style=color:#719e07>:</span> cout <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;Number of the Beast&#34;</span> <span style=color:#719e07>&lt;&lt;</span> endl; <span style=color:#719e07>break</span>;
</span></span><span style=display:flex><span>  <span style=color:#719e07>case</span> <span style=color:#2aa198>42</span><span style=color:#719e07>:</span> cout  <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;Meaning of Life&#34;</span>     <span style=color:#719e07>&lt;&lt;</span> endl; <span style=color:#719e07>break</span>;
</span></span><span style=display:flex><span>  <span style=color:#719e07>default</span><span style=color:#719e07>:</span> cout  <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;Nothing special&#34;</span>     <span style=color:#719e07>&lt;&lt;</span> endl; <span style=color:#719e07>break</span>;
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div></div></figure><p>If the pointer was null, the else branch of the conditional would execute
printing a different result.</p><figure class=code><figcaption><span>Line 24</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>cout <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;No value&#34;</span> <span style=color:#719e07>&lt;&lt;</span> endl;</span></span></code></pre></td></tr></table></div></div></div></figure><p>Finally in we check the value pointed to. Did I forget something here? Save
that thought, we&rsquo;ll come back to it.</p><figure class=code><figcaption><span>Lines 28-30</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#719e07>if</span> (<span style=color:#719e07>*</span>x <span style=color:#719e07>==</span> <span style=color:#2aa198>666</span>) {
</span></span><span style=display:flex><span>  cout <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;Did I mention that Iron Maiden is my favorite band?&#34;</span> <span style=color:#719e07>&lt;&lt;</span> endl;
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div></div></figure><p>Let&rsquo;s see my rough translation of this program into Rust.</p><figure class=code><figcaption><span>option.rs</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#719e07>use</span> core::rand;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#719e07>fn</span> <span style=color:#268bd2>may_return_none</span> () -&gt; <span style=color:#b58900>Option</span><span style=color:#719e07>&lt;</span>int<span style=color:#719e07>&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#719e07>if</span> rand::Rng().next() <span style=color:#719e07>%</span> <span style=color:#2aa198>2</span> <span style=color:#719e07>==</span> <span style=color:#2aa198>1</span> { <span style=color:#b58900>Some</span>(<span style=color:#2aa198>666</span>) } <span style=color:#719e07>else</span> { <span style=color:#b58900>None</span> }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#719e07>fn</span> <span style=color:#268bd2>main</span> () {
</span></span><span style=display:flex><span>  <span style=color:#268bd2>let</span> x: <span style=color:#b58900>Option</span><span style=color:#719e07>&lt;</span>int<span style=color:#719e07>&gt;</span> <span style=color:#719e07>=</span> may_return_none();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  io::println(<span style=color:#719e07>match</span> x {
</span></span><span style=display:flex><span>    <span style=color:#b58900>Some</span>(<span style=color:#2aa198>777</span>) <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#34;Lucky Sevens&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#b58900>Some</span>(<span style=color:#2aa198>666</span>) <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#34;Number of the Beast&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#b58900>Some</span>(<span style=color:#2aa198>422</span>) <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#34;Meaning of Life&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#b58900>Some</span>(_) <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#34;Nothing special&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#b58900>None</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#34;No value&#34;</span>
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#719e07>match</span> x {
</span></span><span style=display:flex><span>    <span style=color:#b58900>Some</span>(<span style=color:#2aa198>666</span>) <span style=color:#719e07>=&gt;</span> {
</span></span><span style=display:flex><span>      io::println(<span style=color:#2aa198>&#34;Did I mention that Iron Maiden is my favorite Band?&#34;</span>)
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    _ <span style=color:#719e07>=&gt;</span> {}
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div></div></figure><p>Both programs, when compiled <em>should</em> randomly print either:</p><pre tabindex=0><code>No Value
// or
Number of the Beast
Did I mention that Iron Maiden is my favorite Band?
</code></pre><p>Now let&rsquo;s walk through the Rust code, starting at main and compare it to the
equivalent C++ code.</p><p><figure class=code><figcaption><span>option.rs Line 8</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#268bd2>let</span> x: <span style=color:#b58900>Option</span><span style=color:#719e07>&lt;</span>int<span style=color:#719e07>&gt;</span> <span style=color:#719e07>=</span> may_return_none();</span></span></code></pre></td></tr></table></div></div></div></figure><figure class=code><figcaption><span>option.cpp Line 14</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#719e07>const</span> <span style=color:#dc322f>int</span><span style=color:#719e07>*</span> <span style=color:#719e07>const</span> x <span style=color:#719e07>=</span> may_return_null();</span></span></code></pre></td></tr></table></div></div></div></figure></p><p>I read this Rust code as &rsquo;let x be type Option,
specialized to type int initialized
to the return value of may_return_none.&rsquo; I read the C++ as &lsquo;x is a const pointer
to a const integer initialized to the return value of may_return_none.&rsquo; It&rsquo;s
important to note that values and pointers in Rust default to being immutable,
where as in c++ they default to being mutable, which is why we need to be
explicit about their const&rsquo;ness. In Rust, we could declare x as being explicitly
mutable: <code>let mut x: ... = ...;</code>. In both, we can also leave the explicit types
to be inferred by the compiler.</p><p><figure class=code><figcaption><span>option.rs Line 4</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#719e07>if</span> rand::Rng().next() <span style=color:#719e07>%</span> <span style=color:#2aa198>2</span> <span style=color:#719e07>==</span> <span style=color:#2aa198>1</span> { <span style=color:#b58900>Some</span>(<span style=color:#2aa198>666</span>) } <span style=color:#719e07>else</span> { <span style=color:#b58900>None</span> }</span></span></code></pre></td></tr></table></div></div></div></figure><figure class=code><figcaption><span>option.cpp Lines 8-9</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>srand(time(<span style=color:#b58900>NULL</span>));
</span></span><span style=display:flex><span><span style=color:#719e07>return</span> <span style=color:#268bd2>rand</span>() <span style=color:#719e07>%</span> <span style=color:#2aa198>2</span> <span style=color:#719e07>==</span> <span style=color:#2aa198>1</span> <span style=color:#719e07>?</span> <span style=color:#719e07>new</span> <span style=color:#dc322f>int</span>(<span style=color:#2aa198>666</span>) <span style=color:#719e07>:</span> <span style=color:#b58900>NULL</span>;</span></span></code></pre></td></tr></table></div></div></div></figure></p><p>Now for the body of <code>may_return_none</code>. Rust does not have a ternary operator,
so a single line <code>if {} else {}</code> block will have to do. We also don&rsquo;t need
parentheses around the predicate in the conditional statement. If we add them,
no harm is done, as we&rsquo;d just be being redundant about order of operations.
There
are no semicolons in this expression, nor a return statement in this function.
Rust will return the last expression in a function or method if the semicolon is
left off. Also there is no such thing as a conditional statement, only
conditional expressions; the if is itself something that can be evaluated and
assigned to a variable! We see this later in the code where we pass the evaluation
of a match expression directly into a call of <code>io::println</code>.
Rust returns the evaluation of the if expression,
which is the evaluation of the branch&rsquo;s block specified by the predicate,
which will randomly be one of the two enumerated types of <code>Option&lt;int></code>, either
an encapsulation of a int whose literal value is <code>666</code>, <code>Some&lt;666></code>, or
the representation of no value, <code>None</code>. I believe the RNG code has changed in 0.7,
this code was written in 0.6.</p><p>In Rust, to get the value out of an option type, we pattern match on it. Pattern
matching is something I became familiar with through the
<a href=http://learnyouahaskell.com/syntax-in-functions#pattern-matching target=_blank rel=noopener>Haskell</a> programming language. Pattern
matching is a powerful language construct that can entirely replace conditionals.
In fact, the one line if expression could have been written using a match
expression:</p><figure class=code><figcaption><span></span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#719e07>if</span> rand::Rng().next() <span style=color:#719e07>%</span> <span style=color:#2aa198>2</span> <span style=color:#719e07>==</span> <span style=color:#2aa198>1</span> { <span style=color:#b58900>Some</span>(<span style=color:#2aa198>666</span>) } <span style=color:#719e07>else</span> { <span style=color:#b58900>None</span> }
</span></span><span style=display:flex><span><span style=color:#586e75>// or
</span></span></span><span style=display:flex><span><span style=color:#586e75></span><span style=color:#719e07>match</span> rand::Rng().next() <span style=color:#719e07>%</span> <span style=color:#2aa198>2</span> { <span style=color:#2aa198>1</span> <span style=color:#719e07>=&gt;</span> <span style=color:#b58900>Some</span>(<span style=color:#2aa198>666</span>), _ <span style=color:#719e07>=&gt;</span> <span style=color:#b58900>None</span> }</span></span></code></pre></td></tr></table></div></div></div></figure><p>The basic design pattern
for accessing the value of an option type in Rust looks like:</p><figure class=code><figcaption><span></span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#719e07>match</span> x { <span style=color:#586e75>// x: Option&lt;T&gt;
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>  <span style=color:#b58900>Some</span>(y) <span style=color:#719e07>=&gt;</span> { <span style=color:#719e07>*</span>y },
</span></span><span style=display:flex><span>  <span style=color:#b58900>None</span> <span style=color:#719e07>=&gt;</span> {}
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div></div></figure><p>The curly braces are optional for one liners (no block needed).
Pattern matches have to be exhaustive. That means I have to exhaust all
possibilities for what the deconstructed value could be. You can use a branch
that looks like:</p><figure class=code><figcaption><span></span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>_ <span style=color:#719e07>=&gt;</span> <span style=color:#719e07>&#39;</span>everything <span style=color:#719e07>else</span><span style=color:#719e07>&#39;</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>to catch everything else. The underscore here means &ldquo;every other possible case.&rdquo;
So by having to use a match expression (also not a
statement, as opposed to C++&rsquo;s switch statement), which itself must be exhaustive,
Rust forces us to handle the case where the optional type is None! This will
help us again in the future.
We also don&rsquo;t need parentheses around the predicate for the match expression, which
in this case is just a single variable, <code>x</code>.</p><p>In the value
<code>Some(_)</code>, the underscore has an additional meaning here that we would not use a
variable in the corresponding arm&rsquo;s block. If we declared it as <code>Some(y)</code> we would get the warning:</p><pre tabindex=0><code>option.rs:14:9: 14:11 warning: unused variable: `y`
option.rs:14     Some(y) =&gt; &#34;Nothing special&#34;,
                      ^~
</code></pre><p>I hope back in my C++ code you spotted the fatal flaw. On line 28, I just
dereferenced a raw pointer without checking its validity. This is a violation
of memory safety.</p><figure class=code><figcaption><span>option.cpp Line 28</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#719e07>if</span> (<span style=color:#719e07>*</span>x <span style=color:#719e07>==</span> <span style=color:#2aa198>666</span>) {</span></span></code></pre></td></tr></table></div></div></div></figure><p>When running the C++ code, instead of seeing <code>No value</code> printed to stdout in the
case of no value, a segfault occurs.</p><pre tabindex=0><code>No value
[1]    80265 segmentation fault  ./option
</code></pre><p>What I should have done is something more like:</p><figure class=code><figcaption><span>option.cpp Line 28 corrected</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#719e07>if</span> (x <span style=color:#719e07>&amp;&amp;</span> <span style=color:#719e07>*</span>x <span style=color:#719e07>==</span> <span style=color:#2aa198>666</span>) {</span></span></code></pre></td></tr></table></div></div></div></figure><p>But, the C++ compiler let me get away with not handling the case where the
pointer was invalid (even if doing nothing in the case of &ldquo;handling&rdquo; it). By
leaving out the check for a valid pointer, I have instructed the machine to
behave the same or follow the same code path with and without a reference to a
valid memory location. Let&rsquo;s see what happens when I don&rsquo;t handle the None case
by deleting line 15 or option.rs, <code>None => "No value"</code>:</p><pre tabindex=0><code>option.rs:10:14: 16:3 error: non-exhaustive patterns: None not covered
option.rs:10   io::println(match x {
option.rs:11     Some(777) =&gt; &#34;Lucky Sevens&#34;,
option.rs:12     Some(666) =&gt; &#34;Number of the Beast&#34;,
option.rs:13     Some(42) =&gt; &#34;Meaning of Life&#34;,
option.rs:14     Some(_) =&gt; &#34;Nothing special&#34;
</code></pre><p>Not only did the compiler prevent me from generating an executable, it told me
that a pattern was not exhaustive, explicitly which one, and what case that was
not covered.</p><p>Coming back to encoding a lack of value for an int, we had left off that 0 <em>is</em>
a valid value. For instance, how should we represent any other integer divided
by 0, as an integer?
Signed integers use a single bit to store whether
their value is positive or negative, the tradeoff being the signed integers
represent up to one less power of two than unsigned integers. Maybe we could use an
additional bit to represent valid or invalid, but this would again cost us in
terms of representable values.
The IEEE 754 floating point representation has encodings for
<a href=https://en.wikipedia.org/wiki/IEEE_floating_point#Formats target=_blank rel=noopener>plus and minus
Infinity, plus and minus 0, and two kinds of NaN</a>.
To solve the validity problem, we can use enumerated types, which in Rust occur
as specializations of the Option type. It&rsquo;s up to the compiler to implement
either additional information for the type, or use raw null pointers. And to
get the value back out of the Option type, we <em>must</em> handle the case where there
is no valid value.</p><p>The key takeaways that I wish to convey are:</p><ol><li>In C and C++, I can use NULL to refer to a pointer that has no value.</li><li>A C/C++ compiler, such as clang, will allow me to compile code that violates
memory safety, such as dereferencing NULL pointers.</li><li>Rust instead uses Option types, an enumeration of a specialized type or None.</li><li>Rust forces me to use a match statement to access the possible value of an
Option type.</li><li>Pattern matching in Rust must be exhaustive.</li><li>The Rust compiler, rustc, forces me to handle the case where the pointer has
no value, whereas the C++ compiler, clang++, did not.</li><li>All conditional and switch statements can be replaced with pattern matching.</li></ol></div><footer><p class=meta><span class="byline author vcard">Posted by <span class=fn>Nick Desaulniers</span></span>
<time>May 7, 2013</time></span></p><p class=meta><a class="basic-alignment left" href=https://nickdesaulniers.github.io/blog/2013/04/29/the-persistence-of-memory/ title="The Persistence of Memory">The Persistence of Memory</a>
<a class="basic-alignment right" href=https://nickdesaulniers.github.io/blog/2013/06/13/8-months-in-mozilla/ title="8 Months in Mozilla">8 Months in Mozilla</a></p><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//wangstabill.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></div><aside class="sidebar thirds"><section class="first odd"><p></p></section><ul class=sidebar-nav><li class=sidebar-nav-item><a target=_blank rel="noopener noreferrer" href=https://github.com/nickdesaulniers title=https://github.com/nickdesaulniers><i class="fa fa-github fa-3x"></i></a>
<a target=_blank rel="me noopener noreferrer" href=https://fosstodon.org/@llvm title=https://fosstodon.org/@llvm><i class="fa fa-mastodon fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/in/nick-desaulniers-75520334 title=https://www.linkedin.com/in/nick-desaulniers-75520334><i class="fa fa-linkedin fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.youtube.com/channel/UC68vgKSuS1Xjg9wpdvShfSQ title=https://www.youtube.com/channel/UC68vgKSuS1Xjg9wpdvShfSQ><i class="fa fa-youtube fa-3x"></i></a></li></ul><section class=even><h1>Recent Posts</h1><ul id=recent_posts><li class=post><a href=/blog/2023/03/10/usps-as-an-isp/>USPS as an ISP</a></li><li class=post><a href=/blog/2023/03/10/disambiguating-arm/>Disambiguating Arm, Arm ARM, Armv9, ARM9, ARM64, AArch64, A64, A78, ...</a></li><li class=post><a href=/blog/2023/02/01/forking-is-not-free-the-hidden-costs/>Forking is not free; the hidden costs</a></li><li class=post><a href=/blog/2023/01/27/critical-edge-splitting/>Critical Edge Splitting</a></li></ul></section></aside></div></div><footer role=contentinfo><p>Copyright &copy; 2023 Nick Desaulniers - <a href=https://nickdesaulniers.github.io/license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.</p></footer><script>var _gaq=[["_setAccount","UA-36993986-1"],["_trackPageview"]];(function(e,t){var n=e.createElement(t),s=e.getElementsByTagName(t)[0];n.src=("https:"==location.protocol?"//ssl":"//www")+".google-analytics.com/ga.js",s.parentNode.insertBefore(n,s)})(document,"script")</script></body></html>